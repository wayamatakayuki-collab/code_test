<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å¤·éš…æ•™è‚²ä¼šé¤¨ ç®¡ç†ï¼ˆéƒ¨å±‹äºˆç´„ãƒ»æ©Ÿæãƒ»å…¥å£ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼‰</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

  <style>
body { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }

    @media print {
      @page { size: A4 landscape; margin: 10mm; }
      body { background: #fff !important; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      .print-card { break-inside: avoid; page-break-inside: avoid; }
      .print-tight { font-size: 11px; }
    }
    .print-only { display: none; }
    .break-avoid { break-inside: avoid; page-break-inside: avoid; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div id="boot" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:9999;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;">
    <div style="max-width:720px;padding:24px;">
      <div style="font-weight:800;font-size:18px;margin-bottom:8px;">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div id="bootMsg" style="color:#334155;font-size:14px;line-height:1.6;">å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚</div>
      <pre id="bootErr" style="display:none;margin-top:12px;white-space:pre-wrap;background:#0f172a;color:#e2e8f0;padding:12px;border-radius:12px;overflow:auto;max-height:45vh;"></pre>
      <div style="margin-top:10px;color:#64748b;font-size:12px;">â€»ã“ã“ã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆã€ãã®å†…å®¹ã‚’ãã®ã¾ã¾é€ã£ã¦ãã ã•ã„ã€‚</div>
    </div>
  </div>
  <div id="app"></div>

  <script>

  (function(){
    const boot = document.getElementById("boot");
    const msg = document.getElementById("bootMsg");
    const errBox = document.getElementById("bootErr");
    const setMsg = (t)=>{ try{ msg.textContent = t; }catch(e){} };
    const showErr = (e)=>{
      try{
        errBox.style.display = "block";
        errBox.textContent = String(e && (e.stack || e.message) || e);
        setMsg("èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¸‹ã®ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      }catch(_){ }
    };
    window.addEventListener("error", (ev)=>{ showErr(ev.error || ev.message); });
    window.addEventListener("unhandledrejection", (ev)=>{ showErr(ev.reason); });

    function loadScript(url){
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.crossOrigin = "anonymous";
        s.onload = ()=>resolve(url);
        s.onerror = ()=>reject(new Error("Failed to load: " + url));
        document.head.appendChild(s);
      });
    }

    async function loadWithFallback(name, primary, fallback){
      setMsg(name + " ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦");
      try{
        return await loadScript(primary);
      }catch(e1){
        try{
          return await loadScript(fallback);
        }catch(e2){
          throw new Error(name + " ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + e1.message + "\n" + e2.message);
        }
      }
    }

    async function bootApp(){
      try{
        await loadWithFallback("React", "https://unpkg.com/react@18/umd/react.production.min.js", "https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js");
        await loadWithFallback("ReactDOM", "https://unpkg.com/react-dom@18/umd/react-dom.production.min.js", "https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js");
        await loadWithFallback("Babel", "https://unpkg.com/@babel/standalone/babel.min.js", "https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js");

        if(!window.React || !window.ReactDOM || !window.Babel){
          throw new Error("å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆReact/ReactDOM/Babelï¼‰ã€‚");
        }

        setMsg("ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ã„ã¾ã™â€¦");
        const src = document.getElementById("appCode").textContent;
        const transformed = window.Babel.transform(src, { presets: ["react"] }).code;
        (new Function(transformed))();
        // Hide boot overlay
        boot.style.display = "none";
      }catch(e){
        showErr(e);
      }
    }

    bootApp();
  })();

  </script>

  <script id="appCode" type="text/plain">
const { useEffect, useMemo, useRef, useState } = React;

    /**********************
     * å›ºå®šè¨­å®š
     **********************/
    const SHARED_LOGIN_CODE = "ismkaikan";
    const SHARED_EMAIL = `${SHARED_LOGIN_CODE}@shared.local`;
    const CACHE_PREFIX = "ismkaikan_cache_v4";
    const OPS_KEY = "ismkaikan_ops_v1";

    /**********************
     * Firebase åˆæœŸåŒ–ï¼ˆæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šã‚’è¸è¥²ï¼‰
     **********************/
    const firebaseConfig = {
      apiKey: "AIzaSyAfO6ZAOlAZg-yG8ja3fR3U-zEnqMwmpw8",
      authDomain: "ism2711-49523.firebaseapp.com",
      projectId: "ism2711-49523",
      storageBucket: "ism2711-49523.firebasestorage.app",
      messagingSenderId: "44334771941",
      appId: "1:44334771941:web:a55badc93b3f6bdf59ee0c",
      measurementId: "G-M4SWCYYH82"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

    /**********************
     * æ—¢å®šï¼ˆåˆæœŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
     * â€»Firestoreã« rooms / equipments ãŒã‚ã‚‹å‰æã ãŒã€ç©ºã®ã¨ãã®ä¿é™º
     **********************/
    const DEFAULT_ROOMS = [
      { id: "honkan_oo", name: "å¤§ä¼šè­°å®¤", building: "æœ¬é¤¨", active: true, order: 10 },
      { id: "honkan_chu", name: "ä¸­ä¼šè­°å®¤", building: "æœ¬é¤¨", active: true, order: 20 },
      { id: "honkan_sho", name: "å°ä¼šè­°å®¤", building: "æœ¬é¤¨", active: true, order: 30 },
      { id: "honkan_ousetsu", name: "å¿œæ¥å®¤", building: "æœ¬é¤¨", active: true, order: 40 },
      { id: "honkan_nihon", name: "æ—¥æœ¬é–“", building: "æœ¬é¤¨", active: true, order: 50 },
      { id: "honkan_print", name: "å°åˆ·å®¤", building: "æœ¬é¤¨", active: true, order: 60 },
      { id: "honkan_library", name: "å›³æ›¸å®¤", building: "æœ¬é¤¨", active: true, order: 70 },
      { id: "honkan_lab", name: "ç ”ç©¶æ‰€", building: "æœ¬é¤¨", active: true, order: 80 },
      { id: "bekkan_1f", name: "ï¼‘éšä¼šè­°å®¤", building: "åˆ¥é¤¨", active: true, order: 110 },
      { id: "bekkan_2f", name: "ï¼’éšä¼šè­°å®¤", building: "åˆ¥é¤¨", active: true, order: 120 },
    ];

    const DEFAULT_EQUIPMENTS = [
      { id: "projector", name: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼", abbr: "PJ", countTotal: 3, active: true, order: 10 },
      { id: "pc", name: "PC", abbr: "PC", countTotal: 10, active: true, order: 20 },
    ];

    /**********************
     * utils
     **********************/
    const pad2 = (n) => String(n).padStart(2, "0");
    const monthKeyLocal = (d = new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    const todayKeyLocal = (d = new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const parseKeyToDate = (key) => {
      const [y,m,d] = key.split("-").map(Number);
      return new Date(y, m-1, d);
    };
    const addDaysKey = (key, add) => {
      const dt = parseKeyToDate(key);
      dt.setDate(dt.getDate()+add);
      return todayKeyLocal(dt);
    };
    const startOfWeekMonday = (key) => {
      const dt = parseKeyToDate(key);
      const dow = dt.getDay();
      const diff = (dow === 0) ? -6 : (1 - dow);
      dt.setDate(dt.getDate()+diff);
      return todayKeyLocal(dt);
    };
    const hhmmToMin = (hhmm) => {
      const [h,m] = hhmm.split(":").map(Number);
      return h*60+m;
    };
    const minToHHMM = (min) => `${pad2(Math.floor(min/60))}:${pad2(min%60)}`;
    const overlaps = (aS,aE,bS,bE) => (aS < bE) && (bS < aE);
    const isValidDateKey = (k) => /^\d{4}-\d{2}-\d{2}$/.test(k);

    // --- month helpers
    const monthKeyFromDateKey = (k) => String(k || "").slice(0,7);
    const dateKeyFromParts = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`;
    const startOfMonthKey = (monthKey) => `${monthKey}-01`;
    const endOfMonthKey = (monthKey) => {
      const parts = String(monthKey || "").split("-");
      const y = Number(parts[0]);
      const m = Number(parts[1]);
      if(!Number.isFinite(y) || !Number.isFinite(m)) return `${monthKey}-28`;
      const last = new Date(y, m, 0).getDate();
      return dateKeyFromParts(y, m, last);
    };
    const addMonthsKey = (monthKey, add) => {
      const parts = String(monthKey || "").split("-");
      const y0 = Number(parts[0]);
      const m0 = Number(parts[1]);
      const dt = new Date(Number.isFinite(y0) ? y0 : new Date().getFullYear(), (Number.isFinite(m0)?m0:1)-1, 1);
      dt.setMonth(dt.getMonth() + Number(add||0));
      return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}`;
    };

    // --- loose parsers (for import)
    const parseDateLooseToKey = (raw) => {
      const s = String(raw ?? "").trim();
      if(!s) return null;
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      if(/^\d{8}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
      const m = s.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})$/);
      if(m){
        const y = Number(m[1]);
        const mo = Number(m[2]);
        const d = Number(m[3]);
        if(!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(d)) return null;
        if(mo<1||mo>12||d<1||d>31) return null;
        return `${y}-${pad2(mo)}-${pad2(d)}`;
      }
      return null;
    };

    const parseHHMMLoose = (raw) => {
      const s = String(raw ?? "").trim();
      if(!s) return null;
      const m = s.match(/^(\d{1,2})(?::(\d{1,2}))?$/);
      if(m){
        const h = Number(m[1]);
        const mm = m[2] == null ? 0 : Number(m[2]);
        if(h<0||h>23||mm<0||mm>59) return null;
        return h*60+mm;
      }
      if(/^\d{3,4}$/.test(s)){
        const n = Number(s);
        const h = Math.floor(n/100);
        const mm = n%100;
        if(h<0||h>23||mm<0||mm>59) return null;
        return h*60+mm;
      }
      return null;
    };

    // --- monitor settings
    const MONITOR_SETTINGS_KEY = "ismkaikan_monitor_settings_v1";
    const MONITOR_VIEW_KEY = "ismkaikan_monitor_view_v1";
    const DEFAULT_MONITOR_SETTINGS = { startHHMM:"08:00", endHHMM:"20:00", autoPage:true, intervalSec:12, roomsPerPage:"auto" };

    function loadMonitorSettings(){
      try{
        const raw = localStorage.getItem(MONITOR_SETTINGS_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj) return null;
        return {
          startHHMM: String(obj.startHHMM || DEFAULT_MONITOR_SETTINGS.startHHMM),
          endHHMM: String(obj.endHHMM || DEFAULT_MONITOR_SETTINGS.endHHMM),
          autoPage: obj.autoPage !== false,
          intervalSec: Number(obj.intervalSec || DEFAULT_MONITOR_SETTINGS.intervalSec),
          roomsPerPage: String(obj.roomsPerPage || DEFAULT_MONITOR_SETTINGS.roomsPerPage),
        };
      }catch(e){ return null; }
    }
    function saveMonitorSettingsLocal(obj){
      try{ localStorage.setItem(MONITOR_SETTINGS_KEY, JSON.stringify(obj)); }catch(e){}
    }
    function loadMonitorView(){
      try{ return localStorage.getItem(MONITOR_VIEW_KEY) || "timeline"; }catch(e){ return "timeline"; }
    }
    function saveMonitorView(v){
      try{ localStorage.setItem(MONITOR_VIEW_KEY, String(v||"timeline")); }catch(e){}
    }

    // --- deterministic id for import (avoid duplicates)
    function fnv1a32(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
      }
      return h >>> 0;
    }
    function deterministicIdForReservation(m){
      const base = `${m.date}|${m.roomId}|${m.startMin}|${m.endMin}|${String(m.groupName||"").trim()}`;
      return `imp_${fnv1a32(base).toString(36)}`;
    }


    function saveCache(key, value){
      try{ localStorage.setItem(key, JSON.stringify({ at: Date.now(), value })); }catch(e){}
    }
    function loadCache(key){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        return obj?.value ?? null;
      }catch(e){ return null; }
    }

    function classNames(...xs){ return xs.filter(Boolean).join(" "); }

    /**********************
     * read/writeæ¦‚ç®—ï¼ˆæœˆå˜ä½ï¼‰
     **********************/
    function loadOps(){
      const mk = monthKeyLocal();
      try{
        const raw = localStorage.getItem(OPS_KEY);
        if(!raw) return { month: mk, reads: 0, writes: 0 };
        const obj = JSON.parse(raw);
        if(obj?.month !== mk) return { month: mk, reads: 0, writes: 0 };
        return { month: mk, reads: Number(obj.reads||0), writes: Number(obj.writes||0) };
      }catch(e){ return { month: mk, reads: 0, writes: 0 }; }
    }
    function saveOps(ops){
      try{ localStorage.setItem(OPS_KEY, JSON.stringify(ops)); }catch(e){}
    }

    /**********************
     * UI primitives
     **********************/
    const Pill = ({children, tone="slate"}) => {
      const map = {
        slate: "bg-slate-100 text-slate-700 border-slate-200",
        sky: "bg-sky-50 text-sky-700 border-sky-200",
        emerald: "bg-emerald-50 text-emerald-700 border-emerald-200",
        rose: "bg-rose-50 text-rose-700 border-rose-200",
        amber: "bg-amber-50 text-amber-700 border-amber-200",
        violet: "bg-violet-50 text-violet-700 border-violet-200",
      };
      return (
        <span className={classNames("inline-flex items-center gap-1 px-2 py-1 rounded-xl text-[12px] font-black border", map[tone]||map.slate)}>
          {children}
        </span>
      );
    };

    const Card = ({children, printCard=false}) => (
      <div className={classNames("bg-white rounded-3xl p-4 shadow-sm border border-slate-100", printCard ? "print-card" : "")}>
        {children}
      </div>
    );

    const SectionTitle = ({icon, title, sub, right}) => (
      <div className="flex items-end justify-between gap-2 flex-wrap">
        <div className="space-y-1">
          <div className="flex items-center gap-2">
            <div className="w-9 h-9 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-700 font-black">
              {icon}
            </div>
            <div className="text-lg font-black text-slate-800">{title}</div>
          </div>
          {sub ? <div className="text-xs font-bold text-slate-400">{sub}</div> : null}
        </div>
        {right ? <div className="flex items-center gap-2">{right}</div> : null}
      </div>
    );

    function TabButton({active, onClick, children}){
      return (
        <button
          onClick={onClick}
          className={classNames(
            "rounded-2xl py-3 font-black border shadow-sm",
            active ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200"
          )}
        >
          {children}
        </button>
      );
    }

    const Modal = ({open, onClose, title, children}) => {
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 no-print">
          <div className="absolute inset-0 bg-black/30" onClick={onClose}></div>
          <div className="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center p-3">
            <div className="w-full md:max-w-4xl bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
              <div className="p-4 border-b border-slate-100 flex items-center justify-between">
                <div className="font-black text-slate-800">{title}</div>
                <button className="px-3 py-2 rounded-2xl bg-slate-100 font-black text-slate-700" onClick={onClose}>é–‰ã˜ã‚‹</button>
              </div>
              <div className="p-4 space-y-4">
                {children}
              </div>
            </div>
          </div>
        </div>
      );
    };

    /**********************
     * Main App
     **********************/
    function App(){
      const [tab, setTab] = useState("dashboard");
      const [selectedDate, setSelectedDate] = useState(todayKeyLocal());
      const [monitorDate, setMonitorDate] = useState(todayKeyLocal());

      const [monthCursor, setMonthCursor] = useState(() => monthKeyFromDateKey(todayKeyLocal()));
      const [monthReservations, setMonthReservations] = useState([]);
      const [monthBusy, setMonthBusy] = useState(false);

      const [monitorSettings, setMonitorSettings] = useState(() => loadMonitorSettings() || DEFAULT_MONITOR_SETTINGS);
      const [monitorDraft, setMonitorDraft] = useState(() => loadMonitorSettings() || DEFAULT_MONITOR_SETTINGS);
      const [monitorView, setMonitorView] = useState(() => loadMonitorView());

      const [yearQuery, setYearQuery] = useState("");
      const [yearRoomFilter, setYearRoomFilter] = useState("all");

      const [importOpen, setImportOpen] = useState(false);
      const [importText, setImportText] = useState("");
      const [importPreview, setImportPreview] = useState(null);
      const [importBusy, setImportBusy] = useState(false);

      const [user, setUser] = useState(null);
      const [authReady, setAuthReady] = useState(false);
      const isLoggedIn = !!user;

      const [busy, setBusy] = useState(false);
      const [toast, setToast] = useState(null);

      const [rooms, setRooms] = useState(DEFAULT_ROOMS);
      const [equipments, setEquipments] = useState(DEFAULT_EQUIPMENTS);

      const [dayReservations, setDayReservations] = useState([]);
      const [monitorReservations, setMonitorReservations] = useState([]);

      const [weekStart, setWeekStart] = useState(startOfWeekMonday(selectedDate));
      const weekKeys = useMemo(()=>Array.from({length:7}, (_,i)=>addDaysKey(weekStart, i)), [weekStart]);

      const [weekReservations, setWeekReservations] = useState([]);
      const [yearReservations, setYearReservations] = useState([]);
      const [yearBusy, setYearBusy] = useState(false);

      const [editorOpen, setEditorOpen] = useState(false);
      const [editModel, setEditModel] = useState(null);

      const [ops, setOps] = useState(loadOps());
      useEffect(()=>{ saveOps(ops); }, [ops]);

      // When month cursor changes, load cached month reservations
      useEffect(() => {
        const cache = loadCache(`${CACHE_PREFIX}:month:${monthCursor}`);
        if(cache) setMonthReservations(cache);
      }, [monthCursor]);

      // Keep draft in sync when saved settings change
      useEffect(() => {
        setMonitorDraft(monitorSettings);
      }, [monitorSettings]);

      function bumpReads(n){
        const mk = monthKeyLocal();
        setOps(prev => {
          const base = (prev.month === mk) ? prev : { month: mk, reads: 0, writes: 0 };
          return { ...base, reads: base.reads + Number(n||0) };
        });
      }
      function bumpWrites(n){
        const mk = monthKeyLocal();
        setOps(prev => {
          const base = (prev.month === mk) ? prev : { month: mk, reads: 0, writes: 0 };
          return { ...base, writes: base.writes + Number(n||0) };
        });
      }
      function resetOps(){
        const mk = monthKeyLocal();
        if(!confirm(`${mk} ã® read/writeï¼ˆæ¦‚ç®—ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) return;
        setOps({ month: mk, reads: 0, writes: 0 });
      }

      const roomsActive = useMemo(() =>
        (rooms||[])
          .filter(r => r.active !== false)
          .slice()
          .sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.building||"").localeCompare(String(b.building||"")) || String(a.name||"").localeCompare(String(b.name||"")))
      , [rooms]);

      const roomsMap = useMemo(() => {
        const m = {};
        for(const r of rooms||[]) m[r.id] = r;
        return m;
      }, [rooms]);

      const equipmentsActive = useMemo(() =>
        (equipments||[])
          .filter(e => e.active !== false)
          .slice()
          .sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.name||"").localeCompare(String(b.name||"")))
      , [equipments]);

      const equipmentsMap = useMemo(() => {
        const m = {};
        for(const e of equipments||[]) m[e.id] = e;
        return m;
      }, [equipments]);

      const roomName = (id) => roomsMap[id]?.name ?? id;
      const roomBuilding = (id) => roomsMap[id]?.building ?? "";

      const blankEquipment = (base={}) => {
        const out = {};
        for(const e of equipmentsActive){
          out[e.id] = Math.max(0, Math.min(999, Number(base?.[e.id] ?? 0) || 0));
        }
        return out;
      };

      const dayEquipmentUsed = useMemo(() => {
        const used = {};
        for(const e of equipmentsActive) used[e.id] = 0;
        for(const r of dayReservations){
          const eq = r?.equipment || {};
          for(const e of equipmentsActive){
            used[e.id] += Number(eq?.[e.id] ?? 0);
          }
        }
        return used;
      }, [dayReservations, equipmentsActive]);

      // Auth monitor
      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => { setUser(u||null); setAuthReady(true); });
        return () => unsub && unsub();
      }, []);

      // Sync weekStart with selectedDate
      useEffect(() => { setWeekStart(startOfWeekMonday(selectedDate)); }, [selectedDate]);

      // Load caches on mount
      useEffect(() => {
        const rCache = loadCache(`${CACHE_PREFIX}:rooms`);
        const eCache = loadCache(`${CACHE_PREFIX}:equipments`);
        const dCache = loadCache(`${CACHE_PREFIX}:reservations:${selectedDate}`);
        const mCache = loadCache(`${CACHE_PREFIX}:monitor:${monitorDate}`);
        const moCache = loadCache(`${CACHE_PREFIX}:month:${monthCursor}`);
        if(rCache?.length) setRooms(rCache);
        if(eCache?.length) setEquipments(eCache);
        if(dCache) setDayReservations(dCache);
        if(mCache) setMonitorReservations(mCache);
        if(moCache) setMonthReservations(moCache);

        const ms = loadMonitorSettings();
        if(ms) { setMonitorSettings(ms); setMonitorDraft(ms); }
        const mv = loadMonitorView();
        if(mv) setMonitorView(mv);
      }, []);

      // When date changes, load cached day reservations
      useEffect(() => {
        const dCache = loadCache(`${CACHE_PREFIX}:reservations:${selectedDate}`);
        if(dCache) setDayReservations(dCache);
      }, [selectedDate]);

      // When monitor date changes, load cached monitor reservations
      useEffect(() => {
        const mCache = loadCache(`${CACHE_PREFIX}:monitor:${monitorDate}`);
        if(mCache) setMonitorReservations(mCache);
      }, [monitorDate]);

      async function loginWithShared(password){
        setBusy(true);
        try{
          await auth.signInWithEmailAndPassword(SHARED_EMAIL, password);
          setToast({ type:"ok", msg:"ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼ˆç·¨é›†ã§ãã¾ã™ï¼‰" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ï¼ˆPWãŒé•ã†/ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªä½œæˆï¼‰" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2600);
        }
      }
      async function logout(){
        await auth.signOut();
        setToast({ type:"ok", msg:"ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ" });
        setTimeout(()=>setToast(null), 2000);
      }

      async function refreshMasters(opts={}){
        const silent = !!opts.silent;
        if(!silent) setBusy(true);
        let usedFallback = false;
        try{
          async function getList(col, fallback, cacheKey){
            try{
              const snap = await db.collection(col).get();
              bumpReads(snap.size);
              const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              if(list.length){
                saveCache(`${CACHE_PREFIX}:${cacheKey}`, list);
                return list;
              }
              saveCache(`${CACHE_PREFIX}:${cacheKey}`, fallback);
              return fallback;
            }catch(err){
              usedFallback = true;
              const cached = loadCache(`${CACHE_PREFIX}:${cacheKey}`);
              if(cached && Array.isArray(cached) && cached.length) return cached;
              return fallback;
            }
          }

          const roomsList = await getList("rooms", DEFAULT_ROOMS, "rooms");
          const eqList = await getList("equipments", DEFAULT_EQUIPMENTS, "equipments");
          setRooms(roomsList);
          setEquipments(eqList);

          if(!silent){
            setToast({ type:"ok", msg: usedFallback ? "ãƒã‚¹ã‚¿æ›´æ–°ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥/åˆæœŸå€¤ã‚’ä½¿ç”¨ã—ã¾ã—ãŸ" : "ãƒã‚¹ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ" });
          }
        }catch(err){
          console.error(err);
          if(!silent) setToast({ type:"ng", msg:"ãƒã‚¹ã‚¿æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ" });
        }finally{
          if(!silent){
            setBusy(false);
            setTimeout(()=>setToast(null), 2200);
          }
        }
      }

      async function refreshDay(dateKey){
        setBusy(true);
        try{
          const snap = await db.collection("reservations").where("date","==",dateKey).get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=>(String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
          setDayReservations(list);
          saveCache(`${CACHE_PREFIX}:reservations:${dateKey}`, list);
          setToast({ type:"ok", msg:"æ›´æ–°ã—ã¾ã—ãŸ" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2000);
        }
      }

      async function refreshMonitor(dateKey){
        setBusy(true);
        try{
          const snap = await db.collection("reservations").where("date","==",dateKey).get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=>(String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
          setMonitorReservations(list);
          saveCache(`${CACHE_PREFIX}:monitor:${dateKey}`, list);
          setToast({ type:"ok", msg:"ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2000);
        }
      }

      async function refreshWeek(startKey){
        setBusy(true);
        try{
          const endKey = addDaysKey(startKey, 6);
          const snap = await db.collection("reservations")
            .where("date", ">=", startKey)
            .where("date", "<=", endKey)
            .get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
          setWeekReservations(list);
          saveCache(`${CACHE_PREFIX}:week:${startKey}`, list);
          setToast({ type:"ok", msg:"é€±ã‚’æ›´æ–°ã—ã¾ã—ãŸ" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"é€±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2000);
        }
      }

      async function refreshMonth(monthKey){
        setMonthBusy(true);
        try{
          const start = startOfMonthKey(monthKey);
          const end = endOfMonthKey(monthKey);
          const snap = await db.collection("reservations")
            .where("date", ">=", start)
            .where("date", "<=", end)
            .get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || Number(a.startMin||0)-Number(b.startMin||0) || String(a.roomId||"").localeCompare(String(b.roomId||""))));
          setMonthReservations(list);
          saveCache(`${CACHE_PREFIX}:month:${monthKey}`, list);
          setToast({ type:"ok", msg:"æœˆäºˆå®šã‚’æ›´æ–°ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 1800);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"æœˆäºˆå®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setMonthBusy(false);
        }
      }

      async function refreshYear(){
        setYearBusy(true);
        try{
          // 4æœˆã€œç¿Œ3æœˆï¼ˆselectedDateåŸºæº–ã®å¹´åº¦ï¼‰
          const fy = (()=>{
            const d = parseKeyToDate(selectedDate);
            const y = d.getFullYear();
            const m = d.getMonth()+1;
            return (m>=4) ? y : (y-1);
          })();
          const start = `${fy}-04-01`;
          const end = `${fy+1}-03-31`;

          const snap = await db.collection("reservations")
            .where("date", ">=", start)
            .where("date", "<=", end)
            .get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
          setYearReservations(list);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"å¹´åº¦ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setYearBusy(false);
        }
      }

      function openNew(){
        const firstRoom = roomsActive[0]?.id || DEFAULT_ROOMS[0].id;
        setEditModel({
          id: null,
          date: selectedDate,
          roomId: firstRoom,
          startMin: hhmmToMin("09:00"),
          endMin: hhmmToMin("10:00"),
          groupName: "",
          note: "",
          equipment: blankEquipment({}),
        });
        setEditorOpen(true);
      }

      function openEdit(r){
        setEditModel({
          id: r.id,
          date: r.date,
          roomId: r.roomId,
          startMin: Number(r.startMin||0),
          endMin: Number(r.endMin||0),
          groupName: r.groupName || "",
          note: r.note || "",
          equipment: blankEquipment(r.equipment || {}),
        });
        setEditorOpen(true);
      }

      async function saveReservation(model){
        if(!isLoggedIn){
          setToast({ type:"ng", msg:"ç·¨é›†ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        const g = (model.groupName||"").trim();
        if(!g){
          setToast({ type:"ng", msg:"å›£ä½“åã¯å¿…é ˆã§ã™" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        if(!isValidDateKey(model.date)){
          setToast({ type:"ng", msg:"æ—¥ä»˜ãŒä¸æ­£ã§ã™" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        const sMin = Number(model.startMin);
        const eMin = Number(model.endMin);
        if(!(eMin > sMin)){
          setToast({ type:"ng", msg:"çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }

        // åŒæ—¥ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®Ÿã«æŒã¤ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã ã‘ã ã¨ã‚ºãƒ¬ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ä¿å­˜å‰ã«åŒæ—¥ã‚’å–å¾—ï¼‰
        setBusy(true);
        try{
          const sameSnap = await db.collection("reservations").where("date","==",model.date).get();
          bumpReads(sameSnap.size);
          const sameDate = sameSnap.docs.map(d => ({ id:d.id, ...d.data() }));

          // 1) åŒå®¤é‡è¤‡
          const sameRoom = sameDate.filter(x => x.roomId === model.roomId && x.id !== model.id);
          const conflict = sameRoom.some(x => overlaps(sMin,eMin, Number(x.startMin||0), Number(x.endMin||0)));
          if(conflict){
            setToast({ type:"ng", msg:"åŒã˜éƒ¨å±‹ã§æ™‚é–“ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ï¼ˆäºˆç´„ä¸å¯ï¼‰" });
            setTimeout(()=>setToast(null), 2800);
            return;
          }

          // 2) æ©Ÿæè¶…éï¼ˆåŒæ™‚é–“å¸¯ã€å…¨å®¤ï¼‰
          const overlapsAny = sameDate
            .filter(x => x.id !== model.id)
            .filter(x => overlaps(sMin,eMin, Number(x.startMin||0), Number(x.endMin||0)));

          const need = blankEquipment(model.equipment || {});
          const used = {};
          for(const e of equipmentsActive) used[e.id] = 0;

          for(const r of overlapsAny){
            const eq = r?.equipment || {};
            for(const e of equipmentsActive){
              used[e.id] += Number(eq?.[e.id] ?? 0);
            }
          }

          const warnings = [];
          for(const e of equipmentsActive){
            const total = Number(e.countTotal ?? 0) || 0;
            const after = used[e.id] + (need[e.id]||0);
            if(total > 0 && after > total){
              warnings.push(`${e.name}ãŒç·æ•° ${total} ã‚’è¶…ãˆã¾ã™ï¼ˆåŒæ™‚é–“å¸¯ åˆè¨ˆ ${after}ï¼‰`);
            }
          }
          if(warnings.length){
            const ok = confirm(`ã€æ©Ÿæã®è­¦å‘Šã€‘\n${warnings.join("\n")}\n\nãã‚Œã§ã‚‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`);
            if(!ok) return;
          }

          const payload = {
            date: model.date,
            roomId: model.roomId,
            startMin: sMin,
            endMin: eMin,
            groupName: g,
            note: (model.note||"").trim(),
            equipment: need,
            updatedAt: serverTimestamp(),
          };

          if(model.id){
            await db.collection("reservations").doc(model.id).set(payload, { merge:true });
            bumpWrites(1);
          }else{
            await db.collection("reservations").add({ ...payload, createdAt: serverTimestamp() });
            bumpWrites(1);
          }

          setEditorOpen(false);
          setEditModel(null);

          // ç”»é¢ã«å¿œã˜ã¦æ›´æ–°
          await refreshDay(selectedDate);
          if(tab === "monitor") await refreshMonitor(monitorDate);
          if(tab === "week") await refreshWeek(weekStart);
          if(tab === "month") await refreshMonth(monthCursor);
          if(tab === "year") await refreshYear();

          setToast({ type:"ok", msg:"ä¿å­˜ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 1500);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      async function deleteReservation(id){
        if(!isLoggedIn) return;
        if(!confirm("ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        setBusy(true);
        try{
          await db.collection("reservations").doc(id).delete();
          bumpWrites(1);
          await refreshDay(selectedDate);
          if(tab === "monitor") await refreshMonitor(monitorDate);
          if(tab === "week") await refreshWeek(weekStart);
          if(tab === "month") await refreshMonth(monthCursor);
          if(tab === "year") await refreshYear();
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      function doPrint(){
        setTimeout(()=>window.print(), 120);
      }

      // Auto refresh master once auth ready
      useEffect(() => {
        if(!authReady) return;
        refreshMasters({ silent:true });
      }, [authReady]);

      // Auto refresh day reservations on first load
      useEffect(() => {
        if(!authReady) return;
        refreshDay(selectedDate);
      }, [authReady]);

      const fyInfo = useMemo(() => {
        const d = parseKeyToDate(selectedDate);
        const y = d.getFullYear();
        const m = d.getMonth()+1;
        const fy = (m>=4) ? y : (y-1);
        return { fy, start: `${fy}-04-01`, end: `${fy+1}-03-31`, label: `${fy}å¹´åº¦` };
      }, [selectedDate]);

      return (
        <div className="min-h-screen pb-24">
          <div className="max-w-7xl mx-auto px-4 pt-5">
            <div className="flex items-center justify-between gap-3 flex-wrap">
              <div>
                <div className="text-2xl font-black text-slate-900">å¤·éš…æ•™è‚²ä¼šé¤¨ ç®¡ç†</div>
                <div className="text-xs font-bold text-slate-400 mt-1">éƒ¨å±‹äºˆç´„ / å…¥å£ãƒ¢ãƒ‹ã‚¿ãƒ¼ / é€±ãƒ»å¹´åº¦ä¸€è¦§ / éƒ¨å±‹ãƒ»æ©Ÿæãƒã‚¹ã‚¿ç·¨é›†</div>
              </div>

              <div className="flex items-center gap-2">
                <button
                  className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                    (busy || monthBusy || yearBusy || importBusy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-sky-600 text-white border-sky-600")}
                  disabled={busy || monthBusy || yearBusy || importBusy}
                  onClick={() => {
                    if(tab === "monitor") return refreshMonitor(monitorDate);
                    if(tab === "week") return refreshWeek(weekStart);
                    if(tab === "month") return refreshMonth(monthCursor);
                    if(tab === "year") return refreshYear();
                    return refreshDay(selectedDate);
                  }}
                >
                  æ›´æ–°
                </button>
                <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={refreshMasters} disabled={busy}>
                  ãƒã‚¹ã‚¿æ›´æ–°
                </button>
                <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={doPrint}>
                  å°åˆ·
                </button>

                {isLoggedIn ? (
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={logout}>
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                  </button>
                ) : (
                  <LoginButton busy={busy} onLogin={loginWithShared} />
                )}
              </div>
            </div>

            <div className="mt-3 flex items-center gap-2 flex-wrap">
              <Pill tone={isLoggedIn ? "emerald" : "slate"}>{isLoggedIn ? "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼‰" : "é–²è¦§ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãªã—ï¼‰"}</Pill>
              <Pill tone="sky">å…±é€šIDï¼š{SHARED_LOGIN_CODE}</Pill>
              <Pill tone="violet">å¹´åº¦ï¼š{fyInfo.fy}ï¼ˆ{fyInfo.start}ã€œ{fyInfo.end}ï¼‰</Pill>
              <Pill tone="amber">æ¦‚ç®— readsï¼š{ops.reads}</Pill>
              <Pill tone="amber">æ¦‚ç®— writesï¼š{ops.writes}</Pill>
              <button className="px-3 py-1.5 rounded-xl bg-white border border-slate-200 font-black text-xs text-slate-700" onClick={resetOps}>
                read/write ãƒªã‚»ãƒƒãƒˆ
              </button>
              {busy ? <Pill tone="amber">å‡¦ç†ä¸­â€¦</Pill> : null}
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 mt-3">
            <div className="grid grid-cols-3 md:grid-cols-9 gap-2 no-print">
              <TabButton active={tab==="dashboard"} onClick={()=>setTab("dashboard")}>å…¨ä½“</TabButton>
              <TabButton active={tab==="monitor"} onClick={()=>{ setTab("monitor"); setMonitorDate(todayKeyLocal()); }}>å…¥å£</TabButton>
              <TabButton active={tab==="day"} onClick={()=>setTab("day")}>æ—¥</TabButton>
              <TabButton active={tab==="week"} onClick={()=>{ setTab("week"); }}>é€±</TabButton>
              <TabButton active={tab==="month"} onClick={()=>{ setMonthCursor(monthKeyFromDateKey(selectedDate)); setTab("month"); }}>æœˆ</TabButton>
              <TabButton active={tab==="year"} onClick={()=>{ setTab("year"); }}>å¹´åº¦</TabButton>
              <TabButton active={tab==="equip"} onClick={()=>setTab("equip")}>æ©Ÿæ</TabButton>
              <TabButton active={tab==="rooms"} onClick={()=>setTab("rooms")}>éƒ¨å±‹</TabButton>
              <TabButton active={tab==="help"} onClick={()=>setTab("help")}>è¨­å®š</TabButton>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 mt-4 space-y-4">
            {tab === "dashboard" && (
              <div className="space-y-4">
                <Card printCard>
                  <SectionTitle
                    icon="ğŸ "
                    title="ä»Šæ—¥ã®çŠ¶æ³"
                    sub="ã¾ãšã¯ã“ã“ã ã‘è¦‹ã‚Œã°OK"
                    right={isLoggedIn ? (
                      <button className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm no-print" onClick={openNew}>
                        ï¼‹äºˆç´„è¿½åŠ 
                      </button>
                    ) : null}
                  />

                  <div className="mt-4 grid md:grid-cols-3 gap-3">
                    <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                      <div className="text-xs font-black text-slate-500">éƒ¨å±‹äºˆç´„ï¼ˆä»¶æ•°ï¼‰</div>
                      <div className="text-3xl font-black text-slate-800 mt-1">{dayReservations.length}</div>
                      <div className="text-xs font-bold text-slate-400 mt-2">æ—¥ä»˜ï¼š{selectedDate}</div>
                    </div>

                    <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                      <div className="text-xs font-black text-slate-500">æ©Ÿæä½¿ç”¨ï¼ˆåˆè¨ˆï¼‰</div>
                      <div className="mt-2 space-y-2">
                        {equipmentsActive.length === 0 ? (
                          <div className="text-xs font-bold text-slate-400">æ©ŸæãŒæœªè¨­å®šã§ã™</div>
                        ) : equipmentsActive.map(e => (
                          <div key={e.id} className="flex items-center justify-between">
                            <div className="font-black text-slate-800">{e.name}</div>
                            <div className="font-black text-slate-800">{dayEquipmentUsed[e.id]||0} / {(e.countTotal ?? "â€”")}</div>
                          </div>
                        ))}
                      </div>
                      <div className="text-xs font-bold text-slate-400 mt-2">â€»äºˆç´„ã«ç´ã¥ãã€Œä½¿ç”¨å°æ•°ã€ã®åˆè¨ˆ</div>
                    </div>

                    <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                      <div className="text-xs font-black text-slate-500">ã‚¯ã‚¤ãƒƒã‚¯æ“ä½œ</div>
                      <div className="mt-3 flex flex-wrap gap-2">
                        <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>{ setTab("day"); }}>
                          æ—¥äºˆç´„ã¸
                        </button>
                        <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>{ setTab("week"); }}>
                          é€±ä¸€è¦§ã¸
                        </button>
                        <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>{ setTab("year"); }}>
                          å¹´åº¦ä¸€è¦§ã¸
                        </button>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4 flex items-center justify-between gap-2 flex-wrap">
                    <div className="text-sm font-black text-slate-700">æ—¥ä»˜</div>
                    <div className="flex items-center gap-2 no-print">
                      <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setSelectedDate(todayKeyLocal())}>ä»Šæ—¥</button>
                      <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setSelectedDate(addDaysKey(todayKeyLocal(),1))}>æ˜æ—¥</button>
                      <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setSelectedDate(addDaysKey(todayKeyLocal(),2))}>æ˜å¾Œæ—¥</button>
                    </div>
                    <input type="date" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={selectedDate} onChange={(e)=>setSelectedDate(e.target.value)} />
                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>refreshDay(selectedDate)} disabled={busy}>ã“ã®æ—¥ã‚’æ›´æ–°</button>
                  </div>

                  <div className="mt-4 text-sm font-black text-slate-700">éƒ¨å±‹ã”ã¨ã®äºˆç´„ï¼ˆ{selectedDate}ï¼‰</div>
                  <div className="mt-3 grid md:grid-cols-2 gap-3">
                    {roomsActive.map(room => {
                      const list = dayReservations.filter(r => r.roomId === room.id).slice().sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
                      return (
                        <div key={room.id} className="rounded-3xl border border-slate-100 p-4">
                          <div className="flex items-center justify-between">
                            <div className="space-y-0.5">
                              <div className="text-xs font-black text-slate-400">{room.building}</div>
                              <div className="font-black text-slate-800">{room.name}</div>
                            </div>
                            <Pill tone="slate">{list.length}ä»¶</Pill>
                          </div>

                          <div className="mt-3 space-y-2">
                            {list.length === 0 ? (
                              <div className="text-xs font-bold text-slate-400">äºˆç´„ãªã—</div>
                            ) : list.map(r => (
                              <div key={r.id} className="flex items-start justify-between gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100">
                                <div className="min-w-0">
                                  <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}â€“{minToHHMM(r.endMin||0)} / {r.groupName}</div>
                                  <div className="text-xs font-bold text-slate-500 mt-1 flex gap-2 flex-wrap">
                                    {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                                      <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                                    ) : null)}
                                    {r.note ? <Pill tone="slate">ãƒ¡ãƒ¢</Pill> : null}
                                  </div>
                                </div>
                                {isLoggedIn ? (
                                  <div className="shrink-0 flex items-center gap-2 no-print">
                                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>openEdit(r)}>
                                      ç·¨é›†
                                    </button>
                                  </div>
                                ) : null}
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </Card>
              </div>
            )}

            {tab === "day" && (
              <Card printCard>
                <SectionTitle
                  icon="ğŸ“…"
                  title="æ—¥äºˆç´„"
                  sub="æ—¥ã”ã¨ã®äºˆç´„ä¸€è¦§ï¼ˆé‡è¤‡ã¯ä¿å­˜æ™‚ã«ãƒ–ãƒ­ãƒƒã‚¯ï¼‰"
                  right={isLoggedIn ? (
                    <button className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm no-print" onClick={openNew}>
                      ï¼‹äºˆç´„è¿½åŠ 
                    </button>
                  ) : null}
                />

                <div className="mt-4 flex items-center gap-2 flex-wrap">
                  <input type="date" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={selectedDate} onChange={(e)=>setSelectedDate(e.target.value)} />
                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>refreshDay(selectedDate)} disabled={busy}>
                    ã“ã®æ—¥ã‚’æ›´æ–°
                  </button>
                  <div className="text-xs font-bold text-slate-400">â€»è¡¨ç¤ºãŒå¤ã„å ´åˆã¯ã€Œæ›´æ–°ã€</div>
                </div>

                <div className="mt-4 grid md:grid-cols-2 gap-3">
                  {roomsActive.map(room => {
                    const list = dayReservations.filter(r => r.roomId === room.id).slice().sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
                    return (
                      <div key={room.id} className="rounded-3xl border border-slate-100 p-4">
                        <div className="flex items-center justify-between">
                          <div className="space-y-0.5">
                            <div className="text-xs font-black text-slate-400">{room.building}</div>
                            <div className="font-black text-slate-800">{room.name}</div>
                          </div>
                          <Pill tone="slate">{list.length}ä»¶</Pill>
                        </div>
                        <div className="mt-3 space-y-2">
                          {list.length === 0 ? (
                            <div className="text-xs font-bold text-slate-400">äºˆç´„ãªã—</div>
                          ) : list.map(r => (
                            <div key={r.id} className="p-3 rounded-2xl bg-slate-50 border border-slate-100">
                              <div className="flex items-start justify-between gap-2">
                                <div className="min-w-0">
                                  <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}â€“{minToHHMM(r.endMin||0)} / {r.groupName}</div>
                                  <div className="mt-1 flex flex-wrap gap-2">
                                    {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                                      <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                                    ) : null)}
                                    {r.note ? <Pill tone="slate">ãƒ¡ãƒ¢</Pill> : null}
                                  </div>
                                  {r.note ? <div className="text-xs font-bold text-slate-500 mt-2">{r.note}</div> : null}
                                </div>
                                {isLoggedIn ? (
                                  <div className="shrink-0 flex flex-col gap-2 no-print">
                                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>openEdit(r)}>
                                      ç·¨é›†
                                    </button>
                                    <button className="px-3 py-2 rounded-2xl bg-rose-50 border border-rose-200 font-black text-rose-700" onClick={()=>deleteReservation(r.id)}>
                                      å‰Šé™¤
                                    </button>
                                  </div>
                                ) : null}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </Card>
            )}

            {tab === "monitor" && (
              <Card printCard>
                <SectionTitle
                  icon="ğŸ–¥ï¸"
                  title="å…¥å£ãƒ¢ãƒ‹ã‚¿ãƒ¼"
                  sub="1æ—¥åˆ†ã‚’å…¨ç”»é¢ã§è¦‹ã‚„ã™ãï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ€å°åŒ–ï¼‰"
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setMonitorDate(todayKeyLocal())}>ä»Šæ—¥</button>
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setMonitorDate(addDaysKey(todayKeyLocal(),1))}>æ˜æ—¥</button>
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setMonitorDate(addDaysKey(todayKeyLocal(),2))}>æ˜å¾Œæ—¥</button>

                      <div className="flex items-center gap-2 rounded-2xl bg-white border border-slate-200 px-2 py-1">
                        <button className={classNames("px-3 py-2 rounded-2xl font-black", monitorView==="timeline" ? "bg-slate-900 text-white" : "bg-white text-slate-700")} onClick={()=>{ setMonitorView("timeline"); saveMonitorView("timeline"); }}>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</button>
                        <button className={classNames("px-3 py-2 rounded-2xl font-black", monitorView==="cards" ? "bg-slate-900 text-white" : "bg-white text-slate-700")} onClick={()=>{ setMonitorView("cards"); saveMonitorView("cards"); }}>ã‚«ãƒ¼ãƒ‰</button>
                      </div>

                      <button
                        className="rounded-2xl px-4 py-2 font-black bg-slate-900 text-white border border-slate-900"
                        onClick={() => {
                          const el = document.documentElement;
                          if(el.requestFullscreen) el.requestFullscreen();
                        }}
                      >
                        å…¨ç”»é¢
                      </button>
                    </div>
                  }
                />

                <div className="mt-4 flex items-center gap-2 flex-wrap">
                  <div className="text-sm font-black text-slate-800">è¡¨ç¤ºæ—¥</div>
                  <input type="date" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={monitorDate} onChange={(e)=>setMonitorDate(e.target.value)} />
                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>refreshMonitor(monitorDate)} disabled={busy}>
                    ã“ã®æ—¥ã‚’æ›´æ–°
                  </button>
                  <div className="text-xs font-bold text-slate-400">æ™‚é–“è»¸ï¼š{monitorSettings.startHHMM}ã€œ{monitorSettings.endHHMM}ï¼ˆå¤‰æ›´ã¯ã€Œè¨­å®šã€ï¼‰</div>
                </div>

                {monitorView === "timeline" ? (
                  <MonitorTimelineBoard
                    dateKey={monitorDate}
                    rooms={roomsActive}
                    reservations={monitorReservations}
                    equipmentsActive={equipmentsActive}
                    startHHMM={monitorSettings.startHHMM}
                    endHHMM={monitorSettings.endHHMM}
                    autoPage={monitorSettings.autoPage}
                    intervalSec={monitorSettings.intervalSec}
                    roomsPerPage={monitorSettings.roomsPerPage}
                  />
                ) : (
                  <MonitorBoard
                    dateKey={monitorDate}
                    rooms={roomsActive}
                    equipmentsActive={equipmentsActive}
                    reservations={monitorReservations}
                  />
                )}
              </Card>
            )}


            {tab === "week" && (
              <Card printCard>
                <SectionTitle
                  icon="ğŸ§¾"
                  title="é€±äºˆå®š"
                  sub={`é€±ï¼š${weekStart}ã€œ${addDaysKey(weekStart,6)}ï¼ˆæœˆæ›œå§‹ã¾ã‚Šï¼‰`}
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const prev=addDaysKey(weekStart,-7); setWeekStart(prev); }}>
                        â—€ å‰é€±
                      </button>
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const next=addDaysKey(weekStart,7); setWeekStart(next); }}>
                        æ¬¡é€± â–¶
                      </button>
                      <button className={classNames("rounded-2xl px-4 py-2 font-black border",
                        busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                        onClick={()=>refreshWeek(weekStart)} disabled={busy}
                      >
                        ã“ã®é€±ã‚’æ›´æ–°
                      </button>
                    </div>
                  }
                />

                <div className="mt-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 2xl:grid-cols-7 gap-3">
                  {weekKeys.map((dk, idx) => {
                    const list = (weekReservations||[]).filter(r => r.date === dk).slice().sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
                    const names = ["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥"];
                    return (
                      <div key={dk} className="rounded-3xl border border-slate-100 bg-white p-4 flex flex-col min-h-[220px]">
                        <div className="flex items-center justify-between gap-2">
                          <div>
                            <div className="text-xs font-black text-slate-400">{names[idx]}</div>
                            <div className="font-black text-slate-800">{dk}</div>
                          </div>
                          <Pill tone="slate">{list.length}ä»¶</Pill>
                        </div>
                        <div className="mt-3 space-y-2 overflow-auto no-scrollbar" style={{maxHeight:"52vh"}}>
                          {list.length===0 ? (
                            <div className="text-xs font-bold text-slate-400">äºˆç´„ãªã—</div>
                          ) : list.map(r => (
                            <div key={r.id} className="p-3 rounded-2xl bg-slate-50 border border-slate-100 break-avoid">
                              <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}â€“{minToHHMM(r.endMin||0)} / {roomName(r.roomId)}</div>
                              <div className="text-xs font-bold text-slate-700 mt-1 break-words">{r.groupName}</div>
                              <div className="mt-2 flex flex-wrap gap-1">
                                {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                                  <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                                ) : null)}
                                {r.note ? <Pill tone="slate">ãƒ¡ãƒ¢</Pill> : null}
                              </div>
                              {r.note ? <div className="text-xs font-bold text-slate-500 mt-2 break-words">{r.note}</div> : null}
                              {isLoggedIn ? (
                                <div className="mt-2 flex gap-2 no-print">
                                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>openEdit(r)}>
                                    ç·¨é›†
                                  </button>
                                </div>
                              ) : null}
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>

                <div className="mt-3 text-xs font-bold text-slate-400">â€»é€±äºˆå®šã¯ã€Œã“ã®é€±ã‚’æ›´æ–°ã€ã§Firestoreã‹ã‚‰å–å¾—ï¼ˆæ¦‚ç®—readã«åæ˜ ï¼‰</div>
              </Card>
            )}

            {tab === "month" && (
              <Card printCard>
                <SectionTitle
                  icon="ğŸ—“ï¸"
                  title="æœˆäºˆå®š"
                  sub={`æœˆï¼š${monthCursor}`}
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const prev = addMonthsKey(monthCursor,-1); setMonthCursor(prev); }}>
                        â—€ å‰æœˆ
                      </button>
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const next = addMonthsKey(monthCursor,1); setMonthCursor(next); }}>
                        æ¬¡æœˆ â–¶
                      </button>
                      <button className={classNames("rounded-2xl px-4 py-2 font-black border",
                        monthBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                        onClick={()=>refreshMonth(monthCursor)} disabled={monthBusy}
                      >
                        ã“ã®æœˆã‚’æ›´æ–°
                      </button>
                      <button className="rounded-2xl px-4 py-2 font-black bg-slate-900 text-white border border-slate-900" onClick={()=>{ setMonthCursor(monthKeyFromDateKey(todayKeyLocal())); }}>
                        ä»Šæœˆ
                      </button>
                    </div>
                  }
                />

                <div className="mt-3 text-xs font-bold text-slate-400">â€»æœˆäºˆå®šã¯ã€Œã“ã®æœˆã‚’æ›´æ–°ã€ã§Firestoreã‹ã‚‰å–å¾—ï¼ˆæ¦‚ç®—readã«åæ˜ ï¼‰</div>

                <MonthCalendar
                  monthKey={monthCursor}
                  reservations={monthReservations}
                  roomsMap={roomsMap}
                  onPickDate={(dk)=>{ setSelectedDate(dk); setTab("day"); }}
                />
              </Card>
            )}

            {tab === "year" && (
              <Card printCard>
                <SectionTitle
                  icon="ğŸ—“ï¸"
                  title="å¹´é–“äºˆå®šï¼ˆå¹´åº¦ï¼‰"
                  sub={`å¹´åº¦ï¼š${fyInfo.fy}ï¼ˆ${fyInfo.start}ã€œ${fyInfo.end}ï¼‰ / 4æœˆå§‹ã¾ã‚Š`}
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      {isLoggedIn ? (
                        <button className="rounded-2xl px-4 py-2 font-black bg-slate-900 text-white border border-slate-900" onClick={()=>setImportOpen(true)} disabled={importBusy||yearBusy}>
                          å¹´é–“ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </button>
                      ) : null}
                      <button className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                        yearBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                        disabled={yearBusy}
                        onClick={refreshYear}
                      >
                        å¹´é–“ã‚’æ›´æ–°
                      </button>
                    </div>
                  }
                />

                <div className="mt-3 grid lg:grid-cols-3 gap-3">
                  <div className="rounded-3xl border border-slate-100 bg-white p-4 lg:col-span-2">
                    <div className="flex flex-wrap items-center gap-2">
                      <div className="text-sm font-black text-slate-800">çµã‚Šè¾¼ã¿</div>
                      <input
                        className="flex-1 min-w-[220px] rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
                        value={yearQuery}
                        onChange={(e)=>setYearQuery(e.target.value)}
                        placeholder="å›£ä½“å / ãƒ¡ãƒ¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰"
                      />
                      <select
                        className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
                        value={yearRoomFilter}
                        onChange={(e)=>setYearRoomFilter(e.target.value)}
                      >
                        <option value="all">å…¨éƒ¨å±‹</option>
                        {roomsActive.map(r => (
                          <option key={r.id} value={r.id}>{r.building} / {r.name}</option>
                        ))}
                      </select>
                      <Pill tone="slate">{yearReservations.length}ä»¶</Pill>
                    </div>

                    <div className="mt-3 text-xs font-bold text-slate-400">â€»ã€Œå¹´é–“ã‚’æ›´æ–°ã€ã§å¹´åº¦å†…ï¼ˆ4æœˆã€œç¿Œ3æœˆï¼‰ã‚’ã¾ã¨ã‚ã¦å–å¾—ã—ã¾ã™ã€‚ä»¶æ•°ãŒå¤šã„ã¨readãŒå¢—ãˆã¾ã™ã€‚</div>

                    <YearGroupedList
                      fyInfo={fyInfo}
                      roomsMap={roomsMap}
                      equipmentsActive={equipmentsActive}
                      reservations={yearReservations}
                      query={yearQuery}
                      roomFilter={yearRoomFilter}
                      isLoggedIn={isLoggedIn}
                      onEdit={(r)=>openEdit(r)}
                      onJumpDay={(dk)=>{ setSelectedDate(dk); setTab("day"); }}
                    />
                  </div>

                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                    <div className="font-black text-slate-800">æœˆã¸ã‚¸ãƒ£ãƒ³ãƒ—</div>
                    <div className="mt-2 grid grid-cols-3 gap-2">
                      {Array.from({length:12}, (_,i)=>i+1).map(mm => {
                        const mk = (mm>=4) ? `${fyInfo.fy}-${pad2(mm)}` : `${fyInfo.fy+1}-${pad2(mm)}`;
                        return (
                          <a key={mk} href={`#ym-${mk}`} className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700 text-center">
                            {mk.slice(5)}
                          </a>
                        );
                      })}
                    </div>
                    <div className="mt-4 text-xs font-bold text-slate-500 space-y-1">
                      <div>ãƒ»ã€Œå¹´é–“ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã¯ã€Excel/ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è²¼ã‚Šä»˜ã‘â†’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼â†’ä¸€æ‹¬ç™»éŒ²ã€‚</div>
                      <div>ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ç·¨é›†ã¯ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿ã€‚</div>
                    </div>
                  </div>
                </div>
              </Card>
            )}

            {tab === "equip" && (
              <Card printCard>
                <SectionTitle
                  icon="ğŸ§°"
                  title="æ©Ÿæãƒã‚¹ã‚¿"
                  sub="æ©Ÿæã®ç¨®é¡ãƒ»å°æ•°ï¼ˆç·æ•°ï¼‰ã‚’è¿½åŠ /å¤‰æ›´ã§ãã¾ã™"
                />

                <div className="mt-4">
                  {!isLoggedIn ? (
                    <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">ç·¨é›†ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>
                  ) : null}

                  <EquipmentManager
                    equipments={equipments}
                    setEquipments={setEquipments}
                    isLoggedIn={isLoggedIn}
                    busy={busy}
                    onSaved={() => refreshMasters()}
                    bumpReads={bumpReads}
                    bumpWrites={bumpWrites}
                  />
                </div>

                <div className="mt-4 rounded-3xl border border-slate-100 bg-slate-50 p-4">
                  <div className="font-black text-slate-800">ãƒ¡ãƒ¢</div>
                  <ul className="mt-2 text-sm font-bold text-slate-700 list-disc pl-5 space-y-1">
                    <li>ã€Œactive = falseã€ã¯å‰Šé™¤ã§ã¯ãªã<strong>éè¡¨ç¤º</strong>ã§ã™ï¼ˆéå»ãƒ‡ãƒ¼ã‚¿ä¿è­·ï¼‰ã€‚</li>
                    <li>äºˆç´„å…¥åŠ›/è¶…éãƒã‚§ãƒƒã‚¯/ãƒ¢ãƒ‹ã‚¿ãƒ¼è¡¨ç¤ºã¯ã€activeãªæ©Ÿæã«è¿½å¾“ã—ã¾ã™ã€‚</li>
                  </ul>
                </div>
              </Card>
            )}

            {tab === "rooms" && (
              <Card printCard>
                <SectionTitle
                  icon="ğŸ¢"
                  title="éƒ¨å±‹ãƒã‚¹ã‚¿"
                  sub="éƒ¨å±‹åã®è¿½åŠ /å¤‰æ›´/éè¡¨ç¤ºï¼ˆå‰Šé™¤ã—ãªã„ï¼‰"
                />

                <div className="mt-4">
                  {!isLoggedIn ? (
                    <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">ç·¨é›†ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>
                  ) : null}

                  <RoomManager
                    rooms={rooms}
                    setRooms={setRooms}
                    isLoggedIn={isLoggedIn}
                    busy={busy}
                    onSaved={() => refreshMasters()}
                    bumpReads={bumpReads}
                    bumpWrites={bumpWrites}
                  />
                </div>

                <div className="mt-4 rounded-3xl border border-slate-100 bg-slate-50 p-4">
                  <div className="font-black text-slate-800">ãƒ¡ãƒ¢</div>
                  <ul className="mt-2 text-sm font-bold text-slate-700 list-disc pl-5 space-y-1">
                    <li>ã€Œactive = falseã€ã¯<strong>éè¡¨ç¤º</strong>ã§ã™ï¼ˆäºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’å£Šã—ã¾ã›ã‚“ï¼‰ã€‚</li>
                    <li>è¡¨ç¤ºé †ã¯ order ã§èª¿æ•´ã§ãã¾ã™ï¼ˆå°ã•ã„ã»ã©ä¸Šï¼‰ã€‚</li>
                  </ul>
                </div>
              </Card>
            )}

            {tab === "help" && (
              <Card printCard>
                <SectionTitle
                  icon="âš™ï¸"
                  title="è¨­å®š"
                  sub="å…¥å£ãƒ¢ãƒ‹ã‚¿ãƒ¼ã®æ™‚é–“è»¸ / read-writeï¼ˆæ¦‚ç®—ï¼‰ / é‹ç”¨"
                />

                <div className="mt-4 grid md:grid-cols-2 gap-3">
                  <div className="rounded-3xl border border-slate-100 bg-white p-4">
                    <div className="font-black text-slate-800">å…¥å£ãƒ¢ãƒ‹ã‚¿ãƒ¼è¨­å®š</div>
                    <div className="text-xs font-bold text-slate-500 mt-2">â€»å¤‰æ›´ãƒ»ä¿å­˜ã¯ <span className="text-slate-900">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿</span> ã§ãã¾ã™ï¼ˆè¡¨ç¤ºã¯å…¨å“¡OKï¼‰</div>

                    <div className="mt-3 grid grid-cols-2 gap-2">
                      <div>
                        <div className="text-xs font-black text-slate-600 mb-1">é–‹å§‹</div>
                        <input type="time" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={monitorDraft.startHHMM} onChange={(e)=>setMonitorDraft(d=>({ ...d, startHHMM:e.target.value }))} disabled={!isLoggedIn||busy} />
                      </div>
                      <div>
                        <div className="text-xs font-black text-slate-600 mb-1">çµ‚äº†</div>
                        <input type="time" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={monitorDraft.endHHMM} onChange={(e)=>setMonitorDraft(d=>({ ...d, endHHMM:e.target.value }))} disabled={!isLoggedIn||busy} />
                      </div>
                    </div>

                    <div className="mt-3 grid grid-cols-2 gap-2">
                      <div className="rounded-3xl border border-slate-100 bg-slate-50 p-3">
                        <div className="text-xs font-black text-slate-600">è‡ªå‹•ãƒšãƒ¼ã‚¸é€ã‚Š</div>
                        <label className="mt-2 flex items-center gap-2 font-black text-slate-700">
                          <input type="checkbox" checked={!!monitorDraft.autoPage} onChange={(e)=>setMonitorDraft(d=>({ ...d, autoPage:e.target.checked }))} disabled={!isLoggedIn||busy} />
                          ON
                        </label>
                        <div className="text-[11px] font-bold text-slate-400 mt-1">éƒ¨å±‹ãŒå¤šã„æ™‚ã«è‡ªå‹•ã§åˆ‡æ›¿</div>
                      </div>
                      <div className="rounded-3xl border border-slate-100 bg-slate-50 p-3">
                        <div className="text-xs font-black text-slate-600">åˆ‡æ›¿é–“éš”ï¼ˆç§’ï¼‰</div>
                        <input type="number" min="5" max="120" className="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={Number(monitorDraft.intervalSec||12)} onChange={(e)=>setMonitorDraft(d=>({ ...d, intervalSec:Number(e.target.value||12) }))} disabled={!isLoggedIn||busy} />
                        <div className="text-[11px] font-bold text-slate-400 mt-1">5ã€œ120</div>
                      </div>
                    </div>

                    <div className="mt-3">
                      <div className="text-xs font-black text-slate-600 mb-1">1ç”»é¢ã«è¡¨ç¤ºã™ã‚‹éƒ¨å±‹æ•°</div>
                      <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={String(monitorDraft.roomsPerPage||"auto")} onChange={(e)=>setMonitorDraft(d=>({ ...d, roomsPerPage:e.target.value }))} disabled={!isLoggedIn||busy}>
                        <option value="auto">è‡ªå‹•ï¼ˆç”»é¢ã‚µã‚¤ã‚ºï¼‰</option>
                        <option value="6">6</option>
                        <option value="8">8</option>
                        <option value="10">10</option>
                        <option value="12">12</option>
                        <option value="16">16</option>
                      </select>
                    </div>

                    <div className="mt-3 flex gap-2">
                      <button
                        className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
                          (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
                        disabled={!isLoggedIn||busy}
                        onClick={() => {
                          const s = hhmmToMin(monitorDraft.startHHMM||"08:00");
                          const e = hhmmToMin(monitorDraft.endHHMM||"20:00");
                          if(!(e > s)){
                            setToast({ type:"ng", msg:"çµ‚äº†ã¯é–‹å§‹ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„" });
                            setTimeout(()=>setToast(null), 2200);
                            return;
                          }
                          const next = {
                            startHHMM: monitorDraft.startHHMM || "08:00",
                            endHHMM: monitorDraft.endHHMM || "20:00",
                            autoPage: !!monitorDraft.autoPage,
                            intervalSec: Math.max(5, Math.min(120, Number(monitorDraft.intervalSec||12))),
                            roomsPerPage: String(monitorDraft.roomsPerPage||"auto"),
                          };
                          setMonitorSettings(next);
                          saveMonitorSettingsLocal(next);
                          setToast({ type:"ok", msg:"å…¥å£ãƒ¢ãƒ‹ã‚¿ãƒ¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ" });
                          setTimeout(()=>setToast(null), 1800);
                        }}
                      >
                        ä¿å­˜
                      </button>
                      <button
                        className={classNames("rounded-2xl px-4 py-3 font-black shadow-sm border",
                          busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                        onClick={() => setMonitorDraft(monitorSettings)}
                        disabled={busy}
                      >
                        æˆ»ã™
                      </button>
                    </div>
                  </div>

                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                    <div className="font-black text-slate-800">read/write ã‚«ã‚¦ãƒ³ãƒˆï¼ˆæ¦‚ç®—ï¼‰</div>
                    <div className="text-sm font-bold text-slate-700 mt-2 space-y-1">
                      <div>ãƒ»Firestoreã®å–å¾—(get)ã§ read ã‚’ã€ä¿å­˜(set/add/delete)ã§ write ã‚’<strong>æ¦‚ç®—</strong>åŠ ç®—ã—ã¾ã™ã€‚</div>
                      <div>ãƒ»æ·»ä»˜ã®School Calã¨åŒã˜æ–¹å¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é›†è¨ˆï¼‰ã§ã™ã€‚</div>
                      <div>ãƒ»ãƒã‚¹ã‚¿æ›´æ–°/é€±ãƒ»æœˆãƒ»å¹´åº¦ã®æ›´æ–°ã¯ read ãŒå¢—ãˆã¾ã™ï¼ˆå¿…è¦æ™‚ã ã‘æ›´æ–°æ¨å¥¨ï¼‰ã€‚</div>
                    </div>
                    <div className="mt-3">
                      <button className="px-4 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={resetOps}>ä»Šæœˆã®read/writeã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>

                    <div className="mt-4 font-black text-slate-800">é‹ç”¨ãƒ’ãƒ³ãƒˆ</div>
                    <ul className="mt-2 text-sm font-bold text-slate-700 list-disc pl-5 space-y-1">
                      <li>å…¥å£ãƒ¢ãƒ‹ã‚¿ãƒ¼ã¯ã€Œã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã€æ¨å¥¨ï¼ˆéƒ¨å±‹ãŒå¤šã„ã¨è‡ªå‹•ã§ãƒšãƒ¼ã‚¸é€ã‚Šã—ã¾ã™ï¼‰ã€‚</li>
                      <li>éƒ¨å±‹/æ©Ÿæã¯å‰Šé™¤ã§ã¯ãªãã€Œéè¡¨ç¤ºã€ã§é‹ç”¨ã§ãã¾ã™ã€‚</li>
                      <li>é€±ãƒ»æœˆãƒ»å¹´åº¦ã¯ã€Œæ›´æ–°ã€ã§ã¾ã¨ã‚ã¦å–å¾—ï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰ã€‚</li>
                      <li>ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯åŒä¸€å†…å®¹ãªã‚‰åŒã˜IDã§ä¸Šæ›¸ãï¼ˆé‡è¤‡ã—ã«ãã„æ–¹å¼ï¼‰ã€‚</li>
                    </ul>
                  </div>
                </div>
              </Card>
            )}
          </div>

          <Modal
            open={editorOpen}
            onClose={()=>{ setEditorOpen(false); setEditModel(null); }}
            title={editModel?.id ? "äºˆç´„ã‚’ç·¨é›†" : "äºˆç´„ã‚’è¿½åŠ "}
          >
            {editModel ? (
              <ReservationEditor
                model={editModel}
                setModel={setEditModel}
                roomsActive={roomsActive}
                equipmentsActive={equipmentsActive}
                busy={busy}
                isLoggedIn={isLoggedIn}
                onSave={saveReservation}
                onCancel={()=>{ setEditorOpen(false); setEditModel(null); }}
              />
            ) : null}
          </Modal>\n\n          <Modal\n            open={importOpen}\n            onClose={()=>{ if(!importBusy) setImportOpen(false); }}\n            title="å¹´é–“ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"\n          >\n            <ImportModal\n              open={importOpen}\n              fyInfo={fyInfo}\n              roomsActive={roomsActive}\n              roomsMap={roomsMap}\n              equipmentsActive={equipmentsActive}\n              isLoggedIn={isLoggedIn}\n              importText={importText}\n              setImportText={setImportText}\n              importPreview={importPreview}\n              setImportPreview={setImportPreview}\n              importBusy={importBusy}\n              setImportBusy={setImportBusy}\n              bumpWrites={bumpWrites}\n              bumpReads={bumpReads}\n              setToast={setToast}\n              onDone={async ()=>{ setImportOpen(false); await refreshYear(); }}\n            />\n          </Modal>\n

          {toast ? (
            <div className={classNames(
              "fixed left-1/2 -translate-x-1/2 bottom-4 z-50 px-4 py-3 rounded-3xl shadow-lg border font-black no-print",
              toast.type==="ok" ? "bg-emerald-600 text-white border-emerald-700" : "bg-rose-600 text-white border-rose-700"
            )}>
              {toast.msg}
            </div>
          ) : null}

          <div className="fixed inset-x-0 bottom-0 z-30 bg-white/85 glass border-t border-slate-100 no-print">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
              <div className="text-xs font-bold text-slate-500">â€»ã€Œæ›´æ–°ã€ã§Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¡¨ç¤ºï¼‰</div>
              <div className="text-xs font-bold text-slate-400">å…±é€šIDï¼š{SHARED_LOGIN_CODE}</div>
            </div>
          </div>
        </div>
      );
    }

    /**********************
     * Login
     **********************/
    function LoginButton({busy, onLogin}){
      const [open, setOpen] = useState(false);
      const [pw, setPw] = useState("");

      return (
        <>
          <button
            className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
              busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-slate-900 text-white border-slate-900")}
            disabled={busy}
            onClick={()=>setOpen(true)}
          >
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>

          <Modal open={open} onClose={()=>setOpen(false)} title="å…±é€šIDãƒ­ã‚°ã‚¤ãƒ³">
            <div className="space-y-3">
              <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                <div className="font-black text-slate-800">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
                <div className="text-xs font-bold text-slate-500 mt-1">å…±é€šIDï¼š{SHARED_LOGIN_CODE}</div>
                <input
                  type="password"
                  className="mt-3 w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                  value={pw}
                  onChange={(e)=>setPw(e.target.value)}
                  placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                />
                <div className="mt-3 flex gap-2">
                  <button
                    className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
                      busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
                    disabled={busy}
                    onClick={()=>{ onLogin(pw); setOpen(false); setPw(""); }}
                  >
                    ãƒ­ã‚°ã‚¤ãƒ³
                  </button>
                  <button className="rounded-2xl px-4 py-3 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setOpen(false)}>
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                </div>
              </div>
            </div>
          </Modal>
        </>
      );
    }

    /**********************
     * Reservation Editor
     **********************/
    function ReservationEditor({model, setModel, roomsActive, equipmentsActive, busy, isLoggedIn, onSave, onCancel}){
      const roomGroups = useMemo(() => {
        const g = {};
        for(const r of roomsActive){
          const b = r.building || "ãã®ä»–";
          if(!g[b]) g[b] = [];
          g[b].push(r);
        }
        return g;
      }, [roomsActive]);

      function setField(k,v){ setModel(prev => ({ ...prev, [k]: v })); }
      function setEquip(k,v){
        const n = Math.max(0, Math.min(999, Number(v)||0));
        setModel(prev => ({ ...prev, equipment: { ...(prev.equipment||{}), [k]: n }}));
      }

      const opts10 = useMemo(() => {
        const a = [];
        for(let m=0; m<=23*60+50; m+=10) a.push({ value:m, label:minToHHMM(m) });
        return a;
      }, []);
      const endOpts = opts10.filter(o => o.value >= (Number(model.startMin)||0) + 10);

      return (
        <div className="space-y-4">
          {!isLoggedIn ? (
            <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">
              ç·¨é›†ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼ˆé–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä¿å­˜ã§ãã¾ã›ã‚“ï¼‰
            </div>
          ) : null}

          <div className="grid md:grid-cols-2 gap-3">
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">æ—¥ä»˜</div>
              <input type="date" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.date} onChange={(e)=>setField("date", e.target.value)} />
            </div>
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">éƒ¨å±‹</div>
              <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.roomId} onChange={(e)=>setField("roomId", e.target.value)}>
                {Object.keys(roomGroups).map(b => (
                  <optgroup key={b} label={b}>
                    {roomGroups[b].map(r => (
                      <option key={r.id} value={r.id}>{r.name}</option>
                    ))}
                  </optgroup>
                ))}
              </select>
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-3">
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">é–‹å§‹ï¼ˆ10åˆ†å˜ä½ï¼‰</div>
              <select
                className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                value={model.startMin}
                onChange={(e)=>{
                  const s = Number(e.target.value);
                  const eMin = Number(model.endMin)||0;
                  setField("startMin", s);
                  if(eMin <= s) setField("endMin", s+10);
                }}
              >
                {opts10.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>
            </div>
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">çµ‚äº†ï¼ˆé–‹å§‹ï¼‹10åˆ†ä»¥ä¸Šï¼‰</div>
              <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.endMin} onChange={(e)=>setField("endMin", Number(e.target.value))}>
                {endOpts.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>
            </div>
          </div>

          <div>
            <div className="text-sm font-black text-slate-700 mb-2">å›£ä½“åï¼ˆå¿…é ˆï¼‰</div>
            <input className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.groupName} onChange={(e)=>setField("groupName", e.target.value)} placeholder="ä¾‹ï¼šâ—‹â—‹ç ”ç©¶ä¼šã€â–³â–³ã‚¯ãƒ©ãƒ– ãªã©" />
          </div>

          <div className="grid md:grid-cols-2 gap-3">
            <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">æ©Ÿæ</div>
              <div className="mt-3 space-y-3">
                {equipmentsActive.length === 0 ? (
                  <div className="text-xs font-bold text-slate-400">æ©Ÿæãƒã‚¹ã‚¿ãŒæœªè¨­å®šã§ã™ï¼ˆæ©Ÿæã‚¿ãƒ–ã§è¿½åŠ ï¼‰</div>
                ) : equipmentsActive.map(e => (
                  <div key={e.id} className="flex items-center justify-between gap-2">
                    <div className="font-bold text-slate-700">{e.name}</div>
                    <input type="number" min="0" max="999" className="w-28 text-right rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={model?.equipment?.[e.id] ?? 0} onChange={(ev)=>setEquip(e.id, ev.target.value)} />
                  </div>
                ))}
                <div className="text-xs font-bold text-slate-400">â€»ä¿å­˜å‰ã«ã€ŒåŒæ™‚é–“å¸¯ã§ç·æ•°è¶…éã€ã‚’è­¦å‘Šã—ã¾ã™</div>
              </div>
            </div>

            <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
              <textarea className="mt-3 w-full h-28 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" value={model.note} onChange={(e)=>setField("note", e.target.value)} placeholder="ä¾‹ï¼šæœºé…ç½®ã€æ¥é¤¨æ™‚é–“ã®ç›®å®‰ã€éµã®å—ã‘æ¸¡ã— ãªã©" />
            </div>
          </div>

          <div className="flex items-center gap-2">
            <button
              className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
                (!isLoggedIn || busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
              disabled={!isLoggedIn || busy}
              onClick={()=>onSave(model)}
            >
              ä¿å­˜
            </button>
            <button className="rounded-2xl px-4 py-3 font-black bg-white border border-slate-200 text-slate-700" onClick={onCancel}>
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
        </div>
      );
    }

    /**********************
     * Monitor Board
     **********************/
    function MonitorBoard({dateKey, rooms, reservations, equipmentsActive}){
      const byRoom = useMemo(() => {
        const m = {};
        for(const r of rooms) m[r.id] = [];
        for(const rr of reservations||[]){
          if(!m[rr.roomId]) m[rr.roomId] = [];
          m[rr.roomId].push(rr);
        }
        for(const k of Object.keys(m)) m[k].sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
        return m;
      }, [rooms, reservations]);

      const usedRooms = rooms.filter(r => (byRoom[r.id]||[]).length > 0);

      return (
        <div className="mt-4">
          {usedRooms.length === 0 ? (
            <div className="rounded-3xl border border-slate-100 bg-slate-50 p-6">
              <div className="text-2xl font-black text-slate-800">{dateKey} ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</div>
              <div className="text-sm font-bold text-slate-500 mt-2">â€»æ›´æ–°ãŒå¿…è¦ãªå ´åˆã¯ã€Œæ›´æ–°ã€</div>
            </div>
          ) : (
            <div className="grid lg:grid-cols-2 gap-4">
              {usedRooms.map(room => (
                <div key={room.id} className="rounded-3xl border border-slate-100 bg-white p-5">
                  <div className="flex items-start justify-between gap-2">
                    <div>
                      <div className="text-xs font-black text-slate-400">{room.building}</div>
                      <div className="text-2xl md:text-3xl font-black text-slate-900 mt-1">{room.name}</div>
                    </div>
                    <Pill tone="slate">{(byRoom[room.id]||[]).length}ä»¶</Pill>
                  </div>

                  <div className="mt-4 space-y-3">
                    {(byRoom[room.id]||[]).map(r => (
                      <div key={r.id} className="p-4 rounded-3xl bg-slate-50 border border-slate-100">
                        <div className="text-2xl md:text-3xl font-black text-slate-900">
                          {minToHHMM(r.startMin||0)}â€“{minToHHMM(r.endMin||0)}
                        </div>
                        <div className="text-xl md:text-2xl font-black text-slate-800 mt-1 break-words">{r.groupName}</div>
                        <div className="mt-2 flex flex-wrap gap-2">
                          {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                            <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                          ) : null)}
                          {r.note ? <Pill tone="slate">ãƒ¡ãƒ¢</Pill> : null}
                        </div>
                        {r.note ? <div className="text-sm font-bold text-slate-600 mt-2">{r.note}</div> : null}
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }



    /**********************
     * Month Calendar
     **********************/
    function MonthCalendar({monthKey, reservations, roomsMap, onPickDate}){
      const [y,m] = String(monthKey||"").split("-").map(Number);
      const first = new Date(y, (m||1)-1, 1);
      // Monday-start calendar
      const firstDow = (first.getDay() + 6) % 7; // 0=Mon
      const daysInMonth = new Date(y, (m||1), 0).getDate();
      const prevMonthDays = new Date(y, (m||1)-1, 0).getDate();

      const byDate = useMemo(() => {
        const mp = {};
        for(const r of reservations||[]){
          const dk = r.date;
          if(!mp[dk]) mp[dk] = [];
          mp[dk].push(r);
        }
        for(const k of Object.keys(mp)) mp[k].sort((a,b)=>(Number(a.startMin||0)-Number(b.startMin||0)));
        return mp;
      }, [reservations]);

      const cells = [];
      const total = 42; // 6 weeks
      for(let i=0;i<total;i++){
        const dayNum = i - firstDow + 1;
        let cy=y, cm=m, cd=dayNum, inMonth=true;
        if(dayNum <= 0){
          const pm = addMonthsKey(monthKey, -1);
          const [py,pm2] = pm.split('-').map(Number);
          cy=py; cm=pm2; cd=prevMonthDays + dayNum; inMonth=false;
        }else if(dayNum > daysInMonth){
          const nm = addMonthsKey(monthKey, 1);
          const [ny,nm2] = nm.split('-').map(Number);
          cy=ny; cm=nm2; cd=dayNum - daysInMonth; inMonth=false;
        }
        const dk = dateKeyFromParts(cy, cm, cd);
        cells.push({ dk, inMonth, cd });
      }

      const names = ["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥"];

      return (
        <div className="mt-4">
          <div className="grid grid-cols-7 gap-2">
            {names.map(n => (
              <div key={n} className="text-xs font-black text-slate-500 px-2">{n}</div>
            ))}

            {cells.map(c => {
              const list = byDate[c.dk] || [];
              const isToday = c.dk === todayKeyLocal();
              return (
                <button
                  key={c.dk}
                  className={classNames(
                    "rounded-2xl border p-2 text-left min-h-[98px] hover:bg-slate-50 break-avoid",
                    c.inMonth ? "bg-white border-slate-200" : "bg-slate-50 border-slate-100",
                    isToday ? "ring-2 ring-sky-300" : ""
                  )}
                  onClick={()=>onPickDate(c.dk)}
                >
                  <div className="flex items-center justify-between">
                    <div className={classNames("text-sm font-black", c.inMonth ? "text-slate-900" : "text-slate-400")}>{c.cd}</div>
                    {list.length ? <span className="text-[11px] font-black text-slate-500">{list.length}</span> : null}
                  </div>
                  <div className="mt-1 space-y-1">
                    {list.slice(0,2).map(r => (
                      <div key={r.id} className="text-[11px] font-black text-slate-700 truncate">
                        {minToHHMM(r.startMin||0)} {roomsMap[r.roomId]?.name || r.roomId} / {r.groupName}
                      </div>
                    ))}
                    {list.length>2 ? <div className="text-[11px] font-black text-slate-400">â€¦ã»ã‹ {list.length-2}ä»¶</div> : null}
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    /**********************
     * Year Grouped List
     **********************/
    function YearGroupedList({fyInfo, roomsMap, equipmentsActive, reservations, query, roomFilter, isLoggedIn, onEdit, onJumpDay}){
      const q = (query||"").trim().toLowerCase();
      const filtered = useMemo(() => {
        return (reservations||[]).filter(r => {
          if(roomFilter !== "all" && r.roomId !== roomFilter) return false;
          if(!q) return true;
          const t = `${r.groupName||""} ${r.note||""}`.toLowerCase();
          return t.includes(q);
        });
      }, [reservations, q, roomFilter]);

      const months = useMemo(() => {
        const order = [];
        for(let m=4;m<=12;m++) order.push(`${fyInfo.fy}-${pad2(m)}`);
        for(let m=1;m<=3;m++) order.push(`${fyInfo.fy+1}-${pad2(m)}`);
        const by = {};
        for(const mk of order) by[mk] = [];
        for(const r of filtered){
          const mk = String(r.date||"").slice(0,7);
          if(!by[mk]) by[mk] = [];
          by[mk].push(r);
        }
        for(const mk of Object.keys(by)){
          by[mk].sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || Number(a.startMin||0)-Number(b.startMin||0) || String(a.roomId||"").localeCompare(String(b.roomId||""))));
        }
        return { order, by };
      }, [filtered, fyInfo]);

      return (
        <div className="mt-4 space-y-4 max-h-[65vh] overflow-auto pr-1 no-scrollbar">
          {months.order.map(mk => {
            const list = months.by[mk] || [];
            if(list.length===0) return null;
            return (
              <div key={mk} id={`ym-${mk}`} className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-black text-slate-900">{mk}</div>
                  <Pill tone="slate">{list.length}ä»¶</Pill>
                </div>
                <div className="mt-3 columns-1 md:columns-2 xl:columns-3 gap-3">
                  {list.map(r => (
                    <div key={r.id} className="break-avoid mb-3 rounded-2xl border border-slate-200 bg-white p-3">
                      <div className="font-black text-slate-900">{r.date} {minToHHMM(r.startMin||0)}â€“{minToHHMM(r.endMin||0)}</div>
                      <div className="text-xs font-black text-slate-600 mt-1">{roomsMap[r.roomId]?.building || ""} / {roomsMap[r.roomId]?.name || r.roomId}</div>
                      <div className="text-sm font-black text-slate-800 mt-1 break-words">{r.groupName}</div>
                      {r.note ? <div className="text-xs font-bold text-slate-500 mt-1 break-words">{r.note}</div> : null}
                      <div className="mt-2 flex flex-wrap gap-1">
                        {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                          <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                        ) : null)}
                      </div>
                      <div className="mt-2 flex gap-2 no-print">
                        <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>onJumpDay(r.date)}>æ—¥ã¸</button>
                        {isLoggedIn ? (
                          <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>onEdit(r)}>ç·¨é›†</button>
                        ) : null}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
          {filtered.length===0 ? (
            <div className="text-sm font-bold text-slate-400 p-3">å¹´é–“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã€Œå¹´é–“ã‚’æ›´æ–°ã€ã¾ãŸã¯çµã‚Šè¾¼ã¿æ¡ä»¶ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ï¼‰</div>
          ) : null}
        </div>
      );
    }

    /**********************
     * Monitor Timeline Board
     **********************/
    function MonitorTimelineBoard({dateKey, rooms, reservations, equipmentsActive, startHHMM, endHHMM, autoPage, intervalSec, roomsPerPage}){
      const startMin = hhmmToMin(startHHMM||"08:00");
      const endMin = hhmmToMin(endHHMM||"20:00");
      const range = Math.max(60, endMin - startMin);

      const byRoom = useMemo(() => {
        const m = {};
        for(const r of rooms) m[r.id] = [];
        for(const rr of reservations||[]){
          if(!m[rr.roomId]) m[rr.roomId] = [];
          m[rr.roomId].push(rr);
        }
        for(const k of Object.keys(m)) m[k].sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
        return m;
      }, [rooms, reservations]);

      const usedRooms = useMemo(() => rooms.filter(r => (byRoom[r.id]||[]).length > 0), [rooms, byRoom]);

      const wrapRef = useRef(null);
      const [autoPerPage, setAutoPerPage] = useState(8);
      useEffect(() => {
        if(String(roomsPerPage||"auto") !== "auto") return;
        const calc = () => {
          const h = wrapRef.current?.clientHeight || 600;
          const per = Math.max(4, Math.min(16, Math.floor((h - 64) / 74)));
          setAutoPerPage(per);
        };
        calc();
        window.addEventListener("resize", calc);
        return () => window.removeEventListener("resize", calc);
      }, [roomsPerPage]);

      const perPage = (String(roomsPerPage||"auto") === "auto") ? autoPerPage : Math.max(1, Number(roomsPerPage||autoPerPage));
      const pages = Math.max(1, Math.ceil(usedRooms.length / perPage));
      const [page, setPage] = useState(0);

      useEffect(() => { setPage(0); }, [dateKey, perPage, usedRooms.length]);

      useEffect(() => {
        if(!autoPage || pages<=1) return;
        const ms = Math.max(5, Number(intervalSec||12)) * 1000;
        const t = setInterval(() => setPage(p => (p+1)%pages), ms);
        return () => clearInterval(t);
      }, [autoPage, intervalSec, pages]);

      const pageRooms = usedRooms.slice(page*perPage, (page+1)*perPage);

      const hourTicks = useMemo(() => {
        const ticks = [];
        const startH = Math.ceil(startMin/60);
        const endH = Math.floor(endMin/60);
        for(let h=startH; h<=endH; h++){
          const t = h*60;
          if(t>=startMin && t<=endMin) ticks.push(t);
        }
        return ticks;
      }, [startMin, endMin]);

      const leftW = 220;

      return (
        <div className="mt-4 rounded-3xl border border-slate-100 bg-white overflow-hidden" style={{height:"calc(100vh - 280px)", minHeight:480}}>
          <div className="h-full flex flex-col" ref={wrapRef}>
            <div className="flex items-center justify-between px-4 py-3 border-b border-slate-100 bg-slate-50">
              <div className="font-black text-slate-800">{dateKey} / äºˆç´„ã®ã‚ã‚‹éƒ¨å±‹ã®ã¿è¡¨ç¤º</div>
              <div className="flex items-center gap-2">
                {pages>1 ? (
                  <div className="text-xs font-black text-slate-600">{page+1}/{pages}</div>
                ) : null}
                {pages>1 ? (
                  <>
                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setPage(p=> (p-1+pages)%pages)}>å‰</button>
                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setPage(p=> (p+1)%pages)}>æ¬¡</button>
                  </>
                ) : null}
              </div>
            </div>

            {usedRooms.length===0 ? (
              <div className="p-6 text-sm font-bold text-slate-500">ã“ã®æ—¥ã¯äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
            ) : (
              <div className="flex-1 overflow-hidden">
                <div className="h-full grid" style={{gridTemplateColumns:`${leftW}px 1fr`}}>
                  <div className="px-3 py-2 border-b border-slate-100 bg-white font-black text-slate-600">éƒ¨å±‹</div>
                  <div className="px-3 py-2 border-b border-slate-100 bg-white relative">
                    <div className="relative h-8">
                      {hourTicks.map(t => {
                        const x = ((t-startMin)/range)*100;
                        return (
                          <div key={t} className="absolute top-0 bottom-0" style={{left:`${x}%`}}>
                            <div className="w-px h-full bg-slate-200"></div>
                            <div className="text-[10px] font-black text-slate-500 -translate-x-1/2 mt-1">{minToHHMM(t)}</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {pageRooms.map(room => {
                    const list = byRoom[room.id] || [];
                    return (
                      <React.Fragment key={room.id}>
                        <div className="px-3 py-3 border-b border-slate-100 bg-white">
                          <div className="text-xs font-black text-slate-500">{room.building}</div>
                          <div className="font-black text-slate-800">{room.name}</div>
                        </div>
                        <div className="px-3 py-2 border-b border-slate-100 bg-white relative">
                          <div className="relative h-14 rounded-2xl bg-slate-50 border border-slate-100 overflow-hidden">
                            {hourTicks.map(t => {
                              const x = ((t-startMin)/range)*100;
                              return <div key={t} className="absolute top-0 bottom-0" style={{left:`${x}%`}}><div className="w-px h-full bg-slate-200"></div></div>;
                            })}
                            {list.map(r => {
                              const s = Math.max(startMin, Number(r.startMin||0));
                              const e = Math.min(endMin, Number(r.endMin||0));
                              const left = ((s-startMin)/range)*100;
                              const width = Math.max(1, ((e-s)/range)*100);
                              const eqBadges = equipmentsActive
                                .filter(e0 => Number(r?.equipment?.[e0.id]||0)>0)
                                .slice(0,3)
                                .map(e0 => `${e0.abbr||e0.name}${Number(r.equipment[e0.id]||0)}`)
                                .join(" ");
                              return (
                                <div
                                  key={r.id}
                                  className="absolute top-2 bottom-2 rounded-xl bg-sky-600/90 text-white px-2 flex items-center"
                                  style={{left:`${left}%`, width:`${width}%`}}
                                  title={`${minToHHMM(r.startMin||0)}-${minToHHMM(r.endMin||0)} ${r.groupName}`}
                                >
                                  <div className="min-w-0">
                                    <div className="text-[11px] font-black truncate">{r.groupName}</div>
                                    <div className="text-[10px] font-black text-white/90 truncate">{minToHHMM(r.startMin||0)}â€“{minToHHMM(r.endMin||0)}{eqBadges ? ` / ${eqBadges}` : ""}</div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </React.Fragment>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    /**********************
     * Import Modal (bulk import)
     **********************/
    function ImportModal({open, fyInfo, roomsActive, roomsMap, equipmentsActive, isLoggedIn, importText, setImportText, importPreview, setImportPreview, importBusy, setImportBusy, bumpWrites, bumpReads, setToast, onDone}){
      const templateHeaders = useMemo(() => {
        const base = ["æ—¥ä»˜","é–‹å§‹","çµ‚äº†","éƒ¨å±‹","å›£ä½“å","ãƒ¡ãƒ¢"];
        const eq = equipmentsActive.map(e => e.abbr || e.id);
        return base.concat(eq);
      }, [equipmentsActive]);

      const roomIndex = useMemo(() => {
        const idx = {};
        for(const r of roomsActive||[]){
          idx[String(r.id).toLowerCase()] = r.id;
          idx[String(r.name).toLowerCase()] = r.id;
          idx[`${String(r.building||"")}/${String(r.name||"")}`.toLowerCase()] = r.id;
          idx[`${String(r.building||"")} ${String(r.name||"")}`.toLowerCase()] = r.id;
        }
        return idx;
      }, [roomsActive]);

      const eqIndex = useMemo(() => {
        const idx = {};
        for(const e of equipmentsActive||[]){
          idx[String(e.id).toLowerCase()] = e.id;
          if(e.abbr) idx[String(e.abbr).toLowerCase()] = e.id;
          idx[String(e.name).toLowerCase()] = e.id;
        }
        return idx;
      }, [equipmentsActive]);

      const detectDelimiter = (firstLine) => (String(firstLine||"").includes("\t") ? "\t" : ",");

      const splitLine = (line, delim) => {
        const s = String(line||"");
        if(delim === "\t") return s.split("\t");
        // basic CSV (supports quotes)
        const res = [];
        let cur = "";
        let inQ = false;
        for(let i=0;i<s.length;i++){
          const ch = s[i];
          if(ch === '"'){
            if(inQ && s[i+1] === '"'){ cur += '"'; i++; }
            else inQ = !inQ;
          } else if(ch === ',' && !inQ){
            res.push(cur);
            cur = "";
          } else {
            cur += ch;
          }
        }
        res.push(cur);
        return res;
      };

      const norm = (v) => String(v ?? "").trim();
      const normKey = (v) => norm(v).toLowerCase().replace(/\s/g, "");

      const makeHeaderIndex = (headers) => {
        const hs = headers.map(normKey);
        const find = (keys) => {
          for(const k of keys){
            const i = hs.indexOf(k);
            if(i>=0) return i;
          }
          return -1;
        };
        const map = {
          date: find(["æ—¥ä»˜","date","å¹´æœˆæ—¥","ymd" ]),
          start: find(["é–‹å§‹","start","starttime","é–‹å§‹æ™‚åˆ»","é–‹å§‹æ™‚é–“" ]),
          end: find(["çµ‚äº†","end","endtime","çµ‚äº†æ™‚åˆ»","çµ‚äº†æ™‚é–“" ]),
          room: find(["éƒ¨å±‹","å ´æ‰€","room","roomid","roomname" ]),
          group: find(["å›£ä½“å","äºˆç´„å","å›£ä½“","title","name","group","åˆ©ç”¨è€…" ]),
          note: find(["ãƒ¡ãƒ¢","å‚™è€ƒ","note","notes" ])
        };
        const eqCols = {}; // colIndex -> equipmentId
        headers.forEach((h, i) => {
          const k = normKey(h);
          if(eqIndex[k]) eqCols[i] = eqIndex[k];
        });
        return {map, eqCols};
      };

      const [showSample, setShowSample] = useState(false);

      const buildPreview = () => {
        const raw = String(importText||"").trim();
        if(!raw){
          setImportPreview(null);
          return;
        }
        const lines = raw.split(/\r?\n/).filter(l => String(l||"").trim() !== "");
        if(lines.length === 0){
          setImportPreview(null);
          return;
        }
        const delim = detectDelimiter(lines[0]);
        const first = splitLine(lines[0], delim);
        const headerLike = first.some(c => /æ—¥ä»˜|date/i.test(String(c||"")));
        const headers = headerLike ? first : templateHeaders;
        const startIdx = headerLike ? 1 : 0;
        const {map, eqCols} = makeHeaderIndex(headers);

        const rows = [];
        const addRow = (obj) => rows.push(obj);

        for(let i=startIdx;i<lines.length;i++){
          const cells = splitLine(lines[i], delim);
          const get = (idx) => (idx>=0 && idx<cells.length) ? norm(cells[idx]) : "";
          const errors = [];
          const warns = [];

          const dateRaw = get(map.date);
          const startRaw = get(map.start);
          const endRaw = get(map.end);
          const roomRaw = get(map.room);
          const groupRaw = get(map.group);
          const noteRaw = get(map.note);

          const dk = parseDateLooseToKey(dateRaw);
          if(!dk) errors.push(`æ—¥ä»˜ãŒèª­ã‚ã¾ã›ã‚“: ${dateRaw}`);
          const sMin = parseHHMMLoose(startRaw);
          const eMin = parseHHMMLoose(endRaw);
          if(sMin==null) errors.push(`é–‹å§‹ãŒèª­ã‚ã¾ã›ã‚“: ${startRaw}`);
          if(eMin==null) errors.push(`çµ‚äº†ãŒèª­ã‚ã¾ã›ã‚“: ${endRaw}`);
          if(sMin!=null && eMin!=null && eMin <= sMin) errors.push(`çµ‚äº†<=é–‹å§‹ (${startRaw}ã€œ${endRaw})`);

          let roomId = "";
          const rk = normKey(roomRaw);
          if(rk && roomIndex[rk]) roomId = roomIndex[rk];
          if(!roomId) errors.push(`éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${roomRaw}`);

          if(!groupRaw) errors.push("å›£ä½“åãŒç©ºã§ã™");

          // fiscal-year guard (warn and skip)
          let skip = false;
          if(dk && (dk < fyInfo.start || dk > fyInfo.end)){
            warns.push(`å¹´åº¦å¤–ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—: ${dk}`);
            skip = true;
          }

          const equipment = {};
          for(const [col, eid] of Object.entries(eqCols)){
            const v = get(Number(col));
            if(v === "") continue;
            const n = Number(String(v).replace(/[^0-9.-]/g, ""));
            if(Number.isFinite(n) && n>0) equipment[eid] = Math.floor(n);
            else if(v) errors.push(`æ©Ÿæ(${headers[Number(col)]})ãŒæ•°å€¤ã§ã‚ã‚Šã¾ã›ã‚“: ${v}`);
          }

          const model = (errors.length===0 && !skip) ? {
            date: dk,
            roomId,
            startMin: sMin,
            endMin: eMin,
            groupName: groupRaw,
            note: noteRaw,
            equipment,
            updatedAt: serverTimestamp(),
          } : null;

          addRow({ line: i+1, raw: lines[i], errors, warns, skip, model });
        }

        // overlap check inside import set
        const buckets = {};
        rows.forEach((r, idx) => {
          if(!r.model) return;
          const key = `${r.model.date}|${r.model.roomId}`;
          if(!buckets[key]) buckets[key] = [];
          buckets[key].push({idx, r});
        });
        Object.values(buckets).forEach(arr => {
          arr.sort((a,b)=>a.r.model.startMin - b.r.model.startMin);
          for(let i=1;i<arr.length;i++){
            const prev = arr[i-1].r.model;
            const cur = arr[i].r.model;
            if(cur.startMin < prev.endMin){
              arr[i].r.errors.push("åŒã˜éƒ¨å±‹ã§æ™‚é–“ãŒé‡ãªã£ã¦ã„ã¾ã™ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆå†…ï¼‰");
              arr[i-1].r.errors.push("åŒã˜éƒ¨å±‹ã§æ™‚é–“ãŒé‡ãªã£ã¦ã„ã¾ã™ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆå†…ï¼‰");
              arr[i].r.model = null;
              arr[i-1].r.model = null;
            }
          }
        });

        const ok = rows.filter(r => r.model && r.errors.length===0 && !r.skip).length;
        const ng = rows.filter(r => r.errors.length>0).length;
        const skipped = rows.filter(r => r.skip).length;
        setImportPreview({ headers, rows, ok, ng, skipped });
      };

      const runImport = async () => {
        if(!isLoggedIn){
          setToast({type:"ng", msg:"ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™"});
          setTimeout(()=>setToast(null), 2500);
          return;
        }
        const rows = importPreview?.rows || [];
        const valids = rows.filter(r => r.model && r.errors.length===0 && !r.skip);
        if(valids.length===0){
          setToast({type:"ng", msg:"ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹è¡ŒãŒã‚ã‚Šã¾ã›ã‚“"});
          setTimeout(()=>setToast(null), 2500);
          return;
        }
        setImportBusy(true);
        try{
          const CHUNK = 420;
          for(let i=0;i<valids.length;i+=CHUNK){
            const slice = valids.slice(i, i+CHUNK);
            const batch = db.batch();
            slice.forEach(row => {
              const m = row.model;
              const id = deterministicIdForReservation(m);
              const ref = db.collection("reservations").doc(id);
              const payload = {
                date: m.date,
                roomId: m.roomId,
                startMin: m.startMin,
                endMin: m.endMin,
                groupName: m.groupName,
                note: m.note,
                equipment: m.equipment,
                updatedAt: serverTimestamp(),
              };
              batch.set(ref, payload, {merge:true});
            });
            await batch.commit();
            bumpWrites(slice.length);
          }
          setToast({type:"ok", msg:`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼š${valids.length}ä»¶ï¼ˆå¹´åº¦ï¼š${fyInfo.label}ï¼‰`});
          setTimeout(()=>setToast(null), 3500);
          setImportPreview(null);
          // keep text for re-run; user can clear manually
          await onDone?.();
        }catch(e){
          console.error(e);
          setToast({type:"ng", msg:"ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"});
          setTimeout(()=>setToast(null), 3500);
        }finally{
          setImportBusy(false);
        }
      };

      const sampleText = useMemo(() => {
        const header = templateHeaders.join("\t");
        const room = (roomsActive && roomsActive[0]) ? roomsActive[0].name : "ä¼šè­°å®¤";
        const line1 = `${fyInfo.fy}-04-10\t09:00\t10:00\t${room}\tè·å“¡ä¼šè­°\t\t1`;
        return `${header}\n${line1}`;
      }, [templateHeaders, fyInfo, roomsActive]);

      return (
        <div className="space-y-3">
          <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
            <div className="font-black text-slate-800">è²¼ã‚Šä»˜ã‘å½¢å¼ï¼ˆExcelã‹ã‚‰ã®è²¼ã‚Šä»˜ã‘æ¨å¥¨ï¼‰</div>
            <div className="text-sm font-bold text-slate-700 mt-2 space-y-1">
              <div>ãƒ»1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€ãƒ¼æ¨å¥¨ï¼š{templateHeaders.slice(0,6).join(" / ")} ...</div>
              <div>ãƒ»åŒºåˆ‡ã‚Šã¯ <strong>ã‚¿ãƒ–</strong>ï¼ˆTSVï¼‰ã‹ã‚«ãƒ³ãƒï¼ˆCSVï¼‰ã€‚</div>
              <div>ãƒ»éƒ¨å±‹ã¯ã€Œåå‰ã€ã‹ã€Œå»ºç‰©/åå‰ã€ã§ã‚‚OKã€‚</div>
              <div>ãƒ»æ©Ÿæã¯åˆ—åã‚’ <strong>ç•¥ç§°</strong> ã¾ãŸã¯ æ©ŸæID ã«ã™ã‚‹ã¨èªè­˜ã—ã¾ã™ã€‚</div>
              <div className="text-slate-500">â€»å¹´åº¦å¤–ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè­¦å‘Šï¼‰ã«ãªã‚Šã¾ã™ã€‚</div>
            </div>
            <div className="mt-3 flex items-center gap-2">
              <button className="px-4 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setShowSample(s=>!s)}>ãƒ†ãƒ³ãƒ—ãƒ¬/ä¾‹ã‚’{showSample?"é–‰ã˜ã‚‹":"è¡¨ç¤º"}</button>
              {isLoggedIn ? (
                <button className="px-4 py-2 rounded-2xl bg-slate-900 text-white font-black disabled:opacity-50" disabled={importBusy} onClick={buildPreview}>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆ</button>
              ) : (
                <Pill tone="rose">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿æ“ä½œå¯</Pill>
              )}
              {isLoggedIn ? (
                <button className="px-4 py-2 rounded-2xl bg-sky-600 text-white font-black disabled:opacity-50" disabled={importBusy || !(importPreview?.ok>0)} onClick={runImport}>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
              ) : null}
            </div>
            {showSample ? (
              <div className="mt-3">
                <div className="text-xs font-black text-slate-500">ã‚³ãƒ”ãƒšç”¨ï¼ˆTSVï¼‰</div>
                <pre className="mt-2 text-xs font-mono bg-white border border-slate-200 rounded-2xl p-3 overflow-auto">{sampleText}</pre>
              </div>
            ) : null}
          </div>

          <textarea
            value={importText}
            onChange={(e)=>setImportText(e.target.value)}
            placeholder={"ã“ã“ã«å¹´é–“åˆ†ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆTSV/CSVï¼‰"}
            className="w-full min-h-[220px] rounded-3xl border border-slate-200 bg-white p-4 font-mono text-sm"
            spellCheck={false}
            disabled={!isLoggedIn || importBusy}
          />

          {importPreview ? (
            <div className="rounded-3xl border border-slate-100 bg-white p-4">
              <div className="flex items-center justify-between gap-2 flex-wrap">
                <div className="font-black text-slate-800">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                <div className="flex gap-2">
                  <Pill tone="emerald">OK {importPreview.ok}</Pill>
                  <Pill tone="rose">NG {importPreview.ng}</Pill>
                  <Pill tone="slate">SKIP {importPreview.skipped}</Pill>
                </div>
              </div>
              <div className="mt-3 max-h-[45vh] overflow-auto pr-1">
                {importPreview.rows.slice(0, 60).map((r, idx) => (
                  <div key={idx} className={classNames(
                    "rounded-2xl border p-3 mb-2",
                    r.model ? "border-emerald-200 bg-emerald-50" : (r.skip ? "border-slate-200 bg-slate-50" : "border-rose-200 bg-rose-50")
                  )}>
                    <div className="text-xs font-black text-slate-600">{r.line}è¡Œç›®</div>
                    <div className="text-sm font-bold text-slate-800 break-words mt-1">{r.raw}</div>
                    {r.errors.length ? (
                      <div className="text-xs font-black text-rose-700 mt-2">{r.errors.join(" / ")}</div>
                    ) : null}
                    {(!r.errors.length && r.warns.length) ? (
                      <div className="text-xs font-black text-slate-600 mt-2">{r.warns.join(" / ")}</div>
                    ) : null}
                  </div>
                ))}
                {importPreview.rows.length>60 ? (
                  <div className="text-xs font-bold text-slate-400">â€¦æ®‹ã‚Š {importPreview.rows.length-60} è¡Œï¼ˆè¡¨ç¤ºã¯æœ€å¤§60è¡Œï¼‰</div>
                ) : null}
              </div>
            </div>
          ) : null}
        </div>
      );
    }
    /**********************
     * Room Manager
     **********************/
    function RoomManager({rooms, setRooms, isLoggedIn, busy, onSaved, bumpReads, bumpWrites}){
      const [draft, setDraft] = useState({ id:"", building:"æœ¬é¤¨", name:"", order: 100, active:true });

      const sorted = useMemo(() =>
        (rooms||[]).slice().sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.building||"").localeCompare(String(b.building||"")) || String(a.name||"").localeCompare(String(b.name||"")))
      , [rooms]);

      async function saveOne(r){
        if(!isLoggedIn) return;
        if(!r.id) return alert("idãŒå¿…è¦ã§ã™");
        const payload = {
          name: (r.name||"").trim(),
          building: (r.building||"").trim(),
          order: Number(r.order||0),
          active: r.active !== false,
          updatedAt: serverTimestamp(),
        };
        await db.collection("rooms").doc(r.id).set(payload, { merge:true });
        bumpWrites(1);
        onSaved();
      }

      async function addNew(){
        if(!isLoggedIn) return;
        const id = (draft.id||"").trim();
        const name = (draft.name||"").trim();
        if(!id || !name) return alert("id ã¨ éƒ¨å±‹åãŒå¿…è¦ã§ã™");
        const ref = db.collection("rooms").doc(id);
        const snap = await ref.get();
        bumpReads(1);
        if(snap.exists){
          alert("åŒã˜idãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼ˆåˆ¥ã®idã«ã—ã¦ãã ã•ã„ï¼‰");
          return;
        }
        await ref.set({
          name,
          building: (draft.building||"").trim(),
          order: Number(draft.order||0),
          active: draft.active !== false,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }, { merge:true });
        bumpWrites(1);
        setDraft({ id:"", building: draft.building || "æœ¬é¤¨", name:"", order: Number(draft.order||100), active:true });
        onSaved();
      }

      function updateLocal(id, patch){
        setRooms(prev => (prev||[]).map(r => r.id===id ? ({...r, ...patch}) : r));
      }

      return (
        <div className="space-y-4">
          <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
            <div className="font-black text-slate-800">éƒ¨å±‹ã‚’è¿½åŠ </div>
            <div className="mt-3 grid md:grid-cols-5 gap-2">
              <input className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="idï¼ˆä¾‹ï¼šhonkan_3fï¼‰" value={draft.id} onChange={(e)=>setDraft(d=>({...d, id:e.target.value}))} disabled={!isLoggedIn||busy} />
              <select className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" value={draft.building} onChange={(e)=>setDraft(d=>({...d, building:e.target.value}))} disabled={!isLoggedIn||busy}>
                <option value="æœ¬é¤¨">æœ¬é¤¨</option>
                <option value="åˆ¥é¤¨">åˆ¥é¤¨</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
              </select>
              <input className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="éƒ¨å±‹å" value={draft.name} onChange={(e)=>setDraft(d=>({...d, name:e.target.value}))} disabled={!isLoggedIn||busy} />
              <input type="number" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="order" value={draft.order} onChange={(e)=>setDraft(d=>({...d, order:e.target.value}))} disabled={!isLoggedIn||busy} />
              <button className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")} onClick={addNew} disabled={!isLoggedIn||busy}>
                è¿½åŠ 
              </button>
            </div>
            <div className="mt-2 text-xs font-bold text-slate-400">â€»å‰Šé™¤ã§ã¯ãªãã€Œactive=falseã€ã§éè¡¨ç¤ºé‹ç”¨</div>
          </div>

          <div className="rounded-3xl border border-slate-100 bg-white p-3 overflow-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left text-xs font-black text-slate-500">
                  <th className="p-2">è¡¨ç¤º</th>
                  <th className="p-2">id</th>
                  <th className="p-2">å»ºç‰©</th>
                  <th className="p-2">éƒ¨å±‹å</th>
                  <th className="p-2">order</th>
                  <th className="p-2">ä¿å­˜</th>
                </tr>
              </thead>
              <tbody>
                {sorted.map(r => (
                  <tr key={r.id} className="border-t border-slate-100">
                    <td className="p-2">
                      <input type="checkbox" checked={r.active !== false} onChange={(e)=>updateLocal(r.id,{active:e.target.checked})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2 font-mono text-xs text-slate-600">{r.id}</td>
                    <td className="p-2">
                      <select className="rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={r.building||""} onChange={(e)=>updateLocal(r.id,{building:e.target.value})} disabled={!isLoggedIn||busy}>
                        <option value="æœ¬é¤¨">æœ¬é¤¨</option>
                        <option value="åˆ¥é¤¨">åˆ¥é¤¨</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                      </select>
                    </td>
                    <td className="p-2">
                      <input className="w-full rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={r.name||""} onChange={(e)=>updateLocal(r.id,{name:e.target.value})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <input type="number" className="w-24 rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={Number(r.order||0)} onChange={(e)=>updateLocal(r.id,{order:Number(e.target.value||0)})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <button className={classNames("px-3 py-2 rounded-2xl font-black border",
                        (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-slate-900 text-white border-slate-900")} onClick={()=>saveOne(r)} disabled={!isLoggedIn||busy}>
                        ä¿å­˜
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    /**********************
     * Equipment Manager
     **********************/
    function EquipmentManager({equipments, setEquipments, isLoggedIn, busy, onSaved, bumpReads, bumpWrites}){
      const [draft, setDraft] = useState({ id:"", name:"", abbr:"", countTotal: 0, order: 100, active:true });

      const sorted = useMemo(() =>
        (equipments||[]).slice().sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.name||"").localeCompare(String(b.name||"")))
      , [equipments]);

      function updateLocal(id, patch){
        setEquipments(prev => (prev||[]).map(e => e.id===id ? ({...e, ...patch}) : e));
      }

      async function saveOne(e){
        if(!isLoggedIn) return;
        if(!e.id) return alert("idãŒå¿…è¦ã§ã™");
        const payload = {
          name: (e.name||"").trim(),
          abbr: (e.abbr||"").trim(),
          countTotal: Number(e.countTotal||0),
          order: Number(e.order||0),
          active: e.active !== false,
          updatedAt: serverTimestamp(),
        };
        await db.collection("equipments").doc(e.id).set(payload, { merge:true });
        bumpWrites(1);
        onSaved();
      }

      async function addNew(){
        if(!isLoggedIn) return;
        const id = (draft.id||"").trim();
        const name = (draft.name||"").trim();
        if(!id || !name) return alert("id ã¨ æ©ŸæåãŒå¿…è¦ã§ã™");
        const ref = db.collection("equipments").doc(id);
        const snap = await ref.get();
        bumpReads(1);
        if(snap.exists){
          alert("åŒã˜idãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼ˆåˆ¥ã®idã«ã—ã¦ãã ã•ã„ï¼‰");
          return;
        }
        await ref.set({
          name,
          abbr: (draft.abbr||"").trim(),
          countTotal: Number(draft.countTotal||0),
          order: Number(draft.order||0),
          active: draft.active !== false,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }, { merge:true });
        bumpWrites(1);
        setDraft({ id:"", name:"", abbr:"", countTotal: 0, order: Number(draft.order||100), active:true });
        onSaved();
      }

      return (
        <div className="space-y-4">
          <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
            <div className="font-black text-slate-800">æ©Ÿæã‚’è¿½åŠ </div>
            <div className="mt-3 grid md:grid-cols-6 gap-2">
              <input className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="idï¼ˆä¾‹ï¼šmicï¼‰" value={draft.id} onChange={(e)=>setDraft(d=>({...d, id:e.target.value}))} disabled={!isLoggedIn||busy} />
              <input className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="æ©Ÿæå" value={draft.name} onChange={(e)=>setDraft(d=>({...d, name:e.target.value}))} disabled={!isLoggedIn||busy} />
              <input className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="ç•¥ç§°ï¼ˆä»»æ„ï¼‰" value={draft.abbr} onChange={(e)=>setDraft(d=>({...d, abbr:e.target.value}))} disabled={!isLoggedIn||busy} />
              <input type="number" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="ç·æ•°" value={draft.countTotal} onChange={(e)=>setDraft(d=>({...d, countTotal:e.target.value}))} disabled={!isLoggedIn||busy} />
              <input type="number" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="order" value={draft.order} onChange={(e)=>setDraft(d=>({...d, order:e.target.value}))} disabled={!isLoggedIn||busy} />
              <button className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")} onClick={addNew} disabled={!isLoggedIn||busy}>
                è¿½åŠ 
              </button>
            </div>
            <div className="mt-2 text-xs font-bold text-slate-400">â€»ç·æ•°ãŒ0ã®ã¨ãã¯ã€Œè¶…éè­¦å‘Šãªã—ã€ã¨ã—ã¦æ‰±ã„ã¾ã™ï¼ˆé‹ç”¨ã«åˆã‚ã›ã¦è¨­å®šï¼‰</div>
          </div>

          <div className="rounded-3xl border border-slate-100 bg-white p-3 overflow-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left text-xs font-black text-slate-500">
                  <th className="p-2">è¡¨ç¤º</th>
                  <th className="p-2">id</th>
                  <th className="p-2">æ©Ÿæå</th>
                  <th className="p-2">ç•¥ç§°</th>
                  <th className="p-2">ç·æ•°</th>
                  <th className="p-2">order</th>
                  <th className="p-2">ä¿å­˜</th>
                </tr>
              </thead>
              <tbody>
                {sorted.map(e => (
                  <tr key={e.id} className="border-t border-slate-100">
                    <td className="p-2">
                      <input type="checkbox" checked={e.active !== false} onChange={(ev)=>updateLocal(e.id,{active:ev.target.checked})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2 font-mono text-xs text-slate-600">{e.id}</td>
                    <td className="p-2">
                      <input className="w-full rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={e.name||""} onChange={(ev)=>updateLocal(e.id,{name:ev.target.value})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <input className="w-20 rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={e.abbr||""} onChange={(ev)=>updateLocal(e.id,{abbr:ev.target.value})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <input type="number" className="w-24 rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={Number(e.countTotal||0)} onChange={(ev)=>updateLocal(e.id,{countTotal:Number(ev.target.value||0)})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <input type="number" className="w-24 rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={Number(e.order||0)} onChange={(ev)=>updateLocal(e.id,{order:Number(ev.target.value||0)})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <button className={classNames("px-3 py-2 rounded-2xl font-black border",
                        (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-slate-900 text-white border-slate-900")} onClick={()=>saveOne(e)} disabled={!isLoggedIn||busy}>
                        ä¿å­˜
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    /**********************
     * Mount
     **********************/
    ReactDOM.createRoot(document.getElementById("app")).render(<App />);
  </script>
</body>
</html>
