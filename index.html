<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Â§∑ÈöÖÊïôËÇ≤‰ºöÈ§® ÁÆ°ÁêÜÔºàÈÉ®Â±ã‰∫àÁ¥Ñ„ÉªÊ©üÊùê„ÉªÂÖ•Âè£„É¢„Éã„Çø„ÉºÔºâ</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (UMD) + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (CDN / compat) -->
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }

    @media print {
      @page { size: A4 landscape; margin: 10mm; }
      body { background: #fff !important; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      .print-card { break-inside: avoid; page-break-inside: avoid; }
      .print-tight { font-size: 11px; }
    }
    .print-only { display: none; }
    .break-avoid { break-inside: avoid; page-break-inside: avoid; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div id="app"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /**********************
     * Âõ∫ÂÆöË®≠ÂÆö
     **********************/
    const SHARED_LOGIN_CODE = "ismkaikan";
    const SHARED_EMAIL = `${SHARED_LOGIN_CODE}@shared.local`;
    const CACHE_PREFIX = "ismkaikan_cache_v4";
    const OPS_KEY = "ismkaikan_ops_v1";

    /**********************
     * Firebase ÂàùÊúüÂåñÔºàÊ∑ª‰ªò„Éï„Ç°„Ç§„É´„ÅÆË®≠ÂÆö„ÇíË∏èË•≤Ôºâ
     **********************/
    const firebaseConfig = {
      apiKey: "AIzaSyAfO6ZAOlAZg-yG8ja3fR3U-zEnqMwmpw8",
      authDomain: "ism2711-49523.firebaseapp.com",
      projectId: "ism2711-49523",
      storageBucket: "ism2711-49523.firebasestorage.app",
      messagingSenderId: "44334771941",
      appId: "1:44334771941:web:a55badc93b3f6bdf59ee0c",
      measurementId: "G-M4SWCYYH82"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

    /**********************
     * Êó¢ÂÆöÔºàÂàùÊúü„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
     * ‚ÄªFirestore„Å´ rooms / equipments „Åå„ÅÇ„ÇãÂâçÊèê„Å†„Åå„ÄÅÁ©∫„ÅÆ„Å®„Åç„ÅÆ‰øùÈô∫
     **********************/
    const DEFAULT_ROOMS = [
      { id: "honkan_oo", name: "Â§ß‰ºöË≠∞ÂÆ§", building: "Êú¨È§®", active: true, order: 10 },
      { id: "honkan_chu", name: "‰∏≠‰ºöË≠∞ÂÆ§", building: "Êú¨È§®", active: true, order: 20 },
      { id: "honkan_sho", name: "Â∞è‰ºöË≠∞ÂÆ§", building: "Êú¨È§®", active: true, order: 30 },
      { id: "honkan_ousetsu", name: "ÂøúÊé•ÂÆ§", building: "Êú¨È§®", active: true, order: 40 },
      { id: "honkan_nihon", name: "Êó•Êú¨Èñì", building: "Êú¨È§®", active: true, order: 50 },
      { id: "honkan_print", name: "Âç∞Âà∑ÂÆ§", building: "Êú¨È§®", active: true, order: 60 },
      { id: "honkan_library", name: "Âõ≥Êõ∏ÂÆ§", building: "Êú¨È§®", active: true, order: 70 },
      { id: "honkan_lab", name: "Á†îÁ©∂ÊâÄ", building: "Êú¨È§®", active: true, order: 80 },
      { id: "bekkan_1f", name: "ÔºëÈöé‰ºöË≠∞ÂÆ§", building: "Âà•È§®", active: true, order: 110 },
      { id: "bekkan_2f", name: "ÔºíÈöé‰ºöË≠∞ÂÆ§", building: "Âà•È§®", active: true, order: 120 },
    ];

    const DEFAULT_EQUIPMENTS = [
      { id: "projector", name: "„Éó„É≠„Ç∏„Çß„ÇØ„Çø„Éº", abbr: "PJ", countTotal: 3, active: true, order: 10 },
      { id: "pc", name: "PC", abbr: "PC", countTotal: 10, active: true, order: 20 },
    ];

    /**********************
     * utils
     **********************/
    const pad2 = (n) => String(n).padStart(2, "0");
    const monthKeyLocal = (d = new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    const todayKeyLocal = (d = new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const parseKeyToDate = (key) => {
      const [y,m,d] = key.split("-").map(Number);
      return new Date(y, m-1, d);
    };
    const addDaysKey = (key, add) => {
      const dt = parseKeyToDate(key);
      dt.setDate(dt.getDate()+add);
      return todayKeyLocal(dt);
    };
    const startOfWeekMonday = (key) => {
      const dt = parseKeyToDate(key);
      const dow = dt.getDay();
      const diff = (dow === 0) ? -6 : (1 - dow);
      dt.setDate(dt.getDate()+diff);
      return todayKeyLocal(dt);
    };
    const hhmmToMin = (hhmm) => {
      const [h,m] = hhmm.split(":").map(Number);
      return h*60+m;
    };
    const minToHHMM = (min) => `${pad2(Math.floor(min/60))}:${pad2(min%60)}`;
    const overlaps = (aS,aE,bS,bE) => (aS < bE) && (bS < aE);
    const isValidDateKey = (k) => /^\d{4}-\d{2}-\d{2}$/.test(k);

    // --- month helpers
    const monthKeyFromDateKey = (k) => String(k || "").slice(0,7);
    const dateKeyFromParts = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`;
    const startOfMonthKey = (monthKey) => `${monthKey}-01`;
    const endOfMonthKey = (monthKey) => {
      const parts = String(monthKey || "").split("-");
      const y = Number(parts[0]);
      const m = Number(parts[1]);
      if(!Number.isFinite(y) || !Number.isFinite(m)) return `${monthKey}-28`;
      const last = new Date(y, m, 0).getDate();
      return dateKeyFromParts(y, m, last);
    };
    const addMonthsKey = (monthKey, add) => {
      const parts = String(monthKey || "").split("-");
      const y0 = Number(parts[0]);
      const m0 = Number(parts[1]);
      const dt = new Date(Number.isFinite(y0) ? y0 : new Date().getFullYear(), (Number.isFinite(m0)?m0:1)-1, 1);
      dt.setMonth(dt.getMonth() + Number(add||0));
      return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}`;
    };

    // --- loose parsers (for import)
    const parseDateLooseToKey = (raw) => {
      const s = String(raw ?? "").trim();
      if(!s) return null;
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      if(/^\d{8}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
      const m = s.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})$/);
      if(m){
        const y = Number(m[1]);
        const mo = Number(m[2]);
        const d = Number(m[3]);
        if(!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(d)) return null;
        if(mo<1||mo>12||d<1||d>31) return null;
        return `${y}-${pad2(mo)}-${pad2(d)}`;
      }
      return null;
    };

    const parseHHMMLoose = (raw) => {
      const s = String(raw ?? "").trim();
      if(!s) return null;
      const m = s.match(/^(\d{1,2})(?::(\d{1,2}))?$/);
      if(m){
        const h = Number(m[1]);
        const mm = m[2] == null ? 0 : Number(m[2]);
        if(h<0||h>23||mm<0||mm>59) return null;
        return h*60+mm;
      }
      if(/^\d{3,4}$/.test(s)){
        const n = Number(s);
        const h = Math.floor(n/100);
        const mm = n%100;
        if(h<0||h>23||mm<0||mm>59) return null;
        return h*60+mm;
      }
      return null;
    };

    // --- monitor settings
    const MONITOR_SETTINGS_KEY = "ismkaikan_monitor_settings_v1";
    const MONITOR_VIEW_KEY = "ismkaikan_monitor_view_v1";
    const DEFAULT_MONITOR_SETTINGS = { startHHMM:"08:00", endHHMM:"20:00", autoPage:true, intervalSec:12, roomsPerPage:"auto" };

    function loadMonitorSettings(){
      try{
        const raw = localStorage.getItem(MONITOR_SETTINGS_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj) return null;
        return {
          startHHMM: String(obj.startHHMM || DEFAULT_MONITOR_SETTINGS.startHHMM),
          endHHMM: String(obj.endHHMM || DEFAULT_MONITOR_SETTINGS.endHHMM),
          autoPage: obj.autoPage !== false,
          intervalSec: Number(obj.intervalSec || DEFAULT_MONITOR_SETTINGS.intervalSec),
          roomsPerPage: String(obj.roomsPerPage || DEFAULT_MONITOR_SETTINGS.roomsPerPage),
        };
      }catch(e){ return null; }
    }
    function saveMonitorSettingsLocal(obj){
      try{ localStorage.setItem(MONITOR_SETTINGS_KEY, JSON.stringify(obj)); }catch(e){}
    }
    function loadMonitorView(){
      try{ return localStorage.getItem(MONITOR_VIEW_KEY) || "timeline"; }catch(e){ return "timeline"; }
    }
    function saveMonitorView(v){
      try{ localStorage.setItem(MONITOR_VIEW_KEY, String(v||"timeline")); }catch(e){}
    }

    // --- deterministic id for import (avoid duplicates)
    function fnv1a32(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
      }
      return h >>> 0;
    }
    function deterministicIdForReservation(m){
      const base = `${m.date}|${m.roomId}|${m.startMin}|${m.endMin}|${String(m.groupName||"").trim()}`;
      return `imp_${fnv1a32(base).toString(36)}`;
    }


    function saveCache(key, value){
      try{ localStorage.setItem(key, JSON.stringify({ at: Date.now(), value })); }catch(e){}
    }
    function loadCache(key){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        return obj?.value ?? null;
      }catch(e){ return null; }
    }

    function classNames(...xs){ return xs.filter(Boolean).join(" "); }

    /**********************
     * read/writeÊ¶ÇÁÆóÔºàÊúàÂçò‰ΩçÔºâ
     **********************/
    function loadOps(){
      const mk = monthKeyLocal();
      try{
        const raw = localStorage.getItem(OPS_KEY);
        if(!raw) return { month: mk, reads: 0, writes: 0 };
        const obj = JSON.parse(raw);
        if(obj?.month !== mk) return { month: mk, reads: 0, writes: 0 };
        return { month: mk, reads: Number(obj.reads||0), writes: Number(obj.writes||0) };
      }catch(e){ return { month: mk, reads: 0, writes: 0 }; }
    }
    function saveOps(ops){
      try{ localStorage.setItem(OPS_KEY, JSON.stringify(ops)); }catch(e){}
    }

    /**********************
     * UI primitives
     **********************/
    const Pill = ({children, tone="slate"}) => {
      const map = {
        slate: "bg-slate-100 text-slate-700 border-slate-200",
        sky: "bg-sky-50 text-sky-700 border-sky-200",
        emerald: "bg-emerald-50 text-emerald-700 border-emerald-200",
        rose: "bg-rose-50 text-rose-700 border-rose-200",
        amber: "bg-amber-50 text-amber-700 border-amber-200",
        violet: "bg-violet-50 text-violet-700 border-violet-200",
      };
      return (
        <span className={classNames("inline-flex items-center gap-1 px-2 py-1 rounded-xl text-[12px] font-black border", map[tone]||map.slate)}>
          {children}
        </span>
      );
    };

    const Card = ({children, printCard=false}) => (
      <div className={classNames("bg-white rounded-3xl p-4 shadow-sm border border-slate-100", printCard ? "print-card" : "")}>
        {children}
      </div>
    );

    const SectionTitle = ({icon, title, sub, right}) => (
      <div className="flex items-end justify-between gap-2 flex-wrap">
        <div className="space-y-1">
          <div className="flex items-center gap-2">
            <div className="w-9 h-9 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-700 font-black">
              {icon}
            </div>
            <div className="text-lg font-black text-slate-800">{title}</div>
          </div>
          {sub ? <div className="text-xs font-bold text-slate-400">{sub}</div> : null}
        </div>
        {right ? <div className="flex items-center gap-2">{right}</div> : null}
      </div>
    );

    function TabButton({active, onClick, children}){
      return (
        <button
          onClick={onClick}
          className={classNames(
            "rounded-2xl py-3 font-black border shadow-sm",
            active ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200"
          )}
        >
          {children}
        </button>
      );
    }

    const Modal = ({open, onClose, title, children}) => {
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 no-print">
          <div className="absolute inset-0 bg-black/30" onClick={onClose}></div>
          <div className="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center p-3">
            <div className="w-full md:max-w-4xl bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
              <div className="p-4 border-b border-slate-100 flex items-center justify-between">
                <div className="font-black text-slate-800">{title}</div>
                <button className="px-3 py-2 rounded-2xl bg-slate-100 font-black text-slate-700" onClick={onClose}>Èñâ„Åò„Çã</button>
              </div>
              <div className="p-4 space-y-4">
                {children}
              </div>
            </div>
          </div>
        </div>
      );
    };

    /**********************
     * Main App
     **********************/
    function App(){
      const [tab, setTab] = useState("dashboard");
      const [selectedDate, setSelectedDate] = useState(todayKeyLocal());
      const [monitorDate, setMonitorDate] = useState(todayKeyLocal());

      const [monthCursor, setMonthCursor] = useState(() => monthKeyFromDateKey(todayKeyLocal()));
      const [monthReservations, setMonthReservations] = useState([]);
      const [monthBusy, setMonthBusy] = useState(false);

      const [monitorSettings, setMonitorSettings] = useState(() => loadMonitorSettings() || DEFAULT_MONITOR_SETTINGS);
      const [monitorDraft, setMonitorDraft] = useState(() => loadMonitorSettings() || DEFAULT_MONITOR_SETTINGS);
      const [monitorView, setMonitorView] = useState(() => loadMonitorView());

      const [yearQuery, setYearQuery] = useState("");
      const [yearRoomFilter, setYearRoomFilter] = useState("all");

      const [importOpen, setImportOpen] = useState(false);
      const [importText, setImportText] = useState("");
      const [importPreview, setImportPreview] = useState(null);
      const [importBusy, setImportBusy] = useState(false);

      const [user, setUser] = useState(null);
      const [authReady, setAuthReady] = useState(false);
      const isLoggedIn = !!user;

      const [busy, setBusy] = useState(false);
      const [toast, setToast] = useState(null);

      const [rooms, setRooms] = useState(DEFAULT_ROOMS);
      const [equipments, setEquipments] = useState(DEFAULT_EQUIPMENTS);

      const [dayReservations, setDayReservations] = useState([]);
      const [monitorReservations, setMonitorReservations] = useState([]);

      const [weekStart, setWeekStart] = useState(startOfWeekMonday(selectedDate));
      const weekKeys = useMemo(()=>Array.from({length:7}, (_,i)=>addDaysKey(weekStart, i)), [weekStart]);

      const [weekReservations, setWeekReservations] = useState([]);
      const [yearReservations, setYearReservations] = useState([]);
      const [yearBusy, setYearBusy] = useState(false);

      const [editorOpen, setEditorOpen] = useState(false);
      const [editModel, setEditModel] = useState(null);

      const [ops, setOps] = useState(loadOps());
      useEffect(()=>{ saveOps(ops); }, [ops]);

      // When month cursor changes, load cached month reservations
      useEffect(() => {
        const cache = loadCache(`${CACHE_PREFIX}:month:${monthCursor}`);
        if(cache) setMonthReservations(cache);
      }, [monthCursor]);

      // Keep draft in sync when saved settings change
      useEffect(() => {
        setMonitorDraft(monitorSettings);
      }, [monitorSettings]);

      function bumpReads(n){
        const mk = monthKeyLocal();
        setOps(prev => {
          const base = (prev.month === mk) ? prev : { month: mk, reads: 0, writes: 0 };
          return { ...base, reads: base.reads + Number(n||0) };
        });
      }
      function bumpWrites(n){
        const mk = monthKeyLocal();
        setOps(prev => {
          const base = (prev.month === mk) ? prev : { month: mk, reads: 0, writes: 0 };
          return { ...base, writes: base.writes + Number(n||0) };
        });
      }
      function resetOps(){
        const mk = monthKeyLocal();
        if(!confirm(`${mk} „ÅÆ read/writeÔºàÊ¶ÇÁÆóÔºâ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü`)) return;
        setOps({ month: mk, reads: 0, writes: 0 });
      }

      const roomsActive = useMemo(() =>
        (rooms||[])
          .filter(r => r.active !== false)
          .slice()
          .sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.building||"").localeCompare(String(b.building||"")) || String(a.name||"").localeCompare(String(b.name||"")))
      , [rooms]);

      const roomsMap = useMemo(() => {
        const m = {};
        for(const r of rooms||[]) m[r.id] = r;
        return m;
      }, [rooms]);

      const equipmentsActive = useMemo(() =>
        (equipments||[])
          .filter(e => e.active !== false)
          .slice()
          .sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.name||"").localeCompare(String(b.name||"")))
      , [equipments]);

      const equipmentsMap = useMemo(() => {
        const m = {};
        for(const e of equipments||[]) m[e.id] = e;
        return m;
      }, [equipments]);

      const roomName = (id) => roomsMap[id]?.name ?? id;
      const roomBuilding = (id) => roomsMap[id]?.building ?? "";

      const blankEquipment = (base={}) => {
        const out = {};
        for(const e of equipmentsActive){
          out[e.id] = Math.max(0, Math.min(999, Number(base?.[e.id] ?? 0) || 0));
        }
        return out;
      };

      const dayEquipmentUsed = useMemo(() => {
        const used = {};
        for(const e of equipmentsActive) used[e.id] = 0;
        for(const r of dayReservations){
          const eq = r?.equipment || {};
          for(const e of equipmentsActive){
            used[e.id] += Number(eq?.[e.id] ?? 0);
          }
        }
        return used;
      }, [dayReservations, equipmentsActive]);

      // Auth monitor
      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => { setUser(u||null); setAuthReady(true); });
        return () => unsub && unsub();
      }, []);

      // Sync weekStart with selectedDate
      useEffect(() => { setWeekStart(startOfWeekMonday(selectedDate)); }, [selectedDate]);

      // Load caches on mount
      useEffect(() => {
        const rCache = loadCache(`${CACHE_PREFIX}:rooms`);
        const eCache = loadCache(`${CACHE_PREFIX}:equipments`);
        const dCache = loadCache(`${CACHE_PREFIX}:reservations:${selectedDate}`);
        const mCache = loadCache(`${CACHE_PREFIX}:monitor:${monitorDate}`);
        const moCache = loadCache(`${CACHE_PREFIX}:month:${monthCursor}`);
        if(rCache?.length) setRooms(rCache);
        if(eCache?.length) setEquipments(eCache);
        if(dCache) setDayReservations(dCache);
        if(mCache) setMonitorReservations(mCache);
        if(moCache) setMonthReservations(moCache);

        const ms = loadMonitorSettings();
        if(ms) { setMonitorSettings(ms); setMonitorDraft(ms); }
        const mv = loadMonitorView();
        if(mv) setMonitorView(mv);
      }, []);

      // When date changes, load cached day reservations
      useEffect(() => {
        const dCache = loadCache(`${CACHE_PREFIX}:reservations:${selectedDate}`);
        if(dCache) setDayReservations(dCache);
      }, [selectedDate]);

      // When monitor date changes, load cached monitor reservations
      useEffect(() => {
        const mCache = loadCache(`${CACHE_PREFIX}:monitor:${monitorDate}`);
        if(mCache) setMonitorReservations(mCache);
      }, [monitorDate]);

      async function loginWithShared(password){
        setBusy(true);
        try{
          await auth.signInWithEmailAndPassword(SHARED_EMAIL, password);
          setToast({ type:"ok", msg:"„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„ÅüÔºàÁ∑®ÈõÜ„Åß„Åç„Åæ„ÅôÔºâ" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åæ„Åõ„ÇìÔºàPW„ÅåÈÅï„ÅÜ/„É¶„Éº„Ç∂„ÉºÊú™‰ΩúÊàêÔºâ" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2600);
        }
      }
      async function logout(){
        await auth.signOut();
        setToast({ type:"ok", msg:"„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü" });
        setTimeout(()=>setToast(null), 2000);
      }

      async function refreshMasters(opts={}){
        const silent = !!opts.silent;
        if(!silent) setBusy(true);
        let usedFallback = false;
        try{
          async function getList(col, fallback, cacheKey){
            try{
              const snap = await db.collection(col).get();
              bumpReads(snap.size);
              const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              if(list.length){
                saveCache(`${CACHE_PREFIX}:${cacheKey}`, list);
                return list;
              }
              saveCache(`${CACHE_PREFIX}:${cacheKey}`, fallback);
              return fallback;
            }catch(err){
              usedFallback = true;
              const cached = loadCache(`${CACHE_PREFIX}:${cacheKey}`);
              if(cached && Array.isArray(cached) && cached.length) return cached;
              return fallback;
            }
          }

          const roomsList = await getList(\"rooms\", DEFAULT_ROOMS, \"rooms\");
          const eqList = await getList(\"equipments\", DEFAULT_EQUIPMENTS, \"equipments\");
          setRooms(roomsList);
          setEquipments(eqList);

          if(!silent){
            setToast({ type:\"ok\", msg: usedFallback ? \"„Éû„Çπ„ÇøÊõ¥Êñ∞Ôºö„Ç≠„É£„ÉÉ„Ç∑„É•/ÂàùÊúüÂÄ§„Çí‰ΩøÁî®„Åó„Åæ„Åó„Åü\" : \"„Éû„Çπ„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü\" });
          }
        }catch(err){
          console.error(err);
          if(!silent) setToast({ type:\"ng\", msg:\"„Éû„Çπ„ÇøÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\" });
        }finally{
          if(!silent){
            setBusy(false);
            setTimeout(()=>setToast(null), 2200);
          }
        }
      }

      async function refreshDay(dateKey){
        setBusy(true);
        try{
          const snap = await db.collection("reservations").where("date","==",dateKey).get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=>(String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
          setDayReservations(list);
          saveCache(`${CACHE_PREFIX}:reservations:${dateKey}`, list);
          setToast({ type:"ok", msg:"Êõ¥Êñ∞„Åó„Åæ„Åó„Åü" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2000);
        }
      }

      async function refreshMonitor(dateKey){
        setBusy(true);
        try{
          const snap = await db.collection("reservations").where("date","==",dateKey).get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=>(String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
          setMonitorReservations(list);
          saveCache(`${CACHE_PREFIX}:monitor:${dateKey}`, list);
          setToast({ type:"ok", msg:"„É¢„Éã„Çø„Éº„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2000);
        }
      }

      async function refreshWeek(startKey){
        setBusy(true);
        try{
          const endKey = addDaysKey(startKey, 6);
          const snap = await db.collection("reservations")
            .where("date", ">=", startKey)
            .where("date", "<=", endKey)
            .get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
          setWeekReservations(list);
          saveCache(`${CACHE_PREFIX}:week:${startKey}`, list);
          setToast({ type:"ok", msg:"ÈÄ±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü" });
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"ÈÄ±„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" });
        }finally{
          setBusy(false);
          setTimeout(()=>setToast(null), 2000);
        }
      }

      async function refreshMonth(monthKey){
        setMonthBusy(true);
        try{
          const start = startOfMonthKey(monthKey);
          const end = endOfMonthKey(monthKey);
          const snap = await db.collection("reservations")
            .where("date", ">=", start)
            .where("date", "<=", end)
            .get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || Number(a.startMin||0)-Number(b.startMin||0) || String(a.roomId||"").localeCompare(String(b.roomId||""))));
          setMonthReservations(list);
          saveCache(`${CACHE_PREFIX}:month:${monthKey}`, list);
          setToast({ type:"ok", msg:"Êúà‰∫àÂÆö„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü" });
          setTimeout(()=>setToast(null), 1800);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"Êúà‰∫àÂÆö„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setMonthBusy(false);
        }
      }

      async function refreshYear(){
        setYearBusy(true);
        try{
          // 4Êúà„ÄúÁøå3ÊúàÔºàselectedDateÂü∫Ê∫ñ„ÅÆÂπ¥Â∫¶Ôºâ
          const fy = (()=>{
            const d = parseKeyToDate(selectedDate);
            const y = d.getFullYear();
            const m = d.getMonth()+1;
            return (m>=4) ? y : (y-1);
          })();
          const start = `${fy}-04-01`;
          const end = `${fy+1}-03-31`;

          const snap = await db.collection("reservations")
            .where("date", ">=", start)
            .where("date", "<=", end)
            .get();
          bumpReads(snap.size);
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || String(a.roomId||"").localeCompare(String(b.roomId||"")) || Number(a.startMin||0)-Number(b.startMin||0)));
          setYearReservations(list);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"Âπ¥Â∫¶‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setYearBusy(false);
        }
      }

      function openNew(){
        const firstRoom = roomsActive[0]?.id || DEFAULT_ROOMS[0].id;
        setEditModel({
          id: null,
          date: selectedDate,
          roomId: firstRoom,
          startMin: hhmmToMin("09:00"),
          endMin: hhmmToMin("10:00"),
          groupName: "",
          note: "",
          equipment: blankEquipment({}),
        });
        setEditorOpen(true);
      }

      function openEdit(r){
        setEditModel({
          id: r.id,
          date: r.date,
          roomId: r.roomId,
          startMin: Number(r.startMin||0),
          endMin: Number(r.endMin||0),
          groupName: r.groupName || "",
          note: r.note || "",
          equipment: blankEquipment(r.equipment || {}),
        });
        setEditorOpen(true);
      }

      async function saveReservation(model){
        if(!isLoggedIn){
          setToast({ type:"ng", msg:"Á∑®ÈõÜ„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        const g = (model.groupName||"").trim();
        if(!g){
          setToast({ type:"ng", msg:"Âõ£‰ΩìÂêç„ÅØÂøÖÈ†à„Åß„Åô" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        if(!isValidDateKey(model.date)){
          setToast({ type:"ng", msg:"Êó•‰ªò„Åå‰∏çÊ≠£„Åß„Åô" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }
        const sMin = Number(model.startMin);
        const eMin = Number(model.endMin);
        if(!(eMin > sMin)){
          setToast({ type:"ng", msg:"ÁµÇ‰∫ÜÊôÇÂàª„ÅØÈñãÂßãÊôÇÂàª„Çà„ÇäÂæå„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ" });
          setTimeout(()=>setToast(null), 2200);
          return;
        }

        // ÂêåÊó•„Éá„Éº„Çø„ÇíÁ¢∫ÂÆü„Å´ÊåÅ„Å§Ôºà„Ç≠„É£„ÉÉ„Ç∑„É•„Å†„Åë„Å†„Å®„Ç∫„É¨„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅ‰øùÂ≠òÂâç„Å´ÂêåÊó•„ÇíÂèñÂæóÔºâ
        setBusy(true);
        try{
          const sameSnap = await db.collection("reservations").where("date","==",model.date).get();
          bumpReads(sameSnap.size);
          const sameDate = sameSnap.docs.map(d => ({ id:d.id, ...d.data() }));

          // 1) ÂêåÂÆ§ÈáçË§á
          const sameRoom = sameDate.filter(x => x.roomId === model.roomId && x.id !== model.id);
          const conflict = sameRoom.some(x => overlaps(sMin,eMin, Number(x.startMin||0), Number(x.endMin||0)));
          if(conflict){
            setToast({ type:"ng", msg:"Âêå„ÅòÈÉ®Â±ã„ÅßÊôÇÈñì„ÅåÈáçË§á„Åó„Å¶„ÅÑ„Åæ„ÅôÔºà‰∫àÁ¥Ñ‰∏çÂèØÔºâ" });
            setTimeout(()=>setToast(null), 2800);
            return;
          }

          // 2) Ê©üÊùêË∂ÖÈÅéÔºàÂêåÊôÇÈñìÂ∏Ø„ÄÅÂÖ®ÂÆ§Ôºâ
          const overlapsAny = sameDate
            .filter(x => x.id !== model.id)
            .filter(x => overlaps(sMin,eMin, Number(x.startMin||0), Number(x.endMin||0)));

          const need = blankEquipment(model.equipment || {});
          const used = {};
          for(const e of equipmentsActive) used[e.id] = 0;

          for(const r of overlapsAny){
            const eq = r?.equipment || {};
            for(const e of equipmentsActive){
              used[e.id] += Number(eq?.[e.id] ?? 0);
            }
          }

          const warnings = [];
          for(const e of equipmentsActive){
            const total = Number(e.countTotal ?? 0) || 0;
            const after = used[e.id] + (need[e.id]||0);
            if(total > 0 && after > total){
              warnings.push(`${e.name}„ÅåÁ∑èÊï∞ ${total} „ÇíË∂Ö„Åà„Åæ„ÅôÔºàÂêåÊôÇÈñìÂ∏Ø ÂêàË®à ${after}Ôºâ`);
            }
          }
          if(warnings.length){
            const ok = confirm(`„ÄêÊ©üÊùê„ÅÆË≠¶Âëä„Äë\n${warnings.join("\n")}\n\n„Åù„Çå„Åß„ÇÇ‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü`);
            if(!ok) return;
          }

          const payload = {
            date: model.date,
            roomId: model.roomId,
            startMin: sMin,
            endMin: eMin,
            groupName: g,
            note: (model.note||"").trim(),
            equipment: need,
            updatedAt: serverTimestamp(),
          };

          if(model.id){
            await db.collection("reservations").doc(model.id).set(payload, { merge:true });
            bumpWrites(1);
          }else{
            await db.collection("reservations").add({ ...payload, createdAt: serverTimestamp() });
            bumpWrites(1);
          }

          setEditorOpen(false);
          setEditModel(null);

          // ÁîªÈù¢„Å´Âøú„Åò„Å¶Êõ¥Êñ∞
          await refreshDay(selectedDate);
          if(tab === "monitor") await refreshMonitor(monitorDate);
          if(tab === "week") await refreshWeek(weekStart);
          if(tab === "month") await refreshMonth(monthCursor);
          if(tab === "year") await refreshYear();

          setToast({ type:"ok", msg:"‰øùÂ≠ò„Åó„Åæ„Åó„Åü" });
          setTimeout(()=>setToast(null), 1500);
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      async function deleteReservation(id){
        if(!isLoggedIn) return;
        if(!confirm("„Åì„ÅÆ‰∫àÁ¥Ñ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
        setBusy(true);
        try{
          await db.collection("reservations").doc(id).delete();
          bumpWrites(1);
          await refreshDay(selectedDate);
          if(tab === "monitor") await refreshMonitor(monitorDate);
          if(tab === "week") await refreshWeek(weekStart);
          if(tab === "month") await refreshMonth(monthCursor);
          if(tab === "year") await refreshYear();
        }catch(err){
          console.error(err);
          setToast({ type:"ng", msg:"ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" });
          setTimeout(()=>setToast(null), 2400);
        }finally{
          setBusy(false);
        }
      }

      function doPrint(){
        setTimeout(()=>window.print(), 120);
      }

      // Auto refresh master once auth ready
      useEffect(() => {
        if(!authReady) return;
        refreshMasters({ silent:true });
      }, [authReady]);

      // Auto refresh day reservations on first load
      useEffect(() => {
        if(!authReady) return;
        refreshDay(selectedDate);
      }, [authReady]);

      const fyInfo = useMemo(() => {
        const d = parseKeyToDate(selectedDate);
        const y = d.getFullYear();
        const m = d.getMonth()+1;
        const fy = (m>=4) ? y : (y-1);
        return { fy, start: `${fy}-04-01`, end: `${fy+1}-03-31`, label: `${fy}Âπ¥Â∫¶` };
      }, [selectedDate]);

      return (
        <div className="min-h-screen pb-24">
          <div className="max-w-7xl mx-auto px-4 pt-5">
            <div className="flex items-center justify-between gap-3 flex-wrap">
              <div>
                <div className="text-2xl font-black text-slate-900">Â§∑ÈöÖÊïôËÇ≤‰ºöÈ§® ÁÆ°ÁêÜ</div>
                <div className="text-xs font-bold text-slate-400 mt-1">ÈÉ®Â±ã‰∫àÁ¥Ñ / ÂÖ•Âè£„É¢„Éã„Çø„Éº / ÈÄ±„ÉªÂπ¥Â∫¶‰∏ÄË¶ß / ÈÉ®Â±ã„ÉªÊ©üÊùê„Éû„Çπ„ÇøÁ∑®ÈõÜ</div>
              </div>

              <div className="flex items-center gap-2">
                <button
                  className={classNames(\"rounded-2xl px-4 py-2 font-black border shadow-sm\",
                    (busy || monthBusy || yearBusy || importBusy) ? \"bg-slate-100 text-slate-400 border-slate-200\" : \"bg-sky-600 text-white border-sky-600\")}
                  disabled={busy || monthBusy || yearBusy || importBusy}
                  onClick={() => {
                    if(tab === \"monitor\") return refreshMonitor(monitorDate);
                    if(tab === \"week\") return refreshWeek(weekStart);
                    if(tab === \"month\") return refreshMonth(monthCursor);
                    if(tab === \"year\") return refreshYear();
                    return refreshDay(selectedDate);
                  }}
                >
                  Êõ¥Êñ∞
                </button>
                <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={refreshMasters} disabled={busy}>
                  „Éû„Çπ„ÇøÊõ¥Êñ∞
                </button>
                <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={doPrint}>
                  Âç∞Âà∑
                </button>

                {isLoggedIn ? (
                  <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={logout}>
                    „É≠„Ç∞„Ç¢„Ç¶„Éà
                  </button>
                ) : (
                  <LoginButton busy={busy} onLogin={loginWithShared} />
                )}
              </div>
            </div>

            <div className="mt-3 flex items-center gap-2 flex-wrap">
              <Pill tone={isLoggedIn ? "emerald" : "slate"}>{isLoggedIn ? "Á∑®ÈõÜ„É¢„Éº„ÉâÔºà„É≠„Ç∞„Ç§„É≥‰∏≠Ôºâ" : "Èñ≤Ë¶ß„É¢„Éº„ÉâÔºà„É≠„Ç∞„Ç§„É≥„Å™„ÅóÔºâ"}</Pill>
              <Pill tone="sky">ÂÖ±ÈÄöIDÔºö{SHARED_LOGIN_CODE}</Pill>
              <Pill tone="violet">Âπ¥Â∫¶Ôºö{fyInfo.fy}Ôºà{fyInfo.start}„Äú{fyInfo.end}Ôºâ</Pill>
              <Pill tone="amber">Ê¶ÇÁÆó readsÔºö{ops.reads}</Pill>
              <Pill tone="amber">Ê¶ÇÁÆó writesÔºö{ops.writes}</Pill>
              <button className="px-3 py-1.5 rounded-xl bg-white border border-slate-200 font-black text-xs text-slate-700" onClick={resetOps}>
                read/write „É™„Çª„ÉÉ„Éà
              </button>
              {busy ? <Pill tone="amber">Âá¶ÁêÜ‰∏≠‚Ä¶</Pill> : null}
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 mt-3">
            <div className=\"grid grid-cols-3 md:grid-cols-9 gap-2 no-print\">
              <TabButton active={tab===\"dashboard\"} onClick={()=>setTab(\"dashboard\")}>ÂÖ®‰Ωì</TabButton>
              <TabButton active={tab===\"monitor\"} onClick={()=>{ setTab(\"monitor\"); setMonitorDate(todayKeyLocal()); }}>ÂÖ•Âè£</TabButton>
              <TabButton active={tab===\"day\"} onClick={()=>setTab(\"day\")}>Êó•</TabButton>
              <TabButton active={tab===\"week\"} onClick={()=>{ setTab(\"week\"); }}>ÈÄ±</TabButton>
              <TabButton active={tab===\"month\"} onClick={()=>{ setMonthCursor(monthKeyFromDateKey(selectedDate)); setTab(\"month\"); }}>Êúà</TabButton>
              <TabButton active={tab===\"year\"} onClick={()=>{ setTab(\"year\"); }}>Âπ¥Â∫¶</TabButton>
              <TabButton active={tab===\"equip\"} onClick={()=>setTab(\"equip\")}>Ê©üÊùê</TabButton>
              <TabButton active={tab===\"rooms\"} onClick={()=>setTab(\"rooms\")}>ÈÉ®Â±ã</TabButton>
              <TabButton active={tab===\"help\"} onClick={()=>setTab(\"help\")}>Ë®≠ÂÆö</TabButton>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 mt-4 space-y-4">
            {tab === "dashboard" && (
              <div className="space-y-4">
                <Card printCard>
                  <SectionTitle
                    icon="üè†"
                    title="‰ªäÊó•„ÅÆÁä∂Ê≥Å"
                    sub="„Åæ„Åö„ÅØ„Åì„Åì„Å†„ÅëË¶ã„Çå„Å∞OK"
                    right={isLoggedIn ? (
                      <button className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm no-print" onClick={openNew}>
                        Ôºã‰∫àÁ¥ÑËøΩÂä†
                      </button>
                    ) : null}
                  />

                  <div className="mt-4 grid md:grid-cols-3 gap-3">
                    <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                      <div className="text-xs font-black text-slate-500">ÈÉ®Â±ã‰∫àÁ¥ÑÔºà‰ª∂Êï∞Ôºâ</div>
                      <div className="text-3xl font-black text-slate-800 mt-1">{dayReservations.length}</div>
                      <div className="text-xs font-bold text-slate-400 mt-2">Êó•‰ªòÔºö{selectedDate}</div>
                    </div>

                    <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                      <div className="text-xs font-black text-slate-500">Ê©üÊùê‰ΩøÁî®ÔºàÂêàË®àÔºâ</div>
                      <div className="mt-2 space-y-2">
                        {equipmentsActive.length === 0 ? (
                          <div className="text-xs font-bold text-slate-400">Ê©üÊùê„ÅåÊú™Ë®≠ÂÆö„Åß„Åô</div>
                        ) : equipmentsActive.map(e => (
                          <div key={e.id} className="flex items-center justify-between">
                            <div className="font-black text-slate-800">{e.name}</div>
                            <div className="font-black text-slate-800">{dayEquipmentUsed[e.id]||0} / {(e.countTotal ?? "‚Äî")}</div>
                          </div>
                        ))}
                      </div>
                      <div className="text-xs font-bold text-slate-400 mt-2">‚Äª‰∫àÁ¥Ñ„Å´Á¥ê„Å•„Åè„Äå‰ΩøÁî®Âè∞Êï∞„Äç„ÅÆÂêàË®à</div>
                    </div>

                    <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                      <div className="text-xs font-black text-slate-500">„ÇØ„Ç§„ÉÉ„ÇØÊìç‰Ωú</div>
                      <div className="mt-3 flex flex-wrap gap-2">
                        <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>{ setTab("day"); }}>
                          Êó•‰∫àÁ¥Ñ„Å∏
                        </button>
                        <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>{ setTab("week"); }}>
                          ÈÄ±‰∏ÄË¶ß„Å∏
                        </button>
                        <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>{ setTab("year"); }}>
                          Âπ¥Â∫¶‰∏ÄË¶ß„Å∏
                        </button>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4 flex items-center justify-between gap-2 flex-wrap">
                    <div className="text-sm font-black text-slate-700">Êó•‰ªò</div>
                    <div className="flex items-center gap-2 no-print">
                      <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setSelectedDate(todayKeyLocal())}>‰ªäÊó•</button>
                      <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setSelectedDate(addDaysKey(todayKeyLocal(),1))}>ÊòéÊó•</button>
                      <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setSelectedDate(addDaysKey(todayKeyLocal(),2))}>ÊòéÂæåÊó•</button>
                    </div>
                    <input type="date" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={selectedDate} onChange={(e)=>setSelectedDate(e.target.value)} />
                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>refreshDay(selectedDate)} disabled={busy}>„Åì„ÅÆÊó•„ÇíÊõ¥Êñ∞</button>
                  </div>

                  <div className="mt-4 text-sm font-black text-slate-700">ÈÉ®Â±ã„Åî„Å®„ÅÆ‰∫àÁ¥ÑÔºà{selectedDate}Ôºâ</div>
                  <div className="mt-3 grid md:grid-cols-2 gap-3">
                    {roomsActive.map(room => {
                      const list = dayReservations.filter(r => r.roomId === room.id).slice().sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
                      return (
                        <div key={room.id} className="rounded-3xl border border-slate-100 p-4">
                          <div className="flex items-center justify-between">
                            <div className="space-y-0.5">
                              <div className="text-xs font-black text-slate-400">{room.building}</div>
                              <div className="font-black text-slate-800">{room.name}</div>
                            </div>
                            <Pill tone="slate">{list.length}‰ª∂</Pill>
                          </div>

                          <div className="mt-3 space-y-2">
                            {list.length === 0 ? (
                              <div className="text-xs font-bold text-slate-400">‰∫àÁ¥Ñ„Å™„Åó</div>
                            ) : list.map(r => (
                              <div key={r.id} className="flex items-start justify-between gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100">
                                <div className="min-w-0">
                                  <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}‚Äì{minToHHMM(r.endMin||0)} / {r.groupName}</div>
                                  <div className="text-xs font-bold text-slate-500 mt-1 flex gap-2 flex-wrap">
                                    {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                                      <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                                    ) : null)}
                                    {r.note ? <Pill tone="slate">„É°„É¢</Pill> : null}
                                  </div>
                                </div>
                                {isLoggedIn ? (
                                  <div className="shrink-0 flex items-center gap-2 no-print">
                                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>openEdit(r)}>
                                      Á∑®ÈõÜ
                                    </button>
                                  </div>
                                ) : null}
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </Card>
              </div>
            )}

            {tab === "day" && (
              <Card printCard>
                <SectionTitle
                  icon="üìÖ"
                  title="Êó•‰∫àÁ¥Ñ"
                  sub="Êó•„Åî„Å®„ÅÆ‰∫àÁ¥Ñ‰∏ÄË¶ßÔºàÈáçË§á„ÅØ‰øùÂ≠òÊôÇ„Å´„Éñ„É≠„ÉÉ„ÇØÔºâ"
                  right={isLoggedIn ? (
                    <button className="rounded-2xl px-4 py-2 font-black bg-emerald-600 text-white border border-emerald-600 shadow-sm no-print" onClick={openNew}>
                      Ôºã‰∫àÁ¥ÑËøΩÂä†
                    </button>
                  ) : null}
                />

                <div className="mt-4 flex items-center gap-2 flex-wrap">
                  <input type="date" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={selectedDate} onChange={(e)=>setSelectedDate(e.target.value)} />
                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>refreshDay(selectedDate)} disabled={busy}>
                    „Åì„ÅÆÊó•„ÇíÊõ¥Êñ∞
                  </button>
                  <div className="text-xs font-bold text-slate-400">‚ÄªË°®Á§∫„ÅåÂè§„ÅÑÂ†¥Âêà„ÅØ„ÄåÊõ¥Êñ∞„Äç</div>
                </div>

                <div className="mt-4 grid md:grid-cols-2 gap-3">
                  {roomsActive.map(room => {
                    const list = dayReservations.filter(r => r.roomId === room.id).slice().sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
                    return (
                      <div key={room.id} className="rounded-3xl border border-slate-100 p-4">
                        <div className="flex items-center justify-between">
                          <div className="space-y-0.5">
                            <div className="text-xs font-black text-slate-400">{room.building}</div>
                            <div className="font-black text-slate-800">{room.name}</div>
                          </div>
                          <Pill tone="slate">{list.length}‰ª∂</Pill>
                        </div>
                        <div className="mt-3 space-y-2">
                          {list.length === 0 ? (
                            <div className="text-xs font-bold text-slate-400">‰∫àÁ¥Ñ„Å™„Åó</div>
                          ) : list.map(r => (
                            <div key={r.id} className="p-3 rounded-2xl bg-slate-50 border border-slate-100">
                              <div className="flex items-start justify-between gap-2">
                                <div className="min-w-0">
                                  <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}‚Äì{minToHHMM(r.endMin||0)} / {r.groupName}</div>
                                  <div className="mt-1 flex flex-wrap gap-2">
                                    {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                                      <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                                    ) : null)}
                                    {r.note ? <Pill tone="slate">„É°„É¢</Pill> : null}
                                  </div>
                                  {r.note ? <div className="text-xs font-bold text-slate-500 mt-2">{r.note}</div> : null}
                                </div>
                                {isLoggedIn ? (
                                  <div className="shrink-0 flex flex-col gap-2 no-print">
                                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>openEdit(r)}>
                                      Á∑®ÈõÜ
                                    </button>
                                    <button className="px-3 py-2 rounded-2xl bg-rose-50 border border-rose-200 font-black text-rose-700" onClick={()=>deleteReservation(r.id)}>
                                      ÂâäÈô§
                                    </button>
                                  </div>
                                ) : null}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </Card>
            )}

            {tab === "monitor" && (
              <Card printCard>
                <SectionTitle
                  icon="üñ•Ô∏è"
                  title="ÂÖ•Âè£„É¢„Éã„Çø„Éº"
                  sub="1Êó•ÂàÜ„ÇíÂÖ®ÁîªÈù¢„ÅßË¶ã„ÇÑ„Åô„ÅèÔºà„Çπ„ÇØ„É≠„Éº„É´ÊúÄÂ∞èÂåñÔºâ"
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setMonitorDate(todayKeyLocal())}>‰ªäÊó•</button>
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setMonitorDate(addDaysKey(todayKeyLocal(),1))}>ÊòéÊó•</button>
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setMonitorDate(addDaysKey(todayKeyLocal(),2))}>ÊòéÂæåÊó•</button>

                      <div className="flex items-center gap-2 rounded-2xl bg-white border border-slate-200 px-2 py-1">
                        <button className={classNames("px-3 py-2 rounded-2xl font-black", monitorView==="timeline" ? "bg-slate-900 text-white" : "bg-white text-slate-700")} onClick={()=>{ setMonitorView("timeline"); saveMonitorView("timeline"); }}>„Çø„Ç§„É†„É©„Ç§„É≥</button>
                        <button className={classNames("px-3 py-2 rounded-2xl font-black", monitorView==="cards" ? "bg-slate-900 text-white" : "bg-white text-slate-700")} onClick={()=>{ setMonitorView("cards"); saveMonitorView("cards"); }}>„Ç´„Éº„Éâ</button>
                      </div>

                      <button
                        className="rounded-2xl px-4 py-2 font-black bg-slate-900 text-white border border-slate-900"
                        onClick={() => {
                          const el = document.documentElement;
                          if(el.requestFullscreen) el.requestFullscreen();
                        }}
                      >
                        ÂÖ®ÁîªÈù¢
                      </button>
                    </div>
                  }
                />

                <div className="mt-4 flex items-center gap-2 flex-wrap">
                  <div className="text-sm font-black text-slate-800">Ë°®Á§∫Êó•</div>
                  <input type="date" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={monitorDate} onChange={(e)=>setMonitorDate(e.target.value)} />
                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>refreshMonitor(monitorDate)} disabled={busy}>
                    „Åì„ÅÆÊó•„ÇíÊõ¥Êñ∞
                  </button>
                  <div className="text-xs font-bold text-slate-400">ÊôÇÈñìËª∏Ôºö{monitorSettings.startHHMM}„Äú{monitorSettings.endHHMM}ÔºàÂ§âÊõ¥„ÅØ„ÄåË®≠ÂÆö„ÄçÔºâ</div>
                </div>

                {monitorView === "timeline" ? (
                  <MonitorTimelineBoard
                    dateKey={monitorDate}
                    rooms={roomsActive}
                    reservations={monitorReservations}
                    equipmentsActive={equipmentsActive}
                    startHHMM={monitorSettings.startHHMM}
                    endHHMM={monitorSettings.endHHMM}
                    autoPage={monitorSettings.autoPage}
                    intervalSec={monitorSettings.intervalSec}
                    roomsPerPage={monitorSettings.roomsPerPage}
                  />
                ) : (
                  <MonitorBoard
                    dateKey={monitorDate}
                    rooms={roomsActive}
                    equipmentsActive={equipmentsActive}
                    reservations={monitorReservations}
                  />
                )}
              </Card>
            )}


            {tab === "week" && (
              <Card printCard>
                <SectionTitle
                  icon="üßæ"
                  title="ÈÄ±‰∫àÂÆö"
                  sub={`ÈÄ±Ôºö${weekStart}„Äú${addDaysKey(weekStart,6)}ÔºàÊúàÊõúÂßã„Åæ„ÇäÔºâ`}
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const prev=addDaysKey(weekStart,-7); setWeekStart(prev); }}>
                        ‚óÄ ÂâçÈÄ±
                      </button>
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const next=addDaysKey(weekStart,7); setWeekStart(next); }}>
                        Ê¨°ÈÄ± ‚ñ∂
                      </button>
                      <button className={classNames("rounded-2xl px-4 py-2 font-black border",
                        busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                        onClick={()=>refreshWeek(weekStart)} disabled={busy}
                      >
                        „Åì„ÅÆÈÄ±„ÇíÊõ¥Êñ∞
                      </button>
                    </div>
                  }
                />

                <div className="mt-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 2xl:grid-cols-7 gap-3">
                  {weekKeys.map((dk, idx) => {
                    const list = (weekReservations||[]).filter(r => r.date === dk).slice().sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
                    const names = ["Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü","Êó•"];
                    return (
                      <div key={dk} className="rounded-3xl border border-slate-100 bg-white p-4 flex flex-col min-h-[220px]">
                        <div className="flex items-center justify-between gap-2">
                          <div>
                            <div className="text-xs font-black text-slate-400">{names[idx]}</div>
                            <div className="font-black text-slate-800">{dk}</div>
                          </div>
                          <Pill tone="slate">{list.length}‰ª∂</Pill>
                        </div>
                        <div className="mt-3 space-y-2 overflow-auto no-scrollbar" style={{maxHeight:"52vh"}}>
                          {list.length===0 ? (
                            <div className="text-xs font-bold text-slate-400">‰∫àÁ¥Ñ„Å™„Åó</div>
                          ) : list.map(r => (
                            <div key={r.id} className="p-3 rounded-2xl bg-slate-50 border border-slate-100 break-avoid">
                              <div className="font-black text-slate-800">{minToHHMM(r.startMin||0)}‚Äì{minToHHMM(r.endMin||0)} / {roomName(r.roomId)}</div>
                              <div className="text-xs font-bold text-slate-700 mt-1 break-words">{r.groupName}</div>
                              <div className="mt-2 flex flex-wrap gap-1">
                                {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                                  <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                                ) : null)}
                                {r.note ? <Pill tone="slate">„É°„É¢</Pill> : null}
                              </div>
                              {r.note ? <div className="text-xs font-bold text-slate-500 mt-2 break-words">{r.note}</div> : null}
                              {isLoggedIn ? (
                                <div className="mt-2 flex gap-2 no-print">
                                  <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>openEdit(r)}>
                                    Á∑®ÈõÜ
                                  </button>
                                </div>
                              ) : null}
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>

                <div className="mt-3 text-xs font-bold text-slate-400">‚ÄªÈÄ±‰∫àÂÆö„ÅØ„Äå„Åì„ÅÆÈÄ±„ÇíÊõ¥Êñ∞„Äç„ÅßFirestore„Åã„ÇâÂèñÂæóÔºàÊ¶ÇÁÆóread„Å´ÂèçÊò†Ôºâ</div>
              </Card>
            )}

            {tab === "month" && (
              <Card printCard>
                <SectionTitle
                  icon="üóìÔ∏è"
                  title="Êúà‰∫àÂÆö"
                  sub={`ÊúàÔºö${monthCursor}`}
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const prev = addMonthsKey(monthCursor,-1); setMonthCursor(prev); }}>
                        ‚óÄ ÂâçÊúà
                      </button>
                      <button className="rounded-2xl px-4 py-2 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>{ const next = addMonthsKey(monthCursor,1); setMonthCursor(next); }}>
                        Ê¨°Êúà ‚ñ∂
                      </button>
                      <button className={classNames("rounded-2xl px-4 py-2 font-black border",
                        monthBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                        onClick={()=>refreshMonth(monthCursor)} disabled={monthBusy}
                      >
                        „Åì„ÅÆÊúà„ÇíÊõ¥Êñ∞
                      </button>
                      <button className="rounded-2xl px-4 py-2 font-black bg-slate-900 text-white border border-slate-900" onClick={()=>{ setMonthCursor(monthKeyFromDateKey(todayKeyLocal())); }}>
                        ‰ªäÊúà
                      </button>
                    </div>
                  }
                />

                <div className="mt-3 text-xs font-bold text-slate-400">‚ÄªÊúà‰∫àÂÆö„ÅØ„Äå„Åì„ÅÆÊúà„ÇíÊõ¥Êñ∞„Äç„ÅßFirestore„Åã„ÇâÂèñÂæóÔºàÊ¶ÇÁÆóread„Å´ÂèçÊò†Ôºâ</div>

                <MonthCalendar
                  monthKey={monthCursor}
                  reservations={monthReservations}
                  roomsMap={roomsMap}
                  onPickDate={(dk)=>{ setSelectedDate(dk); setTab("day"); }}
                />
              </Card>
            )}

            {tab === "year" && (
              <Card printCard>
                <SectionTitle
                  icon="üóìÔ∏è"
                  title="Âπ¥Èñì‰∫àÂÆöÔºàÂπ¥Â∫¶Ôºâ"
                  sub={`Âπ¥Â∫¶Ôºö${fyInfo.fy}Ôºà${fyInfo.start}„Äú${fyInfo.end}Ôºâ / 4ÊúàÂßã„Åæ„Çä`}
                  right={
                    <div className="flex items-center gap-2 flex-wrap no-print">
                      {isLoggedIn ? (
                        <button className="rounded-2xl px-4 py-2 font-black bg-slate-900 text-white border border-slate-900" onClick={()=>setImportOpen(true)} disabled={importBusy||yearBusy}>
                          Âπ¥Èñì‰∏ÄÊã¨„Ç§„É≥„Éù„Éº„Éà
                        </button>
                      ) : null}
                      <button className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                        yearBusy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                        disabled={yearBusy}
                        onClick={refreshYear}
                      >
                        Âπ¥Èñì„ÇíÊõ¥Êñ∞
                      </button>
                    </div>
                  }
                />

                <div className="mt-3 grid lg:grid-cols-3 gap-3">
                  <div className="rounded-3xl border border-slate-100 bg-white p-4 lg:col-span-2">
                    <div className="flex flex-wrap items-center gap-2">
                      <div className="text-sm font-black text-slate-800">Áµû„ÇäËæº„Åø</div>
                      <input
                        className="flex-1 min-w-[220px] rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
                        value={yearQuery}
                        onChange={(e)=>setYearQuery(e.target.value)}
                        placeholder="Âõ£‰ΩìÂêç / „É°„É¢ÔºàÈÉ®ÂàÜ‰∏ÄËá¥Ôºâ"
                      />
                      <select
                        className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700"
                        value={yearRoomFilter}
                        onChange={(e)=>setYearRoomFilter(e.target.value)}
                      >
                        <option value="all">ÂÖ®ÈÉ®Â±ã</option>
                        {roomsActive.map(r => (
                          <option key={r.id} value={r.id}>{r.building} / {r.name}</option>
                        ))}
                      </select>
                      <Pill tone="slate">{yearReservations.length}‰ª∂</Pill>
                    </div>

                    <div className="mt-3 text-xs font-bold text-slate-400">‚Äª„ÄåÂπ¥Èñì„ÇíÊõ¥Êñ∞„Äç„ÅßÂπ¥Â∫¶ÂÜÖÔºà4Êúà„ÄúÁøå3ÊúàÔºâ„Çí„Åæ„Å®„ÇÅ„Å¶ÂèñÂæó„Åó„Åæ„Åô„ÄÇ‰ª∂Êï∞„ÅåÂ§ö„ÅÑ„Å®read„ÅåÂ¢ó„Åà„Åæ„Åô„ÄÇ</div>

                    <YearGroupedList
                      fyInfo={fyInfo}
                      roomsMap={roomsMap}
                      equipmentsActive={equipmentsActive}
                      reservations={yearReservations}
                      query={yearQuery}
                      roomFilter={yearRoomFilter}
                      isLoggedIn={isLoggedIn}
                      onEdit={(r)=>openEdit(r)}
                      onJumpDay={(dk)=>{ setSelectedDate(dk); setTab("day"); }}
                    />
                  </div>

                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                    <div className="font-black text-slate-800">Êúà„Å∏„Ç∏„É£„É≥„Éó</div>
                    <div className="mt-2 grid grid-cols-3 gap-2">
                      {Array.from({length:12}, (_,i)=>i+1).map(mm => {
                        const mk = (mm>=4) ? `${fyInfo.fy}-${pad2(mm)}` : `${fyInfo.fy+1}-${pad2(mm)}`;
                        return (
                          <a key={mk} href={`#ym-${mk}`} className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700 text-center">
                            {mk.slice(5)}
                          </a>
                        );
                      })}
                    </div>
                    <div className="mt-4 text-xs font-bold text-slate-500 space-y-1">
                      <div>„Éª„ÄåÂπ¥Èñì‰∏ÄÊã¨„Ç§„É≥„Éù„Éº„Éà„Äç„ÅØ„ÄÅExcel/„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åã„ÇâË≤º„Çä‰ªò„Åë‚Üí„Éó„É¨„Éì„É•„Éº‚Üí‰∏ÄÊã¨ÁôªÈå≤„ÄÇ</div>
                      <div>„Éª„Ç§„É≥„Éù„Éº„Éà/Á∑®ÈõÜ„ÅØ„É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„Åø„ÄÇ</div>
                    </div>
                  </div>
                </div>
              </Card>
            )}

            {tab === "equip" && (
              <Card printCard>
                <SectionTitle
                  icon="üß∞"
                  title="Ê©üÊùê„Éû„Çπ„Çø"
                  sub="Ê©üÊùê„ÅÆÁ®ÆÈ°û„ÉªÂè∞Êï∞ÔºàÁ∑èÊï∞Ôºâ„ÇíËøΩÂä†/Â§âÊõ¥„Åß„Åç„Åæ„Åô"
                />

                <div className="mt-4">
                  {!isLoggedIn ? (
                    <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">Á∑®ÈõÜ„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                  ) : null}

                  <EquipmentManager
                    equipments={equipments}
                    setEquipments={setEquipments}
                    isLoggedIn={isLoggedIn}
                    busy={busy}
                    onSaved={() => refreshMasters()}
                    bumpReads={bumpReads}
                    bumpWrites={bumpWrites}
                  />
                </div>

                <div className="mt-4 rounded-3xl border border-slate-100 bg-slate-50 p-4">
                  <div className="font-black text-slate-800">„É°„É¢</div>
                  <ul className="mt-2 text-sm font-bold text-slate-700 list-disc pl-5 space-y-1">
                    <li>„Äåactive = false„Äç„ÅØÂâäÈô§„Åß„ÅØ„Å™„Åè<strong>ÈùûË°®Á§∫</strong>„Åß„ÅôÔºàÈÅéÂéª„Éá„Éº„Çø‰øùË≠∑Ôºâ„ÄÇ</li>
                    <li>‰∫àÁ¥ÑÂÖ•Âäõ/Ë∂ÖÈÅé„ÉÅ„Çß„ÉÉ„ÇØ/„É¢„Éã„Çø„ÉºË°®Á§∫„ÅØ„ÄÅactive„Å™Ê©üÊùê„Å´ËøΩÂæì„Åó„Åæ„Åô„ÄÇ</li>
                  </ul>
                </div>
              </Card>
            )}

            {tab === "rooms" && (
              <Card printCard>
                <SectionTitle
                  icon="üè¢"
                  title="ÈÉ®Â±ã„Éû„Çπ„Çø"
                  sub="ÈÉ®Â±ãÂêç„ÅÆËøΩÂä†/Â§âÊõ¥/ÈùûË°®Á§∫ÔºàÂâäÈô§„Åó„Å™„ÅÑÔºâ"
                />

                <div className="mt-4">
                  {!isLoggedIn ? (
                    <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">Á∑®ÈõÜ„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                  ) : null}

                  <RoomManager
                    rooms={rooms}
                    setRooms={setRooms}
                    isLoggedIn={isLoggedIn}
                    busy={busy}
                    onSaved={() => refreshMasters()}
                    bumpReads={bumpReads}
                    bumpWrites={bumpWrites}
                  />
                </div>

                <div className="mt-4 rounded-3xl border border-slate-100 bg-slate-50 p-4">
                  <div className="font-black text-slate-800">„É°„É¢</div>
                  <ul className="mt-2 text-sm font-bold text-slate-700 list-disc pl-5 space-y-1">
                    <li>„Äåactive = false„Äç„ÅØ<strong>ÈùûË°®Á§∫</strong>„Åß„ÅôÔºà‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÂ£ä„Åó„Åæ„Åõ„ÇìÔºâ„ÄÇ</li>
                    <li>Ë°®Á§∫È†Ü„ÅØ order „ÅßË™øÊï¥„Åß„Åç„Åæ„ÅôÔºàÂ∞è„Åï„ÅÑ„Åª„Å©‰∏äÔºâ„ÄÇ</li>
                  </ul>
                </div>
              </Card>
            )}

            {tab === "help" && (
              <Card printCard>
                <SectionTitle
                  icon="‚öôÔ∏è"
                  title="Ë®≠ÂÆö"
                  sub="ÂÖ•Âè£„É¢„Éã„Çø„Éº„ÅÆÊôÇÈñìËª∏ / read-writeÔºàÊ¶ÇÁÆóÔºâ / ÈÅãÁî®"
                />

                <div className="mt-4 grid md:grid-cols-2 gap-3">
                  <div className="rounded-3xl border border-slate-100 bg-white p-4">
                    <div className="font-black text-slate-800">ÂÖ•Âè£„É¢„Éã„Çø„ÉºË®≠ÂÆö</div>
                    <div className="text-xs font-bold text-slate-500 mt-2">‚ÄªÂ§âÊõ¥„Éª‰øùÂ≠ò„ÅØ <span className="text-slate-900">„É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„Åø</span> „Åß„Åç„Åæ„ÅôÔºàË°®Á§∫„ÅØÂÖ®Âì°OKÔºâ</div>

                    <div className="mt-3 grid grid-cols-2 gap-2">
                      <div>
                        <div className="text-xs font-black text-slate-600 mb-1">ÈñãÂßã</div>
                        <input type="time" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={monitorDraft.startHHMM} onChange={(e)=>setMonitorDraft(d=>({ ...d, startHHMM:e.target.value }))} disabled={!isLoggedIn||busy} />
                      </div>
                      <div>
                        <div className="text-xs font-black text-slate-600 mb-1">ÁµÇ‰∫Ü</div>
                        <input type="time" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={monitorDraft.endHHMM} onChange={(e)=>setMonitorDraft(d=>({ ...d, endHHMM:e.target.value }))} disabled={!isLoggedIn||busy} />
                      </div>
                    </div>

                    <div className="mt-3 grid grid-cols-2 gap-2">
                      <div className="rounded-3xl border border-slate-100 bg-slate-50 p-3">
                        <div className="text-xs font-black text-slate-600">Ëá™Âãï„Éö„Éº„Ç∏ÈÄÅ„Çä</div>
                        <label className="mt-2 flex items-center gap-2 font-black text-slate-700">
                          <input type="checkbox" checked={!!monitorDraft.autoPage} onChange={(e)=>setMonitorDraft(d=>({ ...d, autoPage:e.target.checked }))} disabled={!isLoggedIn||busy} />
                          ON
                        </label>
                        <div className="text-[11px] font-bold text-slate-400 mt-1">ÈÉ®Â±ã„ÅåÂ§ö„ÅÑÊôÇ„Å´Ëá™Âãï„ÅßÂàáÊõø</div>
                      </div>
                      <div className="rounded-3xl border border-slate-100 bg-slate-50 p-3">
                        <div className="text-xs font-black text-slate-600">ÂàáÊõøÈñìÈöîÔºàÁßíÔºâ</div>
                        <input type="number" min="5" max="120" className="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={Number(monitorDraft.intervalSec||12)} onChange={(e)=>setMonitorDraft(d=>({ ...d, intervalSec:Number(e.target.value||12) }))} disabled={!isLoggedIn||busy} />
                        <div className="text-[11px] font-bold text-slate-400 mt-1">5„Äú120</div>
                      </div>
                    </div>

                    <div className="mt-3">
                      <div className="text-xs font-black text-slate-600 mb-1">1ÁîªÈù¢„Å´Ë°®Á§∫„Åô„ÇãÈÉ®Â±ãÊï∞</div>
                      <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={String(monitorDraft.roomsPerPage||"auto")} onChange={(e)=>setMonitorDraft(d=>({ ...d, roomsPerPage:e.target.value }))} disabled={!isLoggedIn||busy}>
                        <option value="auto">Ëá™ÂãïÔºàÁîªÈù¢„Çµ„Ç§„Ç∫Ôºâ</option>
                        <option value="6">6</option>
                        <option value="8">8</option>
                        <option value="10">10</option>
                        <option value="12">12</option>
                        <option value="16">16</option>
                      </select>
                    </div>

                    <div className="mt-3 flex gap-2">
                      <button
                        className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
                          (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
                        disabled={!isLoggedIn||busy}
                        onClick={() => {
                          const s = hhmmToMin(monitorDraft.startHHMM||"08:00");
                          const e = hhmmToMin(monitorDraft.endHHMM||"20:00");
                          if(!(e > s)){
                            setToast({ type:"ng", msg:"ÁµÇ‰∫Ü„ÅØÈñãÂßã„Çà„ÇäÂæå„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ" });
                            setTimeout(()=>setToast(null), 2200);
                            return;
                          }
                          const next = {
                            startHHMM: monitorDraft.startHHMM || "08:00",
                            endHHMM: monitorDraft.endHHMM || "20:00",
                            autoPage: !!monitorDraft.autoPage,
                            intervalSec: Math.max(5, Math.min(120, Number(monitorDraft.intervalSec||12))),
                            roomsPerPage: String(monitorDraft.roomsPerPage||"auto"),
                          };
                          setMonitorSettings(next);
                          saveMonitorSettingsLocal(next);
                          setToast({ type:"ok", msg:"ÂÖ•Âè£„É¢„Éã„Çø„ÉºË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü" });
                          setTimeout(()=>setToast(null), 1800);
                        }}
                      >
                        ‰øùÂ≠ò
                      </button>
                      <button
                        className={classNames("rounded-2xl px-4 py-3 font-black shadow-sm border",
                          busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-white text-slate-700 border-slate-200")}
                        onClick={() => setMonitorDraft(monitorSettings)}
                        disabled={busy}
                      >
                        Êàª„Åô
                      </button>
                    </div>
                  </div>

                  <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                    <div className="font-black text-slate-800">read/write „Ç´„Ç¶„É≥„ÉàÔºàÊ¶ÇÁÆóÔºâ</div>
                    <div className="text-sm font-bold text-slate-700 mt-2 space-y-1">
                      <div>„ÉªFirestore„ÅÆÂèñÂæó(get)„Åß read „Çí„ÄÅ‰øùÂ≠ò(set/add/delete)„Åß write „Çí<strong>Ê¶ÇÁÆó</strong>Âä†ÁÆó„Åó„Åæ„Åô„ÄÇ</div>
                      <div>„ÉªÊ∑ª‰ªò„ÅÆSchool Cal„Å®Âêå„ÅòÊñπÂºèÔºà„É≠„Éº„Ç´„É´ÈõÜË®àÔºâ„Åß„Åô„ÄÇ</div>
                      <div>„Éª„Éû„Çπ„ÇøÊõ¥Êñ∞/ÈÄ±„ÉªÊúà„ÉªÂπ¥Â∫¶„ÅÆÊõ¥Êñ∞„ÅØ read „ÅåÂ¢ó„Åà„Åæ„ÅôÔºàÂøÖË¶ÅÊôÇ„Å†„ÅëÊõ¥Êñ∞Êé®Â•®Ôºâ„ÄÇ</div>
                    </div>
                    <div className="mt-3">
                      <button className="px-4 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={resetOps}>‰ªäÊúà„ÅÆread/write„Çí„É™„Çª„ÉÉ„Éà</button>
                    </div>

                    <div className="mt-4 font-black text-slate-800">ÈÅãÁî®„Éí„É≥„Éà</div>
                    <ul className="mt-2 text-sm font-bold text-slate-700 list-disc pl-5 space-y-1">
                      <li>ÂÖ•Âè£„É¢„Éã„Çø„Éº„ÅØ„Äå„Çø„Ç§„É†„É©„Ç§„É≥„ÄçÊé®Â•®ÔºàÈÉ®Â±ã„ÅåÂ§ö„ÅÑ„Å®Ëá™Âãï„Åß„Éö„Éº„Ç∏ÈÄÅ„Çä„Åó„Åæ„ÅôÔºâ„ÄÇ</li>
                      <li>ÈÉ®Â±ã/Ê©üÊùê„ÅØÂâäÈô§„Åß„ÅØ„Å™„Åè„ÄåÈùûË°®Á§∫„Äç„ÅßÈÅãÁî®„Åß„Åç„Åæ„Åô„ÄÇ</li>
                      <li>ÈÄ±„ÉªÊúà„ÉªÂπ¥Â∫¶„ÅØ„ÄåÊõ¥Êñ∞„Äç„Åß„Åæ„Å®„ÇÅ„Å¶ÂèñÂæóÔºàÂøÖË¶ÅÊôÇ„ÅÆ„ÅøÔºâ„ÄÇ</li>
                      <li>„Ç§„É≥„Éù„Éº„Éà„ÅØÂêå‰∏ÄÂÜÖÂÆπ„Å™„ÇâÂêå„ÅòID„Åß‰∏äÊõ∏„ÅçÔºàÈáçË§á„Åó„Å´„Åè„ÅÑÊñπÂºèÔºâ„ÄÇ</li>
                    </ul>
                  </div>
                </div>
              </Card>
            )}
          </div>

          <Modal
            open={editorOpen}
            onClose={()=>{ setEditorOpen(false); setEditModel(null); }}
            title={editModel?.id ? "‰∫àÁ¥Ñ„ÇíÁ∑®ÈõÜ" : "‰∫àÁ¥Ñ„ÇíËøΩÂä†"}
          >
            {editModel ? (
              <ReservationEditor
                model={editModel}
                setModel={setEditModel}
                roomsActive={roomsActive}
                equipmentsActive={equipmentsActive}
                busy={busy}
                isLoggedIn={isLoggedIn}
                onSave={saveReservation}
                onCancel={()=>{ setEditorOpen(false); setEditModel(null); }}
              />
            ) : null}
          </Modal>\n\n          <Modal\n            open={importOpen}\n            onClose={()=>{ if(!importBusy) setImportOpen(false); }}\n            title=\"Âπ¥Èñì‰∏ÄÊã¨„Ç§„É≥„Éù„Éº„Éà\"\n          >\n            <ImportModal\n              open={importOpen}\n              fyInfo={fyInfo}\n              roomsActive={roomsActive}\n              roomsMap={roomsMap}\n              equipmentsActive={equipmentsActive}\n              isLoggedIn={isLoggedIn}\n              importText={importText}\n              setImportText={setImportText}\n              importPreview={importPreview}\n              setImportPreview={setImportPreview}\n              importBusy={importBusy}\n              setImportBusy={setImportBusy}\n              bumpWrites={bumpWrites}\n              bumpReads={bumpReads}\n              setToast={setToast}\n              onDone={async ()=>{ setImportOpen(false); await refreshYear(); }}\n            />\n          </Modal>\n

          {toast ? (
            <div className={classNames(
              "fixed left-1/2 -translate-x-1/2 bottom-4 z-50 px-4 py-3 rounded-3xl shadow-lg border font-black no-print",
              toast.type==="ok" ? "bg-emerald-600 text-white border-emerald-700" : "bg-rose-600 text-white border-rose-700"
            )}>
              {toast.msg}
            </div>
          ) : null}

          <div className="fixed inset-x-0 bottom-0 z-30 bg-white/85 glass border-t border-slate-100 no-print">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
              <div className="text-xs font-bold text-slate-500">‚Äª„ÄåÊõ¥Êñ∞„Äç„ÅßFirestore„Åã„ÇâË™≠„ÅøËæº„ÅøÔºà„Ç™„Éï„É©„Ç§„É≥ÊôÇ„ÅØ„Ç≠„É£„ÉÉ„Ç∑„É•Ë°®Á§∫Ôºâ</div>
              <div className="text-xs font-bold text-slate-400">ÂÖ±ÈÄöIDÔºö{SHARED_LOGIN_CODE}</div>
            </div>
          </div>
        </div>
      );
    }

    /**********************
     * Login
     **********************/
    function LoginButton({busy, onLogin}){
      const [open, setOpen] = useState(false);
      const [pw, setPw] = useState("");

      return (
        <>
          <button
            className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
              busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-slate-900 text-white border-slate-900")}
            disabled={busy}
            onClick={()=>setOpen(true)}
          >
            „É≠„Ç∞„Ç§„É≥
          </button>

          <Modal open={open} onClose={()=>setOpen(false)} title="ÂÖ±ÈÄöID„É≠„Ç∞„Ç§„É≥">
            <div className="space-y-3">
              <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                <div className="font-black text-slate-800">„Éë„Çπ„ÉØ„Éº„Éâ</div>
                <div className="text-xs font-bold text-slate-500 mt-1">ÂÖ±ÈÄöIDÔºö{SHARED_LOGIN_CODE}</div>
                <input
                  type="password"
                  className="mt-3 w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                  value={pw}
                  onChange={(e)=>setPw(e.target.value)}
                  placeholder="„Éë„Çπ„ÉØ„Éº„Éâ"
                />
                <div className="mt-3 flex gap-2">
                  <button
                    className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
                      busy ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
                    disabled={busy}
                    onClick={()=>{ onLogin(pw); setOpen(false); setPw(""); }}
                  >
                    „É≠„Ç∞„Ç§„É≥
                  </button>
                  <button className="rounded-2xl px-4 py-3 font-black bg-white border border-slate-200 text-slate-700" onClick={()=>setOpen(false)}>
                    „Ç≠„É£„É≥„Çª„É´
                  </button>
                </div>
              </div>
            </div>
          </Modal>
        </>
      );
    }

    /**********************
     * Reservation Editor
     **********************/
    function ReservationEditor({model, setModel, roomsActive, equipmentsActive, busy, isLoggedIn, onSave, onCancel}){
      const roomGroups = useMemo(() => {
        const g = {};
        for(const r of roomsActive){
          const b = r.building || "„Åù„ÅÆ‰ªñ";
          if(!g[b]) g[b] = [];
          g[b].push(r);
        }
        return g;
      }, [roomsActive]);

      function setField(k,v){ setModel(prev => ({ ...prev, [k]: v })); }
      function setEquip(k,v){
        const n = Math.max(0, Math.min(999, Number(v)||0));
        setModel(prev => ({ ...prev, equipment: { ...(prev.equipment||{}), [k]: n }}));
      }

      const opts10 = useMemo(() => {
        const a = [];
        for(let m=0; m<=23*60+50; m+=10) a.push({ value:m, label:minToHHMM(m) });
        return a;
      }, []);
      const endOpts = opts10.filter(o => o.value >= (Number(model.startMin)||0) + 10);

      return (
        <div className="space-y-4">
          {!isLoggedIn ? (
            <div className="p-4 rounded-3xl bg-amber-50 border border-amber-100 text-amber-800 font-bold">
              Á∑®ÈõÜ„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÈñ≤Ë¶ß„É¢„Éº„Éâ„Åß„ÅØ‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„ÇìÔºâ
            </div>
          ) : null}

          <div className="grid md:grid-cols-2 gap-3">
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">Êó•‰ªò</div>
              <input type="date" className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.date} onChange={(e)=>setField("date", e.target.value)} />
            </div>
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">ÈÉ®Â±ã</div>
              <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.roomId} onChange={(e)=>setField("roomId", e.target.value)}>
                {Object.keys(roomGroups).map(b => (
                  <optgroup key={b} label={b}>
                    {roomGroups[b].map(r => (
                      <option key={r.id} value={r.id}>{r.name}</option>
                    ))}
                  </optgroup>
                ))}
              </select>
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-3">
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">ÈñãÂßãÔºà10ÂàÜÂçò‰ΩçÔºâ</div>
              <select
                className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700"
                value={model.startMin}
                onChange={(e)=>{
                  const s = Number(e.target.value);
                  const eMin = Number(model.endMin)||0;
                  setField("startMin", s);
                  if(eMin <= s) setField("endMin", s+10);
                }}
              >
                {opts10.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>
            </div>
            <div>
              <div className="text-sm font-black text-slate-700 mb-2">ÁµÇ‰∫ÜÔºàÈñãÂßãÔºã10ÂàÜ‰ª•‰∏äÔºâ</div>
              <select className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.endMin} onChange={(e)=>setField("endMin", Number(e.target.value))}>
                {endOpts.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>
            </div>
          </div>

          <div>
            <div className="text-sm font-black text-slate-700 mb-2">Âõ£‰ΩìÂêçÔºàÂøÖÈ†àÔºâ</div>
            <input className="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-bold text-slate-700" value={model.groupName} onChange={(e)=>setField("groupName", e.target.value)} placeholder="‰æãÔºö‚óã‚óãÁ†îÁ©∂‰ºö„ÄÅ‚ñ≥‚ñ≥„ÇØ„É©„Éñ „Å™„Å©" />
          </div>

          <div className="grid md:grid-cols-2 gap-3">
            <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">Ê©üÊùê</div>
              <div className="mt-3 space-y-3">
                {equipmentsActive.length === 0 ? (
                  <div className="text-xs font-bold text-slate-400">Ê©üÊùê„Éû„Çπ„Çø„ÅåÊú™Ë®≠ÂÆö„Åß„ÅôÔºàÊ©üÊùê„Çø„Éñ„ÅßËøΩÂä†Ôºâ</div>
                ) : equipmentsActive.map(e => (
                  <div key={e.id} className="flex items-center justify-between gap-2">
                    <div className="font-bold text-slate-700">{e.name}</div>
                    <input type="number" min="0" max="999" className="w-28 text-right rounded-2xl border border-slate-200 bg-white px-3 py-2 font-black text-slate-700" value={model?.equipment?.[e.id] ?? 0} onChange={(ev)=>setEquip(e.id, ev.target.value)} />
                  </div>
                ))}
                <div className="text-xs font-bold text-slate-400">‚Äª‰øùÂ≠òÂâç„Å´„ÄåÂêåÊôÇÈñìÂ∏Ø„ÅßÁ∑èÊï∞Ë∂ÖÈÅé„Äç„ÇíË≠¶Âëä„Åó„Åæ„Åô</div>
              </div>
            </div>

            <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
              <div className="font-black text-slate-800">„É°„É¢Ôºà‰ªªÊÑèÔºâ</div>
              <textarea className="mt-3 w-full h-28 rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" value={model.note} onChange={(e)=>setField("note", e.target.value)} placeholder="‰æãÔºöÊú∫ÈÖçÁΩÆ„ÄÅÊù•È§®ÊôÇÈñì„ÅÆÁõÆÂÆâ„ÄÅÈçµ„ÅÆÂèó„ÅëÊ∏°„Åó „Å™„Å©" />
            </div>
          </div>

          <div className="flex items-center gap-2">
            <button
              className={classNames("w-full rounded-2xl px-4 py-3 font-black shadow-sm border",
                (!isLoggedIn || busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")}
              disabled={!isLoggedIn || busy}
              onClick={()=>onSave(model)}
            >
              ‰øùÂ≠ò
            </button>
            <button className="rounded-2xl px-4 py-3 font-black bg-white border border-slate-200 text-slate-700" onClick={onCancel}>
              „Ç≠„É£„É≥„Çª„É´
            </button>
          </div>
        </div>
      );
    }

    /**********************
     * Monitor Board
     **********************/
    function MonitorBoard({dateKey, rooms, reservations, equipmentsActive}){
      const byRoom = useMemo(() => {
        const m = {};
        for(const r of rooms) m[r.id] = [];
        for(const rr of reservations||[]){
          if(!m[rr.roomId]) m[rr.roomId] = [];
          m[rr.roomId].push(rr);
        }
        for(const k of Object.keys(m)) m[k].sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
        return m;
      }, [rooms, reservations]);

      const usedRooms = rooms.filter(r => (byRoom[r.id]||[]).length > 0);

      return (
        <div className="mt-4">
          {usedRooms.length === 0 ? (
            <div className="rounded-3xl border border-slate-100 bg-slate-50 p-6">
              <div className="text-2xl font-black text-slate-800">{dateKey} „ÅÆ‰∫àÁ¥Ñ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
              <div className="text-sm font-bold text-slate-500 mt-2">‚ÄªÊõ¥Êñ∞„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„ÄåÊõ¥Êñ∞„Äç</div>
            </div>
          ) : (
            <div className="grid lg:grid-cols-2 gap-4">
              {usedRooms.map(room => (
                <div key={room.id} className="rounded-3xl border border-slate-100 bg-white p-5">
                  <div className="flex items-start justify-between gap-2">
                    <div>
                      <div className="text-xs font-black text-slate-400">{room.building}</div>
                      <div className="text-2xl md:text-3xl font-black text-slate-900 mt-1">{room.name}</div>
                    </div>
                    <Pill tone="slate">{(byRoom[room.id]||[]).length}‰ª∂</Pill>
                  </div>

                  <div className="mt-4 space-y-3">
                    {(byRoom[room.id]||[]).map(r => (
                      <div key={r.id} className="p-4 rounded-3xl bg-slate-50 border border-slate-100">
                        <div className="text-2xl md:text-3xl font-black text-slate-900">
                          {minToHHMM(r.startMin||0)}‚Äì{minToHHMM(r.endMin||0)}
                        </div>
                        <div className="text-xl md:text-2xl font-black text-slate-800 mt-1 break-words">{r.groupName}</div>
                        <div className="mt-2 flex flex-wrap gap-2">
                          {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                            <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                          ) : null)}
                          {r.note ? <Pill tone="slate">„É°„É¢</Pill> : null}
                        </div>
                        {r.note ? <div className="text-sm font-bold text-slate-600 mt-2">{r.note}</div> : null}
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }



    /**********************
     * Month Calendar
     **********************/
    function MonthCalendar({monthKey, reservations, roomsMap, onPickDate}){
      const [y,m] = String(monthKey||"").split("-").map(Number);
      const first = new Date(y, (m||1)-1, 1);
      // Monday-start calendar
      const firstDow = (first.getDay() + 6) % 7; // 0=Mon
      const daysInMonth = new Date(y, (m||1), 0).getDate();
      const prevMonthDays = new Date(y, (m||1)-1, 0).getDate();

      const byDate = useMemo(() => {
        const mp = {};
        for(const r of reservations||[]){
          const dk = r.date;
          if(!mp[dk]) mp[dk] = [];
          mp[dk].push(r);
        }
        for(const k of Object.keys(mp)) mp[k].sort((a,b)=>(Number(a.startMin||0)-Number(b.startMin||0)));
        return mp;
      }, [reservations]);

      const cells = [];
      const total = 42; // 6 weeks
      for(let i=0;i<total;i++){
        const dayNum = i - firstDow + 1;
        let cy=y, cm=m, cd=dayNum, inMonth=true;
        if(dayNum <= 0){
          const pm = addMonthsKey(monthKey, -1);
          const [py,pm2] = pm.split('-').map(Number);
          cy=py; cm=pm2; cd=prevMonthDays + dayNum; inMonth=false;
        }else if(dayNum > daysInMonth){
          const nm = addMonthsKey(monthKey, 1);
          const [ny,nm2] = nm.split('-').map(Number);
          cy=ny; cm=nm2; cd=dayNum - daysInMonth; inMonth=false;
        }
        const dk = dateKeyFromParts(cy, cm, cd);
        cells.push({ dk, inMonth, cd });
      }

      const names = ["Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü","Êó•"];

      return (
        <div className="mt-4">
          <div className="grid grid-cols-7 gap-2">
            {names.map(n => (
              <div key={n} className="text-xs font-black text-slate-500 px-2">{n}</div>
            ))}

            {cells.map(c => {
              const list = byDate[c.dk] || [];
              const isToday = c.dk === todayKeyLocal();
              return (
                <button
                  key={c.dk}
                  className={classNames(
                    "rounded-2xl border p-2 text-left min-h-[98px] hover:bg-slate-50 break-avoid",
                    c.inMonth ? "bg-white border-slate-200" : "bg-slate-50 border-slate-100",
                    isToday ? "ring-2 ring-sky-300" : ""
                  )}
                  onClick={()=>onPickDate(c.dk)}
                >
                  <div className="flex items-center justify-between">
                    <div className={classNames("text-sm font-black", c.inMonth ? "text-slate-900" : "text-slate-400")}>{c.cd}</div>
                    {list.length ? <span className="text-[11px] font-black text-slate-500">{list.length}</span> : null}
                  </div>
                  <div className="mt-1 space-y-1">
                    {list.slice(0,2).map(r => (
                      <div key={r.id} className="text-[11px] font-black text-slate-700 truncate">
                        {minToHHMM(r.startMin||0)} {roomsMap[r.roomId]?.name || r.roomId} / {r.groupName}
                      </div>
                    ))}
                    {list.length>2 ? <div className="text-[11px] font-black text-slate-400">‚Ä¶„Åª„Åã {list.length-2}‰ª∂</div> : null}
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    /**********************
     * Year Grouped List
     **********************/
    function YearGroupedList({fyInfo, roomsMap, equipmentsActive, reservations, query, roomFilter, isLoggedIn, onEdit, onJumpDay}){
      const q = (query||"").trim().toLowerCase();
      const filtered = useMemo(() => {
        return (reservations||[]).filter(r => {
          if(roomFilter !== "all" && r.roomId !== roomFilter) return false;
          if(!q) return true;
          const t = `${r.groupName||""} ${r.note||""}`.toLowerCase();
          return t.includes(q);
        });
      }, [reservations, q, roomFilter]);

      const months = useMemo(() => {
        const order = [];
        for(let m=4;m<=12;m++) order.push(`${fyInfo.fy}-${pad2(m)}`);
        for(let m=1;m<=3;m++) order.push(`${fyInfo.fy+1}-${pad2(m)}`);
        const by = {};
        for(const mk of order) by[mk] = [];
        for(const r of filtered){
          const mk = String(r.date||"").slice(0,7);
          if(!by[mk]) by[mk] = [];
          by[mk].push(r);
        }
        for(const mk of Object.keys(by)){
          by[mk].sort((a,b)=>(String(a.date||"").localeCompare(String(b.date||"")) || Number(a.startMin||0)-Number(b.startMin||0) || String(a.roomId||"").localeCompare(String(b.roomId||""))));
        }
        return { order, by };
      }, [filtered, fyInfo]);

      return (
        <div className="mt-4 space-y-4 max-h-[65vh] overflow-auto pr-1 no-scrollbar">
          {months.order.map(mk => {
            const list = months.by[mk] || [];
            if(list.length===0) return null;
            return (
              <div key={mk} id={`ym-${mk}`} className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-black text-slate-900">{mk}</div>
                  <Pill tone="slate">{list.length}‰ª∂</Pill>
                </div>
                <div className="mt-3 columns-1 md:columns-2 xl:columns-3 gap-3">
                  {list.map(r => (
                    <div key={r.id} className="break-avoid mb-3 rounded-2xl border border-slate-200 bg-white p-3">
                      <div className="font-black text-slate-900">{r.date} {minToHHMM(r.startMin||0)}‚Äì{minToHHMM(r.endMin||0)}</div>
                      <div className="text-xs font-black text-slate-600 mt-1">{roomsMap[r.roomId]?.building || ""} / {roomsMap[r.roomId]?.name || r.roomId}</div>
                      <div className="text-sm font-black text-slate-800 mt-1 break-words">{r.groupName}</div>
                      {r.note ? <div className="text-xs font-bold text-slate-500 mt-1 break-words">{r.note}</div> : null}
                      <div className="mt-2 flex flex-wrap gap-1">
                        {equipmentsActive.map(e => (Number(r?.equipment?.[e.id]||0)>0) ? (
                          <Pill key={e.id} tone="sky">{(e.abbr||e.name)} {Number(r.equipment[e.id]||0)}</Pill>
                        ) : null)}
                      </div>
                      <div className="mt-2 flex gap-2 no-print">
                        <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>onJumpDay(r.date)}>Êó•„Å∏</button>
                        {isLoggedIn ? (
                          <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>onEdit(r)}>Á∑®ÈõÜ</button>
                        ) : null}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
          {filtered.length===0 ? (
            <div className="text-sm font-bold text-slate-400 p-3">Âπ¥Èñì„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºà„ÄåÂπ¥Èñì„ÇíÊõ¥Êñ∞„Äç„Åæ„Åü„ÅØÁµû„ÇäËæº„ÅøÊù°‰ª∂„ÇíË¶ãÁõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ</div>
          ) : null}
        </div>
      );
    }

    /**********************
     * Monitor Timeline Board
     **********************/
    function MonitorTimelineBoard({dateKey, rooms, reservations, equipmentsActive, startHHMM, endHHMM, autoPage, intervalSec, roomsPerPage}){
      const startMin = hhmmToMin(startHHMM||"08:00");
      const endMin = hhmmToMin(endHHMM||"20:00");
      const range = Math.max(60, endMin - startMin);

      const byRoom = useMemo(() => {
        const m = {};
        for(const r of rooms) m[r.id] = [];
        for(const rr of reservations||[]){
          if(!m[rr.roomId]) m[rr.roomId] = [];
          m[rr.roomId].push(rr);
        }
        for(const k of Object.keys(m)) m[k].sort((a,b)=>Number(a.startMin||0)-Number(b.startMin||0));
        return m;
      }, [rooms, reservations]);

      const usedRooms = useMemo(() => rooms.filter(r => (byRoom[r.id]||[]).length > 0), [rooms, byRoom]);

      const wrapRef = useRef(null);
      const [autoPerPage, setAutoPerPage] = useState(8);
      useEffect(() => {
        if(String(roomsPerPage||"auto") !== "auto") return;
        const calc = () => {
          const h = wrapRef.current?.clientHeight || 600;
          const per = Math.max(4, Math.min(16, Math.floor((h - 64) / 74)));
          setAutoPerPage(per);
        };
        calc();
        window.addEventListener("resize", calc);
        return () => window.removeEventListener("resize", calc);
      }, [roomsPerPage]);

      const perPage = (String(roomsPerPage||"auto") === "auto") ? autoPerPage : Math.max(1, Number(roomsPerPage||autoPerPage));
      const pages = Math.max(1, Math.ceil(usedRooms.length / perPage));
      const [page, setPage] = useState(0);

      useEffect(() => { setPage(0); }, [dateKey, perPage, usedRooms.length]);

      useEffect(() => {
        if(!autoPage || pages<=1) return;
        const ms = Math.max(5, Number(intervalSec||12)) * 1000;
        const t = setInterval(() => setPage(p => (p+1)%pages), ms);
        return () => clearInterval(t);
      }, [autoPage, intervalSec, pages]);

      const pageRooms = usedRooms.slice(page*perPage, (page+1)*perPage);

      const hourTicks = useMemo(() => {
        const ticks = [];
        const startH = Math.ceil(startMin/60);
        const endH = Math.floor(endMin/60);
        for(let h=startH; h<=endH; h++){
          const t = h*60;
          if(t>=startMin && t<=endMin) ticks.push(t);
        }
        return ticks;
      }, [startMin, endMin]);

      const leftW = 220;

      return (
        <div className="mt-4 rounded-3xl border border-slate-100 bg-white overflow-hidden" style={{height:"calc(100vh - 280px)", minHeight:480}}>
          <div className="h-full flex flex-col" ref={wrapRef}>
            <div className="flex items-center justify-between px-4 py-3 border-b border-slate-100 bg-slate-50">
              <div className="font-black text-slate-800">{dateKey} / ‰∫àÁ¥Ñ„ÅÆ„ÅÇ„ÇãÈÉ®Â±ã„ÅÆ„ÅøË°®Á§∫</div>
              <div className="flex items-center gap-2">
                {pages>1 ? (
                  <div className="text-xs font-black text-slate-600">{page+1}/{pages}</div>
                ) : null}
                {pages>1 ? (
                  <>
                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setPage(p=> (p-1+pages)%pages)}>Ââç</button>
                    <button className="px-3 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setPage(p=> (p+1)%pages)}>Ê¨°</button>
                  </>
                ) : null}
              </div>
            </div>

            {usedRooms.length===0 ? (
              <div className="p-6 text-sm font-bold text-slate-500">„Åì„ÅÆÊó•„ÅØ‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>
            ) : (
              <div className="flex-1 overflow-hidden">
                <div className="h-full grid" style={{gridTemplateColumns:`${leftW}px 1fr`}}>
                  <div className="px-3 py-2 border-b border-slate-100 bg-white font-black text-slate-600">ÈÉ®Â±ã</div>
                  <div className="px-3 py-2 border-b border-slate-100 bg-white relative">
                    <div className="relative h-8">
                      {hourTicks.map(t => {
                        const x = ((t-startMin)/range)*100;
                        return (
                          <div key={t} className="absolute top-0 bottom-0" style={{left:`${x}%`}}>
                            <div className="w-px h-full bg-slate-200"></div>
                            <div className="text-[10px] font-black text-slate-500 -translate-x-1/2 mt-1">{minToHHMM(t)}</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {pageRooms.map(room => {
                    const list = byRoom[room.id] || [];
                    return (
                      <React.Fragment key={room.id}>
                        <div className="px-3 py-3 border-b border-slate-100 bg-white">
                          <div className="text-xs font-black text-slate-500">{room.building}</div>
                          <div className="font-black text-slate-800">{room.name}</div>
                        </div>
                        <div className="px-3 py-2 border-b border-slate-100 bg-white relative">
                          <div className="relative h-14 rounded-2xl bg-slate-50 border border-slate-100 overflow-hidden">
                            {hourTicks.map(t => {
                              const x = ((t-startMin)/range)*100;
                              return <div key={t} className="absolute top-0 bottom-0" style={{left:`${x}%`}}><div className="w-px h-full bg-slate-200"></div></div>;
                            })}
                            {list.map(r => {
                              const s = Math.max(startMin, Number(r.startMin||0));
                              const e = Math.min(endMin, Number(r.endMin||0));
                              const left = ((s-startMin)/range)*100;
                              const width = Math.max(1, ((e-s)/range)*100);
                              const eqBadges = equipmentsActive
                                .filter(e0 => Number(r?.equipment?.[e0.id]||0)>0)
                                .slice(0,3)
                                .map(e0 => `${e0.abbr||e0.name}${Number(r.equipment[e0.id]||0)}`)
                                .join(" ");
                              return (
                                <div
                                  key={r.id}
                                  className="absolute top-2 bottom-2 rounded-xl bg-sky-600/90 text-white px-2 flex items-center"
                                  style={{left:`${left}%`, width:`${width}%`}}
                                  title={`${minToHHMM(r.startMin||0)}-${minToHHMM(r.endMin||0)} ${r.groupName}`}
                                >
                                  <div className="min-w-0">
                                    <div className="text-[11px] font-black truncate">{r.groupName}</div>
                                    <div className="text-[10px] font-black text-white/90 truncate">{minToHHMM(r.startMin||0)}‚Äì{minToHHMM(r.endMin||0)}{eqBadges ? ` / ${eqBadges}` : ""}</div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </React.Fragment>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    /**********************
     * Import Modal (bulk import)
     **********************/
    function ImportModal({open, fyInfo, roomsActive, roomsMap, equipmentsActive, isLoggedIn, importText, setImportText, importPreview, setImportPreview, importBusy, setImportBusy, bumpWrites, bumpReads, setToast, onDone}){
      const templateHeaders = useMemo(() => {
        const base = ["Êó•‰ªò","ÈñãÂßã","ÁµÇ‰∫Ü","ÈÉ®Â±ã","Âõ£‰ΩìÂêç","„É°„É¢"];
        const eq = equipmentsActive.map(e => e.abbr || e.id);
        return base.concat(eq);
      }, [equipmentsActive]);

      const roomIndex = useMemo(() => {
        const idx = {};
        for(const r of roomsActive||[]){
          idx[String(r.id).toLowerCase()] = r.id;
          idx[String(r.name).toLowerCase()] = r.id;
          idx[`${String(r.building||"")}/${String(r.name||"")}`.toLowerCase()] = r.id;
          idx[`${String(r.building||"")} ${String(r.name||"")}`.toLowerCase()] = r.id;
        }
        return idx;
      }, [roomsActive]);

      const eqIndex = useMemo(() => {
        const idx = {};
        for(const e of equipmentsActive||[]){
          idx[String(e.id).toLowerCase()] = e.id;
          if(e.abbr) idx[String(e.abbr).toLowerCase()] = e.id;
          idx[String(e.name).toLowerCase()] = e.id;
        }
        return idx;
      }, [equipmentsActive]);

      const detectDelimiter = (firstLine) => (String(firstLine||"").includes("\t") ? "\t" : ",");

      const splitLine = (line, delim) => {
        const s = String(line||"");
        if(delim === "\t") return s.split("\t");
        // basic CSV (supports quotes)
        const res = [];
        let cur = "";
        let inQ = false;
        for(let i=0;i<s.length;i++){
          const ch = s[i];
          if(ch === '"'){
            if(inQ && s[i+1] === '"'){ cur += '"'; i++; }
            else inQ = !inQ;
          } else if(ch === ',' && !inQ){
            res.push(cur);
            cur = "";
          } else {
            cur += ch;
          }
        }
        res.push(cur);
        return res;
      };

      const norm = (v) => String(v ?? "").trim();
      const normKey = (v) => norm(v).toLowerCase().replace(/\s/g, "");

      const makeHeaderIndex = (headers) => {
        const hs = headers.map(normKey);
        const find = (keys) => {
          for(const k of keys){
            const i = hs.indexOf(k);
            if(i>=0) return i;
          }
          return -1;
        };
        const map = {
          date: find(["Êó•‰ªò","date","Âπ¥ÊúàÊó•","ymd" ]),
          start: find(["ÈñãÂßã","start","starttime","ÈñãÂßãÊôÇÂàª","ÈñãÂßãÊôÇÈñì" ]),
          end: find(["ÁµÇ‰∫Ü","end","endtime","ÁµÇ‰∫ÜÊôÇÂàª","ÁµÇ‰∫ÜÊôÇÈñì" ]),
          room: find(["ÈÉ®Â±ã","Â†¥ÊâÄ","room","roomid","roomname" ]),
          group: find(["Âõ£‰ΩìÂêç","‰∫àÁ¥ÑÂêç","Âõ£‰Ωì","title","name","group","Âà©Áî®ËÄÖ" ]),
          note: find(["„É°„É¢","ÂÇôËÄÉ","note","notes" ])
        };
        const eqCols = {}; // colIndex -> equipmentId
        headers.forEach((h, i) => {
          const k = normKey(h);
          if(eqIndex[k]) eqCols[i] = eqIndex[k];
        });
        return {map, eqCols};
      };

      const [showSample, setShowSample] = useState(false);

      const buildPreview = () => {
        const raw = String(importText||"").trim();
        if(!raw){
          setImportPreview(null);
          return;
        }
        const lines = raw.split(/\r?\n/).filter(l => String(l||"").trim() !== "");
        if(lines.length === 0){
          setImportPreview(null);
          return;
        }
        const delim = detectDelimiter(lines[0]);
        const first = splitLine(lines[0], delim);
        const headerLike = first.some(c => /Êó•‰ªò|date/i.test(String(c||"")));
        const headers = headerLike ? first : templateHeaders;
        const startIdx = headerLike ? 1 : 0;
        const {map, eqCols} = makeHeaderIndex(headers);

        const rows = [];
        const addRow = (obj) => rows.push(obj);

        for(let i=startIdx;i<lines.length;i++){
          const cells = splitLine(lines[i], delim);
          const get = (idx) => (idx>=0 && idx<cells.length) ? norm(cells[idx]) : "";
          const errors = [];
          const warns = [];

          const dateRaw = get(map.date);
          const startRaw = get(map.start);
          const endRaw = get(map.end);
          const roomRaw = get(map.room);
          const groupRaw = get(map.group);
          const noteRaw = get(map.note);

          const dk = parseDateLooseToKey(dateRaw);
          if(!dk) errors.push(`Êó•‰ªò„ÅåË™≠„ÇÅ„Åæ„Åõ„Çì: ${dateRaw}`);
          const sMin = parseHHMMLoose(startRaw);
          const eMin = parseHHMMLoose(endRaw);
          if(sMin==null) errors.push(`ÈñãÂßã„ÅåË™≠„ÇÅ„Åæ„Åõ„Çì: ${startRaw}`);
          if(eMin==null) errors.push(`ÁµÇ‰∫Ü„ÅåË™≠„ÇÅ„Åæ„Åõ„Çì: ${endRaw}`);
          if(sMin!=null && eMin!=null && eMin <= sMin) errors.push(`ÁµÇ‰∫Ü<=ÈñãÂßã (${startRaw}„Äú${endRaw})`);

          let roomId = "";
          const rk = normKey(roomRaw);
          if(rk && roomIndex[rk]) roomId = roomIndex[rk];
          if(!roomId) errors.push(`ÈÉ®Â±ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${roomRaw}`);

          if(!groupRaw) errors.push("Âõ£‰ΩìÂêç„ÅåÁ©∫„Åß„Åô");

          // fiscal-year guard (warn and skip)
          let skip = false;
          if(dk && (dk < fyInfo.start || dk > fyInfo.end)){
            warns.push(`Âπ¥Â∫¶Â§ñ„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó: ${dk}`);
            skip = true;
          }

          const equipment = {};
          for(const [col, eid] of Object.entries(eqCols)){
            const v = get(Number(col));
            if(v === "") continue;
            const n = Number(String(v).replace(/[^0-9.-]/g, ""));
            if(Number.isFinite(n) && n>0) equipment[eid] = Math.floor(n);
            else if(v) errors.push(`Ê©üÊùê(${headers[Number(col)]})„ÅåÊï∞ÂÄ§„Åß„ÅÇ„Çä„Åæ„Åõ„Çì: ${v}`);
          }

          const model = (errors.length===0 && !skip) ? {
            date: dk,
            roomId,
            startMin: sMin,
            endMin: eMin,
            groupName: groupRaw,
            note: noteRaw,
            equipment,
            updatedAt: serverTimestamp(),
          } : null;

          addRow({ line: i+1, raw: lines[i], errors, warns, skip, model });
        }

        // overlap check inside import set
        const buckets = {};
        rows.forEach((r, idx) => {
          if(!r.model) return;
          const key = `${r.model.date}|${r.model.roomId}`;
          if(!buckets[key]) buckets[key] = [];
          buckets[key].push({idx, r});
        });
        Object.values(buckets).forEach(arr => {
          arr.sort((a,b)=>a.r.model.startMin - b.r.model.startMin);
          for(let i=1;i<arr.length;i++){
            const prev = arr[i-1].r.model;
            const cur = arr[i].r.model;
            if(cur.startMin < prev.endMin){
              arr[i].r.errors.push("Âêå„ÅòÈÉ®Â±ã„ÅßÊôÇÈñì„ÅåÈáç„Å™„Å£„Å¶„ÅÑ„Åæ„ÅôÔºà„Ç§„É≥„Éù„Éº„ÉàÂÜÖÔºâ");
              arr[i-1].r.errors.push("Âêå„ÅòÈÉ®Â±ã„ÅßÊôÇÈñì„ÅåÈáç„Å™„Å£„Å¶„ÅÑ„Åæ„ÅôÔºà„Ç§„É≥„Éù„Éº„ÉàÂÜÖÔºâ");
              arr[i].r.model = null;
              arr[i-1].r.model = null;
            }
          }
        });

        const ok = rows.filter(r => r.model && r.errors.length===0 && !r.skip).length;
        const ng = rows.filter(r => r.errors.length>0).length;
        const skipped = rows.filter(r => r.skip).length;
        setImportPreview({ headers, rows, ok, ng, skipped });
      };

      const runImport = async () => {
        if(!isLoggedIn){
          setToast({type:"ng", msg:"„É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„Åø„Ç§„É≥„Éù„Éº„Éà„Åß„Åç„Åæ„Åô"});
          setTimeout(()=>setToast(null), 2500);
          return;
        }
        const rows = importPreview?.rows || [];
        const valids = rows.filter(r => r.model && r.errors.length===0 && !r.skip);
        if(valids.length===0){
          setToast({type:"ng", msg:"„Ç§„É≥„Éù„Éº„Éà„Åß„Åç„ÇãË°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"});
          setTimeout(()=>setToast(null), 2500);
          return;
        }
        setImportBusy(true);
        try{
          const CHUNK = 420;
          for(let i=0;i<valids.length;i+=CHUNK){
            const slice = valids.slice(i, i+CHUNK);
            const batch = db.batch();
            slice.forEach(row => {
              const m = row.model;
              const id = deterministicIdForReservation(m);
              const ref = db.collection("reservations").doc(id);
              const payload = {
                date: m.date,
                roomId: m.roomId,
                startMin: m.startMin,
                endMin: m.endMin,
                groupName: m.groupName,
                note: m.note,
                equipment: m.equipment,
                updatedAt: serverTimestamp(),
              };
              batch.set(ref, payload, {merge:true});
            });
            await batch.commit();
            bumpWrites(slice.length);
          }
          setToast({type:"ok", msg:`„Ç§„É≥„Éù„Éº„ÉàÂÆå‰∫ÜÔºö${valids.length}‰ª∂ÔºàÂπ¥Â∫¶Ôºö${fyInfo.label}Ôºâ`});
          setTimeout(()=>setToast(null), 3500);
          setImportPreview(null);
          // keep text for re-run; user can clear manually
          await onDone?.();
        }catch(e){
          console.error(e);
          setToast({type:"ng", msg:"„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"});
          setTimeout(()=>setToast(null), 3500);
        }finally{
          setImportBusy(false);
        }
      };

      const sampleText = useMemo(() => {
        const header = templateHeaders.join("\t");
        const room = (roomsActive && roomsActive[0]) ? roomsActive[0].name : "‰ºöË≠∞ÂÆ§";
        const line1 = `${fyInfo.fy}-04-10\t09:00\t10:00\t${room}\tËÅ∑Âì°‰ºöË≠∞\t\t1`;
        return `${header}\n${line1}`;
      }, [templateHeaders, fyInfo, roomsActive]);

      return (
        <div className="space-y-3">
          <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
            <div className="font-black text-slate-800">Ë≤º„Çä‰ªò„ÅëÂΩ¢ÂºèÔºàExcel„Åã„Çâ„ÅÆË≤º„Çä‰ªò„ÅëÊé®Â•®Ôºâ</div>
            <div className="text-sm font-bold text-slate-700 mt-2 space-y-1">
              <div>„Éª1Ë°åÁõÆ„ÅØ„Éò„ÉÉ„ÉÄ„ÉºÊé®Â•®Ôºö{templateHeaders.slice(0,6).join(" / ")} ...</div>
              <div>„ÉªÂå∫Âàá„Çä„ÅØ <strong>„Çø„Éñ</strong>ÔºàTSVÔºâ„Åã„Ç´„É≥„ÉûÔºàCSVÔºâ„ÄÇ</div>
              <div>„ÉªÈÉ®Â±ã„ÅØ„ÄåÂêçÂâç„Äç„Åã„ÄåÂª∫Áâ©/ÂêçÂâç„Äç„Åß„ÇÇOK„ÄÇ</div>
              <div>„ÉªÊ©üÊùê„ÅØÂàóÂêç„Çí <strong>Áï•Áß∞</strong> „Åæ„Åü„ÅØ Ê©üÊùêID „Å´„Åô„Çã„Å®Ë™çË≠ò„Åó„Åæ„Åô„ÄÇ</div>
              <div className="text-slate-500">‚ÄªÂπ¥Â∫¶Â§ñ„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàË≠¶ÂëäÔºâ„Å´„Å™„Çä„Åæ„Åô„ÄÇ</div>
            </div>
            <div className="mt-3 flex items-center gap-2">
              <button className="px-4 py-2 rounded-2xl bg-white border border-slate-200 font-black text-slate-700" onClick={()=>setShowSample(s=>!s)}>„ÉÜ„É≥„Éó„É¨/‰æã„Çí{showSample?"Èñâ„Åò„Çã":"Ë°®Á§∫"}</button>
              {isLoggedIn ? (
                <button className="px-4 py-2 rounded-2xl bg-slate-900 text-white font-black disabled:opacity-50" disabled={importBusy} onClick={buildPreview}>„Éó„É¨„Éì„É•„Éº‰ΩúÊàê</button>
              ) : (
                <Pill tone="rose">„É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„ÅøÊìç‰ΩúÂèØ</Pill>
              )}
              {isLoggedIn ? (
                <button className="px-4 py-2 rounded-2xl bg-sky-600 text-white font-black disabled:opacity-50" disabled={importBusy || !(importPreview?.ok>0)} onClick={runImport}>„Ç§„É≥„Éù„Éº„ÉàÂÆüË°å</button>
              ) : null}
            </div>
            {showSample ? (
              <div className="mt-3">
                <div className="text-xs font-black text-slate-500">„Ç≥„Éî„ÉöÁî®ÔºàTSVÔºâ</div>
                <pre className="mt-2 text-xs font-mono bg-white border border-slate-200 rounded-2xl p-3 overflow-auto">{sampleText}</pre>
              </div>
            ) : null}
          </div>

          <textarea
            value={importText}
            onChange={(e)=>setImportText(e.target.value)}
            placeholder={"„Åì„Åì„Å´Âπ¥ÈñìÂàÜ„ÇíË≤º„Çä‰ªò„ÅëÔºàTSV/CSVÔºâ"}
            className="w-full min-h-[220px] rounded-3xl border border-slate-200 bg-white p-4 font-mono text-sm"
            spellCheck={false}
            disabled={!isLoggedIn || importBusy}
          />

          {importPreview ? (
            <div className="rounded-3xl border border-slate-100 bg-white p-4">
              <div className="flex items-center justify-between gap-2 flex-wrap">
                <div className="font-black text-slate-800">„Éó„É¨„Éì„É•„Éº</div>
                <div className="flex gap-2">
                  <Pill tone="emerald">OK {importPreview.ok}</Pill>
                  <Pill tone="rose">NG {importPreview.ng}</Pill>
                  <Pill tone="slate">SKIP {importPreview.skipped}</Pill>
                </div>
              </div>
              <div className="mt-3 max-h-[45vh] overflow-auto pr-1">
                {importPreview.rows.slice(0, 60).map((r, idx) => (
                  <div key={idx} className={classNames(
                    "rounded-2xl border p-3 mb-2",
                    r.model ? "border-emerald-200 bg-emerald-50" : (r.skip ? "border-slate-200 bg-slate-50" : "border-rose-200 bg-rose-50")
                  )}>
                    <div className="text-xs font-black text-slate-600">{r.line}Ë°åÁõÆ</div>
                    <div className="text-sm font-bold text-slate-800 break-words mt-1">{r.raw}</div>
                    {r.errors.length ? (
                      <div className="text-xs font-black text-rose-700 mt-2">{r.errors.join(" / ")}</div>
                    ) : null}
                    {(!r.errors.length && r.warns.length) ? (
                      <div className="text-xs font-black text-slate-600 mt-2">{r.warns.join(" / ")}</div>
                    ) : null}
                  </div>
                ))}
                {importPreview.rows.length>60 ? (
                  <div className="text-xs font-bold text-slate-400">‚Ä¶ÊÆã„Çä {importPreview.rows.length-60} Ë°åÔºàË°®Á§∫„ÅØÊúÄÂ§ß60Ë°åÔºâ</div>
                ) : null}
              </div>
            </div>
          ) : null}
        </div>
      );
    }
    /**********************
     * Room Manager
     **********************/
    function RoomManager({rooms, setRooms, isLoggedIn, busy, onSaved, bumpReads, bumpWrites}){
      const [draft, setDraft] = useState({ id:"", building:"Êú¨È§®", name:"", order: 100, active:true });

      const sorted = useMemo(() =>
        (rooms||[]).slice().sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.building||"").localeCompare(String(b.building||"")) || String(a.name||"").localeCompare(String(b.name||"")))
      , [rooms]);

      async function saveOne(r){
        if(!isLoggedIn) return;
        if(!r.id) return alert("id„ÅåÂøÖË¶Å„Åß„Åô");
        const payload = {
          name: (r.name||"").trim(),
          building: (r.building||"").trim(),
          order: Number(r.order||0),
          active: r.active !== false,
          updatedAt: serverTimestamp(),
        };
        await db.collection("rooms").doc(r.id).set(payload, { merge:true });
        bumpWrites(1);
        onSaved();
      }

      async function addNew(){
        if(!isLoggedIn) return;
        const id = (draft.id||"").trim();
        const name = (draft.name||"").trim();
        if(!id || !name) return alert("id „Å® ÈÉ®Â±ãÂêç„ÅåÂøÖË¶Å„Åß„Åô");
        const ref = db.collection("rooms").doc(id);
        const snap = await ref.get();
        bumpReads(1);
        if(snap.exists){
          alert("Âêå„Åòid„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„ÅôÔºàÂà•„ÅÆid„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ");
          return;
        }
        await ref.set({
          name,
          building: (draft.building||"").trim(),
          order: Number(draft.order||0),
          active: draft.active !== false,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }, { merge:true });
        bumpWrites(1);
        setDraft({ id:"", building: draft.building || "Êú¨È§®", name:"", order: Number(draft.order||100), active:true });
        onSaved();
      }

      function updateLocal(id, patch){
        setRooms(prev => (prev||[]).map(r => r.id===id ? ({...r, ...patch}) : r));
      }

      return (
        <div className="space-y-4">
          <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
            <div className="font-black text-slate-800">ÈÉ®Â±ã„ÇíËøΩÂä†</div>
            <div className="mt-3 grid md:grid-cols-5 gap-2">
              <input className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="idÔºà‰æãÔºöhonkan_3fÔºâ" value={draft.id} onChange={(e)=>setDraft(d=>({...d, id:e.target.value}))} disabled={!isLoggedIn||busy} />
              <select className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" value={draft.building} onChange={(e)=>setDraft(d=>({...d, building:e.target.value}))} disabled={!isLoggedIn||busy}>
                <option value="Êú¨È§®">Êú¨È§®</option>
                <option value="Âà•È§®">Âà•È§®</option>
                <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
              </select>
              <input className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="ÈÉ®Â±ãÂêç" value={draft.name} onChange={(e)=>setDraft(d=>({...d, name:e.target.value}))} disabled={!isLoggedIn||busy} />
              <input type="number" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="order" value={draft.order} onChange={(e)=>setDraft(d=>({...d, order:e.target.value}))} disabled={!isLoggedIn||busy} />
              <button className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")} onClick={addNew} disabled={!isLoggedIn||busy}>
                ËøΩÂä†
              </button>
            </div>
            <div className="mt-2 text-xs font-bold text-slate-400">‚ÄªÂâäÈô§„Åß„ÅØ„Å™„Åè„Äåactive=false„Äç„ÅßÈùûË°®Á§∫ÈÅãÁî®</div>
          </div>

          <div className="rounded-3xl border border-slate-100 bg-white p-3 overflow-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left text-xs font-black text-slate-500">
                  <th className="p-2">Ë°®Á§∫</th>
                  <th className="p-2">id</th>
                  <th className="p-2">Âª∫Áâ©</th>
                  <th className="p-2">ÈÉ®Â±ãÂêç</th>
                  <th className="p-2">order</th>
                  <th className="p-2">‰øùÂ≠ò</th>
                </tr>
              </thead>
              <tbody>
                {sorted.map(r => (
                  <tr key={r.id} className="border-t border-slate-100">
                    <td className="p-2">
                      <input type="checkbox" checked={r.active !== false} onChange={(e)=>updateLocal(r.id,{active:e.target.checked})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2 font-mono text-xs text-slate-600">{r.id}</td>
                    <td className="p-2">
                      <select className="rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={r.building||""} onChange={(e)=>updateLocal(r.id,{building:e.target.value})} disabled={!isLoggedIn||busy}>
                        <option value="Êú¨È§®">Êú¨È§®</option>
                        <option value="Âà•È§®">Âà•È§®</option>
                        <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                      </select>
                    </td>
                    <td className="p-2">
                      <input className="w-full rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={r.name||""} onChange={(e)=>updateLocal(r.id,{name:e.target.value})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <input type="number" className="w-24 rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={Number(r.order||0)} onChange={(e)=>updateLocal(r.id,{order:Number(e.target.value||0)})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <button className={classNames("px-3 py-2 rounded-2xl font-black border",
                        (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-slate-900 text-white border-slate-900")} onClick={()=>saveOne(r)} disabled={!isLoggedIn||busy}>
                        ‰øùÂ≠ò
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    /**********************
     * Equipment Manager
     **********************/
    function EquipmentManager({equipments, setEquipments, isLoggedIn, busy, onSaved, bumpReads, bumpWrites}){
      const [draft, setDraft] = useState({ id:"", name:"", abbr:"", countTotal: 0, order: 100, active:true });

      const sorted = useMemo(() =>
        (equipments||[]).slice().sort((a,b)=>(Number(a.order||0)-Number(b.order||0)) || String(a.name||"").localeCompare(String(b.name||"")))
      , [equipments]);

      function updateLocal(id, patch){
        setEquipments(prev => (prev||[]).map(e => e.id===id ? ({...e, ...patch}) : e));
      }

      async function saveOne(e){
        if(!isLoggedIn) return;
        if(!e.id) return alert("id„ÅåÂøÖË¶Å„Åß„Åô");
        const payload = {
          name: (e.name||"").trim(),
          abbr: (e.abbr||"").trim(),
          countTotal: Number(e.countTotal||0),
          order: Number(e.order||0),
          active: e.active !== false,
          updatedAt: serverTimestamp(),
        };
        await db.collection("equipments").doc(e.id).set(payload, { merge:true });
        bumpWrites(1);
        onSaved();
      }

      async function addNew(){
        if(!isLoggedIn) return;
        const id = (draft.id||"").trim();
        const name = (draft.name||"").trim();
        if(!id || !name) return alert("id „Å® Ê©üÊùêÂêç„ÅåÂøÖË¶Å„Åß„Åô");
        const ref = db.collection("equipments").doc(id);
        const snap = await ref.get();
        bumpReads(1);
        if(snap.exists){
          alert("Âêå„Åòid„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„ÅôÔºàÂà•„ÅÆid„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ");
          return;
        }
        await ref.set({
          name,
          abbr: (draft.abbr||"").trim(),
          countTotal: Number(draft.countTotal||0),
          order: Number(draft.order||0),
          active: draft.active !== false,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }, { merge:true });
        bumpWrites(1);
        setDraft({ id:"", name:"", abbr:"", countTotal: 0, order: Number(draft.order||100), active:true });
        onSaved();
      }

      return (
        <div className="space-y-4">
          <div className="rounded-3xl border border-slate-100 bg-slate-50 p-4">
            <div className="font-black text-slate-800">Ê©üÊùê„ÇíËøΩÂä†</div>
            <div className="mt-3 grid md:grid-cols-6 gap-2">
              <input className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="idÔºà‰æãÔºömicÔºâ" value={draft.id} onChange={(e)=>setDraft(d=>({...d, id:e.target.value}))} disabled={!isLoggedIn||busy} />
              <input className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="Ê©üÊùêÂêç" value={draft.name} onChange={(e)=>setDraft(d=>({...d, name:e.target.value}))} disabled={!isLoggedIn||busy} />
              <input className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="Áï•Áß∞Ôºà‰ªªÊÑèÔºâ" value={draft.abbr} onChange={(e)=>setDraft(d=>({...d, abbr:e.target.value}))} disabled={!isLoggedIn||busy} />
              <input type="number" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="Á∑èÊï∞" value={draft.countTotal} onChange={(e)=>setDraft(d=>({...d, countTotal:e.target.value}))} disabled={!isLoggedIn||busy} />
              <input type="number" className="rounded-2xl border border-slate-200 bg-white px-3 py-2 font-bold text-slate-700" placeholder="order" value={draft.order} onChange={(e)=>setDraft(d=>({...d, order:e.target.value}))} disabled={!isLoggedIn||busy} />
              <button className={classNames("rounded-2xl px-4 py-2 font-black border shadow-sm",
                (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-emerald-600 text-white border-emerald-600")} onClick={addNew} disabled={!isLoggedIn||busy}>
                ËøΩÂä†
              </button>
            </div>
            <div className="mt-2 text-xs font-bold text-slate-400">‚ÄªÁ∑èÊï∞„Åå0„ÅÆ„Å®„Åç„ÅØ„ÄåË∂ÖÈÅéË≠¶Âëä„Å™„Åó„Äç„Å®„Åó„Å¶Êâ±„ÅÑ„Åæ„ÅôÔºàÈÅãÁî®„Å´Âêà„Çè„Åõ„Å¶Ë®≠ÂÆöÔºâ</div>
          </div>

          <div className="rounded-3xl border border-slate-100 bg-white p-3 overflow-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left text-xs font-black text-slate-500">
                  <th className="p-2">Ë°®Á§∫</th>
                  <th className="p-2">id</th>
                  <th className="p-2">Ê©üÊùêÂêç</th>
                  <th className="p-2">Áï•Áß∞</th>
                  <th className="p-2">Á∑èÊï∞</th>
                  <th className="p-2">order</th>
                  <th className="p-2">‰øùÂ≠ò</th>
                </tr>
              </thead>
              <tbody>
                {sorted.map(e => (
                  <tr key={e.id} className="border-t border-slate-100">
                    <td className="p-2">
                      <input type="checkbox" checked={e.active !== false} onChange={(ev)=>updateLocal(e.id,{active:ev.target.checked})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2 font-mono text-xs text-slate-600">{e.id}</td>
                    <td className="p-2">
                      <input className="w-full rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={e.name||""} onChange={(ev)=>updateLocal(e.id,{name:ev.target.value})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <input className="w-20 rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={e.abbr||""} onChange={(ev)=>updateLocal(e.id,{abbr:ev.target.value})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <input type="number" className="w-24 rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={Number(e.countTotal||0)} onChange={(ev)=>updateLocal(e.id,{countTotal:Number(ev.target.value||0)})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <input type="number" className="w-24 rounded-xl border border-slate-200 bg-white px-2 py-1 font-bold text-slate-700" value={Number(e.order||0)} onChange={(ev)=>updateLocal(e.id,{order:Number(ev.target.value||0)})} disabled={!isLoggedIn||busy} />
                    </td>
                    <td className="p-2">
                      <button className={classNames("px-3 py-2 rounded-2xl font-black border",
                        (!isLoggedIn||busy) ? "bg-slate-100 text-slate-400 border-slate-200" : "bg-slate-900 text-white border-slate-900")} onClick={()=>saveOne(e)} disabled={!isLoggedIn||busy}>
                        ‰øùÂ≠ò
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    /**********************
     * Mount
     **********************/
    ReactDOM.createRoot(document.getElementById("app")).render(<App />);
  </script>
</body>
</html>
